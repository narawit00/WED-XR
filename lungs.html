<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>โมเดลปอดมนุษย์ 3D XR (Hyper-Real)</title>
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            background: radial-gradient(circle at 50% 50%, #1a1a2e 0%, #0c0c1a 100%);
            font-family: 'Sarabun', sans-serif;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }
        #loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: #ff8888; font-family: sans-serif; font-size: 14px; letter-spacing: 2px;
            background: rgba(20,0,0,0.8); padding: 15px 30px; border-radius: 30px;
            border: 1px solid #552222; pointer-events: none; z-index: 5000;
        }
        canvas { display: block; outline: none; touch-action: none; }
        
        #info {
            position: absolute;
            top: 20px;
            width: 100%;
            text-align: center;
            color: #fff;
            pointer-events: none;
            z-index: 10;
            text-shadow: 2px 2px 6px rgba(0,0,0,0.9);
            transition: opacity 0.5s;
        }
        h1 { margin: 0; font-weight: 700; color: #ff6b6b; font-size: 1.8rem;}
        p { margin: 5px; font-size: 1rem; color: #ddd; }
        
        #controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            transition: opacity 0.5s;
        }
        #controls button {
            display: block;
            width: 100%;
            margin: 5px 0;
            padding: 10px;
            background: #c91e3a;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            pointer-events: auto;
        }
        #controls button:hover {
            background: #ff4757;
            transform: scale(1.05);
        }

        #bottom-ui-container {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
            z-index: 1000;
            transition: opacity 0.3s;
        }

        #info-panel {
            background: rgba(0, 0, 0, 0.95);
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            width: 60%;
            max-width: 500px;
            text-align: center;
            color: white;
            border: 1px solid #d2691e;
            pointer-events: auto;
            margin: 0 15px;
            position: relative;
        }
        
        .nav-btn {
            background: rgba(0, 0, 0, 0.6);
            color: #d2691e;
            border: 2px solid #d2691e;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            pointer-events: auto;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
        }
        .nav-btn:hover {
            background: #d2691e;
            color: white;
            transform: scale(1.1);
        }
        .nav-btn:active { transform: scale(0.9); }

        #info-panel h2 { margin: 0 0 10px 0; color: #ff6b6b; font-size: 24px; font-weight: 600; }
        #info-panel p { margin: 8px 0; color: #eee; font-size: 16px; line-height: 1.6; }

        .scene-nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.3);
            font-size: 40px;
            padding: 15px 20px;
            cursor: pointer;
            z-index: 2000;
            border-radius: 12px;
            transition: all 0.3s ease;
            backdrop-filter: blur(4px);
        }
        .scene-nav-btn:hover {
            background: rgba(210, 105, 30, 0.8);
            color: white;
            border-color: transparent;
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 0 15px rgba(210, 105, 30, 0.6);
        }
        .prev-scene { left: 20px; }
        .next-scene { right: 20px; }

        #marker-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
        .marker-container { position: absolute; cursor: pointer; pointer-events: auto; transition: all 0.3s; z-index: 101; }
        .marker-container:hover { transform: scale(1.2); }
        .marker-number {
            width: 36px; height: 36px; border-radius: 50%;
            background: linear-gradient(135deg, #d2691e, #c91e3a);
            color: white; font-weight: bold; font-size: 18px;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid white;
            box-shadow: 0 0 12px rgba(210,105,30,0.7);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        #legend {
            position: absolute; top: 50%; left: 20px; transform: translateY(-50%);
            background: rgba(0,0,0,0.8); padding: 15px; border-radius: 10px;
            color: white; font-size: 12px; z-index: 1000;
            backdrop-filter: blur(10px); transition: opacity 0.5s;
        }
        #legend h3 { margin: 0 0 10px 0; color: #ff6b6b; font-size: 14px; }
        #legend div { margin: 5px 0; }
        #legend span { display: inline-block; width: 20px; height: 3px; margin-right: 5px; vertical-align: middle; }
        #ar-button { background: #2ed573 !important; position: absolute; top: 20px; left: 20px; z-index: 1001; display: none; }
        .hidden { opacity: 0 !important; pointer-events: none !important; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>

    <div id="loading">GENERATING 4K TISSUE TEXTURES...</div>

    <div id="info">
        <h1>โมเดลปอดมนุษย์ 3D XR</h1>
        <p>คลิกซ้าย-ขวาริมจอเพื่อเปลี่ยนโมเดล | ปุ่มล่างเพื่อดูข้อมูล</p>
    </div>
    
   <!-- จากปอด → ไปหัวใจ (ซ้าย), ไปสมอง (ขวา) หรือตามลำดับที่คุณต้องการ -->
   <button class="scene-nav-btn prev-scene" onclick="window.location.href='Hard.html'" title="ไปโมเดลหัวใจ">❮</button>
   <button class="scene-nav-btn next-scene" onclick="window.location.href='Barin.html'" title="ไปโมเดลสมอง">❯</button>

    <button id="ar-button" onclick="enterAR()">เข้าโหมด AR</button>

    <div id="controls">
        <button onclick="resetView()">รีเซ็ตมุมมอง</button>
        <button onclick="toggleRotation()">หยุด/เริ่มหมุนอัตโนมัติ</button>
        <button onclick="toggleLabels()">เปิด/ปิดลูกศรชี้</button>
    </div>

    <div id="legend">
        <h3>สีของตัวชี้</h3>
        <div><span style="background: #d2691e;"></span>เนื้อปอด (Lung Tissue)</div>
        <div><span style="background: #ffb366;"></span>หลอดลม (Airway)</div>
    </div>

    <div id="bottom-ui-container">
        <button class="nav-btn" onclick="navigateMarker(-1)">❮</button>
        <div id="info-panel">
            <h2>ปอดมนุษย์</h2>
            <p>คลิกที่ลูกศรซ้าย-ขวา หรือกดตัวเลขเพื่อดูข้อมูล</p>
            <p style="color: #888; font-size: 12px;">* มีจุดทั้งหมด 8 จุด</p>
        </div>
        <button class="nav-btn" onclick="navigateMarker(1)">❯</button>
    </div>

    <canvas id="marker-canvas"></canvas>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // Scene Setup
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x050505);
        scene.fog = new THREE.Fog(0x0a0a1a, 8, 30);
        
        const camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.set(0, 0, 16);
        
        const renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance", alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.15;
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.xr.enabled = true;
        document.body.appendChild(renderer.domElement);

        // Advanced Lighting
        const ambientLight = new THREE.AmbientLight(0x775555, 1.0);
        scene.add(ambientLight);

        const mainLight = new THREE.DirectionalLight(0xfff4d2, 4.0);
        mainLight.position.set(6, 12, 10);
        mainLight.castShadow = true;
        mainLight.shadow.mapSize.set(4096, 4096);
        mainLight.shadow.normalBias = 0.01;
        mainLight.shadow.bias = -0.0003;
        scene.add(mainLight);

        const fillLight = new THREE.DirectionalLight(0xffdddd, 2.0);
        fillLight.position.set(-7, 3, 7);
        scene.add(fillLight);

        const rimLight = new THREE.SpotLight(0xbbeeff, 7.0, 40, Math.PI / 6, 0.4, 2.0);
        rimLight.position.set(-12, 6, -6);
        rimLight.target.position.set(0, 0, 0);
        scene.add(rimLight);
        scene.add(rimLight.target);

        const bottomLight = new THREE.PointLight(0xff4444, 1.5, 45);
        bottomLight.position.set(0, -9, 5);
        scene.add(bottomLight);

        const backLight = new THREE.PointLight(0xff9999, 1.8, 60);
        backLight.position.set(0, 4, -12);
        scene.add(backLight);

        // Hyper-Realistic Texture Generation
        function createFleshTexture() {
            const size = 2048;
            const canvas = document.createElement('canvas');
            canvas.width = size; canvas.height = size;
            const ctx = canvas.getContext('2d');

            const grad = ctx.createRadialGradient(size/2, size/2, 0, size/2, size/2, size);
            grad.addColorStop(0, '#903030');
            grad.addColorStop(1, '#601010');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, size, size);

            for(let i=0; i<300000; i++) {
                ctx.fillStyle = Math.random() > 0.5 ? 'rgba(180, 80, 80, 0.05)' : 'rgba(50, 0, 0, 0.05)';
                ctx.fillRect(Math.random()*size, Math.random()*size, 3, 3);
            }

            for(let i=0; i<100; i++) {
                const x = Math.random()*size;
                const y = Math.random()*size;
                const r = Math.random()*100 + 50;
                ctx.beginPath();
                ctx.arc(x, y, r, 0, Math.PI*2);
                ctx.fillStyle = 'rgba(80, 0, 20, 0.1)';
                ctx.fill();
            }

            function drawVein(x, y, length, width, angle) {
                if(width < 0.5) return;
                ctx.beginPath();
                ctx.moveTo(x, y);
                const endX = x + Math.cos(angle) * length;
                const endY = y + Math.sin(angle) * length;

                const cp1x = x + Math.cos(angle+0.5) * length/2;
                const cp1y = y + Math.sin(angle+0.5) * length/2;
                ctx.quadraticCurveTo(cp1x, cp1y, endX, endY);

                ctx.strokeStyle = 'rgba(80, 20, 20, 0.4)';
                ctx.lineWidth = width;
                ctx.lineCap = 'round';
                ctx.stroke();

                if(Math.random() > 0.2) drawVein(endX, endY, length*0.7, width*0.7, angle + 0.5);
                if(Math.random() > 0.2) drawVein(endX, endY, length*0.7, width*0.7, angle - 0.5);
            }

            for(let i=0; i<30; i++) {
                drawVein(Math.random()*size, Math.random()*size, 150, 4, Math.random()*Math.PI*2);
            }

            const tex = new THREE.CanvasTexture(canvas);
            tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
            return tex;
        }

        const fleshTex = createFleshTexture();
        document.getElementById('loading').style.display = 'none';

        // Materials
        const solidMat = new THREE.MeshPhysicalMaterial({
            color: 0xcc4444,
            map: fleshTex,
            bumpMap: fleshTex,
            bumpScale: 0.05,
            roughness: 0.22,
            metalness: 0.0,
            clearcoat: 1.0,
            clearcoatRoughness: 0.15,
            sheen: 1.0,
            sheenColor: 0xffaaaa,
            transmission: 0.1,
            side: THREE.DoubleSide
        });

        const airwayMat = new THREE.MeshPhysicalMaterial({
            color: 0xe5e0d5,
            roughness: 0.4,
            clearcoat: 0.3,
            bumpMap: fleshTex,
            bumpScale: 0.01
        });

        // Geometry Generation
        function createKidneyLung(material) {
            const geometry = new THREE.SphereGeometry(2.8, 80, 80);
            const pos = geometry.attributes.position;
            const v = new THREE.Vector3();

            for(let i=0; i<pos.count; i++){
                v.fromBufferAttribute(pos, i);

                const bend = Math.cos(v.y * 0.5) * 0.8; 
                v.x -= bend; 
                v.y *= 1.4;
                v.z *= 0.7;
                if(v.y > 1.5) v.x *= 0.8;
                if(v.y < -2.0) v.y += 0.2;

                pos.setXYZ(i, v.x, v.y, v.z);
            }
            geometry.computeVertexNormals();
            
            const mesh = new THREE.Mesh(geometry, material);
            mesh.castShadow = true;
            mesh.receiveShadow = true;
            return mesh;
        }

        function createBronchiTree() {
            const group = new THREE.Group();
            
            function addBranch(start, angle, length, radius, depth) {
                if (depth > 4) return;
                const end = new THREE.Vector3(
                    start.x + Math.cos(angle) * length,
                    start.y + Math.sin(angle) * length,
                    start.z
                );
                const path = new THREE.LineCurve3(start, end);
                const geo = new THREE.TubeGeometry(path, 4, radius, 8, false);
                const mesh = new THREE.Mesh(geo, airwayMat);
                group.add(mesh);

                for(let i=0; i<2; i++) {
                    const newAngle = angle + (i===0 ? 0.5 : -0.5) + (Math.random()*0.2);
                    addBranch(end, newAngle, length*0.7, radius*0.7, depth+1);
                }
            }
            addBranch(new THREE.Vector3(0,0,0), -Math.PI/2 - 0.5, 1.2, 0.25, 0);
            return group;
        }

        // Scene Assembly
        const lungGroup = new THREE.Group();

        const tracheaGeo = new THREE.CylinderGeometry(0.5, 0.5, 3.5, 32, 20);
        const tPos = tracheaGeo.attributes.position;

        for(let i=0; i<tPos.count; i++){
            if(tPos.getY(i) % 0.3 > 0.15) { 
                const scale = 1.08;
                tPos.setX(i, tPos.getX(i) * scale);
                tPos.setZ(i, tPos.getZ(i) * scale);
            }
        }
        tracheaGeo.computeVertexNormals();

        const trachea = new THREE.Mesh(tracheaGeo, airwayMat);
        trachea.position.set(0, 3.5, 0);
        lungGroup.add(trachea);

        const rightLung = createKidneyLung(solidMat);
        rightLung.position.set(2.2, 0, 0);
        rightLung.rotation.z = 0.2;
        rightLung.scale.x = -1;
        lungGroup.add(rightLung);

        const leftLungShell = createKidneyLung(solidMat);
        leftLungShell.position.set(-2.2, 0, 0);
        leftLungShell.rotation.z = -0.2;
        lungGroup.add(leftLungShell);

        const bronchi = createBronchiTree();
        bronchi.position.set(-0.5, 1.5, 0);
        bronchi.rotation.z = -0.3;
        lungGroup.add(bronchi);

        const connector = new THREE.Mesh(new THREE.CylinderGeometry(0.5, 0.5, 1.5, 32), airwayMat);
        connector.position.set(-0.8, 2.2, 0);
        connector.rotation.z = 0.8;
        lungGroup.add(connector);

        const connector2 = connector.clone();
        connector2.position.set(0.8, 2.2, 0);
        connector2.rotation.z = -0.8;
        lungGroup.add(connector2);

        scene.add(lungGroup);
        lungGroup.position.y = -1.5;

        // UI State
        const markerCanvas = document.getElementById('marker-canvas');
        const markerCtx = markerCanvas.getContext('2d');
        markerCanvas.width = window.innerWidth;
        markerCanvas.height = window.innerHeight;

        const fixedLabelPositions = {
            1: { x: 50, y: 10 }, 2: { x: 20, y: 30 }, 3: { x: 15, y: 50 },
            4: { x: 80, y: 30 }, 5: { x: 85, y: 45 }, 6: { x: 85, y: 60 },
            7: { x: 35, y: 25 }, 8: { x: 65, y: 25 }
        };

        const markerData = [
            { id: 1, name: "Trachea", pos: { x: 0, y: 3.5, z: 0 }, color: "#ffb366", type: "airway", desc: "หลอดลม ทางเดินหายใจหลักจากคอลงมายังปอด มีกระดูกอ่อนเป็นวงๆ ป้องกันยุบตัว" },
            { id: 2, name: "Left Lung Upper", pos: { x: -2.2, y: 1.5, z: 0 }, color: "#d2691e", type: "lung", desc: "ปอดซ้ายส่วนบน (LUL) มี 2 กลีบ รับออกซิเจนจากคาร์บอนไดออกไซด์จากหัวใจ" },
            { id: 3, name: "Left Lung Lower", pos: { x: -2.2, y: -0.5, z: 0 }, color: "#d2691e", type: "lung", desc: "ปอดซ้ายส่วนล่าง (LLL) ใหญ่กว่าส่วนบน มี cardiac impression จากการสัมผัสหัวใจ" },
            { id: 4, name: "Right Lung Upper", pos: { x: 2.2, y: 1.8, z: 0 }, color: "#d2691e", type: "lung", desc: "ปอดขวาส่วนบน (RUL) มี 3 กลีบทั้งหมด" },
            { id: 5, name: "Right Lung Middle", pos: { x: 2.2, y: 0.5, z: 0 }, color: "#d2691e", type: "lung", desc: "ปอดขวาส่วนกลาง (RML) กลีบเล็กที่สุด ตั้งอยู่ระหว่างกลีบบนและล่าง" },
            { id: 6, name: "Right Lung Lower", pos: { x: 2.2, y: -0.8, z: 0 }, color: "#d2691e", type: "lung", desc: "ปอดขวาส่วนล่าง (RLL) ใหญ่ที่สุด มีพื้นผิวสัมผัสกับไดอะแฟรม" },
            { id: 7, name: "Left Bronchus", pos: { x: -1.5, y: 1.2, z: 0 }, color: "#ffb366", type: "airway", desc: "หลอดลมซ้าย แตกแขนงไปยังปอดซ้าย ยาวและแคบกว่าขวา มุมแหลมกว่า" },
            { id: 8, name: "Right Bronchus", pos: { x: 1.5, y: 1.2, z: 0 }, color: "#ffb366", type: "airway", desc: "หลอดลมขวา สั้นและกว้างกว่า มักมีสิ่งแปลกปลอมตกลงไปได้ง่าย" }
        ];

        let showLabels = true, activeMarker = null, currentMarkerIndex = -1;
        let isARMode = false, autoHideTimer = null, uiVisible = true, rotating = true;
        const markerElements = {};
        
        markerData.forEach((data, index) => {
            const container = document.createElement('div');
            container.className = 'marker-container';
            const number = document.createElement('div');
            number.className = 'marker-number';
            number.style.background = `linear-gradient(135deg, ${data.color}, #c91e3a)`;
            number.textContent = data.id;
            container.appendChild(number);
            container.style.display = 'none';
            document.body.appendChild(container);
            
            const fixedPos = fixedLabelPositions[data.id];
            container.style.left = `${fixedPos.x}%`;
            container.style.top = `${fixedPos.y}%`;
            container.style.transform = 'translate(-50%, -50%)';
            markerElements[data.id] = { container, data, index };
            container.addEventListener('click', () => selectMarkerByIndex(index));
        });

        function isMobile() {
            return window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        function adjustForMobile() {
            if (isMobile()) {
                lungGroup.scale.set(0.7, 0.7, 0.7);
                camera.position.set(0, 0, 20);
            }
        }

        function navigateMarker(direction) {
            let newIndex = currentMarkerIndex + direction;
            if (newIndex < 0) newIndex = markerData.length - 1;
            if (newIndex >= markerData.length) newIndex = 0;
            selectMarkerByIndex(newIndex);
        }
        window.navigateMarker = navigateMarker;

        function selectMarkerByIndex(index) {
            currentMarkerIndex = index;
            const data = markerData[index];
            clearTimeout(autoHideTimer);
            showInfo(data);
            showUI();
            autoHideUI();
        }

        function showInfo(data) {
            const panel = document.getElementById('info-panel');
            panel.innerHTML = `
                <h2>${data.id}. ${data.name}</h2>
                <p>${data.desc}</p>
                <p style="color: #999; font-size: 12px; margin-top: 10px;">ประเภท: ${getTypeLabel(data.type)}</p>
                <div style="font-size:12px; margin-top:5px; color:#d2691e;">(${currentMarkerIndex + 1} / ${markerData.length})</div>
            `;
            Object.values(markerElements).forEach(el => {
                el.container.style.filter = 'brightness(1)';
                el.container.style.transform = 'translate(-50%, -50%) scale(1)';
            });
            const el = markerElements[data.id];
            el.container.style.filter = 'brightness(1.5) drop-shadow(0 0 10px #fff)';
            el.container.style.transform = 'translate(-50%, -50%) scale(1.3)';
            activeMarker = data.id;
        }

        function getTypeLabel(type) {
            const labels = { lung: 'ปอด', airway: 'หลอดลม' };
            return labels[type] || 'อื่นๆ';
        }

        function updateMarkers() {
            markerCtx.clearRect(0, 0, markerCanvas.width, markerCanvas.height);
            if (!showLabels) {
                Object.values(markerElements).forEach(el => el.container.style.display = 'none');
                return;
            }
            markerData.forEach(data => {
                const vector = new THREE.Vector3(data.pos.x, data.pos.y, data.pos.z);
                vector.applyMatrix4(lungGroup.matrixWorld);
                vector.project(camera);
                if (vector.z > 1) {
                    markerElements[data.id].container.style.display = 'none';
                    return;
                }
                const [endX, endY] = [(vector.x * 0.5 + 0.5) * window.innerWidth, (-vector.y * 0.5 + 0.5) * window.innerHeight];
                const fixedPos = fixedLabelPositions[data.id];
                const [startX, startY] = [(fixedPos.x / 100) * window.innerWidth, (fixedPos.y / 100) * window.innerHeight];
                const distance = camera.position.distanceTo(vector.applyMatrix4(lungGroup.matrixWorld));

                markerCtx.strokeStyle = data.color;
                markerCtx.lineWidth = 3;
                markerCtx.globalAlpha = Math.max(0.3, 1 - distance / 15);
                markerCtx.beginPath(); markerCtx.moveTo(startX, startY); markerCtx.lineTo(endX, endY); markerCtx.stroke();
                markerCtx.fillStyle = data.color; markerCtx.beginPath(); markerCtx.arc(endX, endY, 5, 0, Math.PI * 2); markerCtx.fill();
                
                const markerEl = markerElements[data.id].container;
                markerEl.style.display = 'block';
                markerEl.style.opacity = Math.max(0.4, 1 - distance / 12);
            });
        }

        function autoHideUI() {
            clearTimeout(autoHideTimer);
            autoHideTimer = setTimeout(() => {
                if (!isARMode && !isMobile()) hideUI();
            }, 5000);
        }

        function hideUI() {
            uiVisible = false;
            document.getElementById('info').classList.add('hidden');
            document.getElementById('controls').classList.add('hidden');
            document.getElementById('legend').classList.add('hidden');
            document.getElementById('bottom-ui-container').classList.add('hidden');
            document.querySelectorAll('.scene-nav-btn').forEach(b => b.classList.add('hidden'));
        }

        function showUI() {
            uiVisible = true;
            document.getElementById('info').classList.remove('hidden');
            document.getElementById('controls').classList.remove('hidden');
            document.getElementById('legend').classList.remove('hidden');
            document.getElementById('bottom-ui-container').classList.remove('hidden');
            document.querySelectorAll('.scene-nav-btn').forEach(b => b.classList.remove('hidden'));
        }

        function resetAutoHide() {
            clearTimeout(autoHideTimer);
            if (!uiVisible) showUI();
            autoHideUI();
        }

        async function checkARSupport() { 
            if ('xr' in navigator) { 
                try { 
                    const s = await navigator.xr.isSessionSupported('immersive-ar'); 
                    if(s) document.getElementById('ar-button').style.display='block'; 
                } catch(e){} 
            } 
        }
        checkARSupport();

        async function enterAR() {
            if (!navigator.xr) return;
            const session = await navigator.xr.requestSession('immersive-ar', { requiredFeatures: ['hit-test'] });
            renderer.xr.setSession(session); 
            isARMode = true;
            rotating = false;
            lungGroup.scale.set(0.15, 0.15, 0.15); 
            lungGroup.position.set(0, 0, -1);
            document.getElementById('info').style.display='none'; 
            document.getElementById('legend').style.display='none';
            document.querySelectorAll('.scene-nav-btn').forEach(b => b.style.display='none');
            session.addEventListener('end', () => { 
                isARMode=false; 
                lungGroup.scale.set(1, 1, 1); 
                lungGroup.position.set(0, -1.5, 0);
                document.getElementById('info').style.display='block'; 
                document.getElementById('legend').style.display='block';
                document.querySelectorAll('.scene-nav-btn').forEach(b => b.style.display='block');
                adjustForMobile();
            });
        }

        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        
        const clock = new THREE.Clock();

        window.resetView = () => { 
            camera.position.set(0, 0, isMobile() ? 20 : 16);
            controls.reset(); 
            currentMarkerIndex = -1;
            document.getElementById('info-panel').innerHTML = `
                <h2>ปอดมนุษย์</h2>
                <p>คลิกที่ลูกศรซ้าย-ขวา เพื่อดูข้อมูล</p>
                <p style="color: #888; font-size: 12px;">* มีจุดทั้งหมด 8 จุด</p>
            `;
            Object.values(markerElements).forEach(el => el.container.style.filter='brightness(1)');
            adjustForMobile();
            resetAutoHide(); 
        };
        
        window.toggleRotation = () => { rotating = !rotating; resetAutoHide(); };
        window.toggleLabels = () => { showLabels = !showLabels; resetAutoHide(); };
        window.enterAR = enterAR;

        ['click', 'touchstart', 'touchmove', 'mousemove'].forEach(e => {
            document.addEventListener(e, resetAutoHide);
        });

        function animate() {
            requestAnimationFrame(animate);
            const time = clock.getElapsedTime();

            // Breathing animation
            const breath = 1 + Math.sin(time * 2) * 0.02;
            if (!isARMode) {
                lungGroup.scale.set(breath, breath * 1.01, breath);
                lungGroup.rotation.y = Math.sin(time * 0.1) * 0.05;
            }

            if(rotating && !isARMode) lungGroup.rotation.y += 0.003;
            
            controls.update();
            renderer.render(scene, camera);
            updateMarkers();
        }
        
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            markerCanvas.width = window.innerWidth;
            markerCanvas.height = window.innerHeight;
            adjustForMobile();
        });

        adjustForMobile();
        selectMarkerByIndex(0);
        animate();
    </script>
</body>
</html>
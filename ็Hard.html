<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>โมเดลหัวใจมนุษย์ 3D XR</title>
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            background: radial-gradient(circle at 50% 50%, #1a1a2e 0%, #0c0c1a 100%);
            font-family: 'Sarabun', sans-serif;
            user-select: none;
        }
        #info {
            position: absolute;
            top: 20px;
            width: 100%;
            text-align: center;
            color: #fff;
            pointer-events: none;
            z-index: 10;
            text-shadow: 2px 2px 6px rgba(0,0,0,0.9);
            transition: opacity 0.5s;
        }
        h1 { margin: 0; font-weight: 700; color: #ff6b6b; font-size: 1.8rem;}
        p { margin: 5px; font-size: 1rem; color: #ddd; }
        canvas { display: block; outline: none; }
        #controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            transition: opacity 0.5s;
        }
        #controls button {
            display: block;
            width: 100%;
            margin: 5px 0;
            padding: 10px;
            background: #c91e3a;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            pointer-events: auto;
        }
        #controls button:hover {
            background: #ff4757;
            transform: scale(1.05);
        }
        #info-panel {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.95);
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            max-width: 85%;
            text-align: center;
            z-index: 1000;
            transition: all 0.3s ease;
            color: white;
            border: 1px solid #ff6b6b;
            pointer-events: auto;
        }
        #info-panel h2 {
            margin: 0 0 10px 0;
            color: #ff6b6b;
            font-size: 24px;
            font-weight: 600;
        }
        #info-panel p {
            margin: 8px 0;
            color: #eee;
            font-size: 16px;
            line-height: 1.6;
        }
        #marker-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 100;
        }
        .marker-container {
            position: absolute;
            cursor: pointer;
            pointer-events: auto;
            transition: all 0.3s;
            z-index: 101;
        }
        .marker-container:hover {
            transform: scale(1.2);
        }
        .marker-number {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff6b6b, #c91e3a);
            color: white;
            font-weight: bold;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid white;
            box-shadow: 0 0 12px rgba(255,107,107,0.7);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        #legend {
            position: absolute;
            top: 50%;
            left: 20px;
            transform: translateY(-50%);
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 10px;
            color: white;
            font-size: 12px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            transition: opacity 0.5s;
        }
        #legend h3 {
            margin: 0 0 10px 0;
            color: #ff6b6b;
            font-size: 14px;
        }
        #legend div {
            margin: 5px 0;
        }
        #legend span {
            display: inline-block;
            width: 20px;
            height: 3px;
            margin-right: 5px;
            vertical-align: middle;
        }
        #ar-button {
            background: #2ed573 !important;
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1001;
            display: none;
        }
        #ar-button:hover {
            background: #7bed9f !important;
        }
        .hidden {
            opacity: 0 !important;
            pointer-events: none !important;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>

    <div id="info">
        <h1>โมเดลหัวใจมนุษย์ 3D XR</h1>
        <p>ลากเมาส์เพื่อหมุนดู | คลิกที่ตัวเลขเพื่อดูข้อมูล</p>
    </div>

    <button id="ar-button" onclick="enterAR()">เข้าโหมด AR</button>

    <div id="controls">
        <button onclick="resetView()">รีเซ็ตมุมมอง</button>
        <button onclick="toggleRotation()">หยุด/เริ่มหมุนอัตโนมัติ</button>
        <button onclick="toggleLabels()">เปิด/ปิดลูกศรชี้</button>
    </div>

    <div id="legend">
        <h3>สีของตัวชี้</h3>
        <div><span style="background: #ff6b6b;"></span>เส้นเลือดแดง</div>
        <div><span style="background: #4ecdc4;"></span>เส้นเลือดดำ</div>
        <div><span style="background: #ffe66d;"></span>ห้องหัวใจ</div>
        <div><span style="background: #a8e6cf;"></span>เส้นเลือดเลี้ยงหัวใจ</div>
    </div>

    <div id="info-panel">
        <h2>หัวใจมนุษย์</h2>
        <p>คลิกที่ตัวเลขเพื่อศึกษาส่วนต่างๆ อย่างละเอียด</p>
        <p style="color: #888; font-size: 12px;">* มีลูกศรชี้ทั้งหมด 12 จุด</p>
    </div>

    <canvas id="marker-canvas"></canvas>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <script>
        // Scene Setup
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0a0a1a);
        scene.fog = new THREE.Fog(0x0a0a1a, 8, 30);
        
        const camera = new THREE.PerspectiveCamera(35, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.set(0, 1.5, 12);
        
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.xr.enabled = true;
        document.body.appendChild(renderer.domElement);
        
        // Marker Canvas Setup
        const markerCanvas = document.getElementById('marker-canvas');
        const markerCtx = markerCanvas.getContext('2d');
        markerCanvas.width = window.innerWidth;
        markerCanvas.height = window.innerHeight;
        
        // Lighting System
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);
        
        const mainLight = new THREE.DirectionalLight(0xffffff, 1.5);
        mainLight.position.set(6, 10, 6);
        mainLight.castShadow = true;
        mainLight.shadow.mapSize.width = 2048;
        mainLight.shadow.mapSize.height = 2048;
        mainLight.shadow.camera.near = 0.1;
        mainLight.shadow.camera.far = 50;
        scene.add(mainLight);
        
        const fillLight = new THREE.PointLight(0xffffff, 0.8, 50);
        fillLight.position.set(0, 0, 10);
        scene.add(fillLight);
        
        // Heart Group
        const heartGroup = new THREE.Group();
        
        // Realistic Heart Material
        const heartMaterial = new THREE.MeshStandardMaterial({
            color: 0xcc2e3e,
            roughness: 0.8,
            metalness: 0.02,
        });
        
        // 1. Left Ventricle (ห้องล่างซ้าย) - หลัก
        const leftVentricleGeo = new THREE.SphereGeometry(1.6, 64, 64);
        const posLV = leftVentricleGeo.attributes.position;
        for (let i = 0; i < posLV.count; i++) {
            const y = posLV.getY(i);
            if (y > 0) {
                const factor = 1 - (y / 1.6) * 0.3;
                posLV.setX(i, posLV.getX(i) * factor);
                posLV.setZ(i, posLV.getZ(i) * factor);
            }
        }
        leftVentricleGeo.computeVertexNormals();
        const leftVentricle = new THREE.Mesh(leftVentricleGeo, heartMaterial);
        leftVentricle.scale.set(1, 1.3, 0.9);
        leftVentricle.position.set(-0.3, 0, 0);
        leftVentricle.castShadow = true;
        leftVentricle.receiveShadow = true;
        
        // 2. Right Ventricle (ห้องล่างขวา)
        const rightVentricleGeo = new THREE.SphereGeometry(1.3, 64, 64);
        const posRV = rightVentricleGeo.attributes.position;
        for (let i = 0; i < posRV.count; i++) {
            const y = posRV.getY(i);
            if (y > 0) {
                const factor = 1 - (y / 1.3) * 0.4;
                posRV.setX(i, posRV.getX(i) * factor);
                posRV.setZ(i, posRV.getZ(i) * factor);
            }
        }
        rightVentricleGeo.computeVertexNormals();
        const rightVentricle = new THREE.Mesh(rightVentricleGeo, heartMaterial);
        rightVentricle.scale.set(0.7, 1.1, 0.7);
        rightVentricle.position.set(0.7, -0.1, 0.2);
        
        // 3. Left Atrium (ห้องบนซ้าย)
        const leftAtrium = new THREE.Mesh(
            new THREE.SphereGeometry(0.8, 32, 32), 
            heartMaterial
        );
        leftAtrium.scale.set(0.8, 0.5, 0.8);
        leftAtrium.position.set(-0.4, 2.1, -0.4);
        
        // 4. Right Atrium (ห้องบนขวา)
        const rightAtrium = new THREE.Mesh(
            new THREE.SphereGeometry(0.75, 32, 32), 
            heartMaterial
        );
        rightAtrium.scale.set(0.8, 0.5, 0.8);
        rightAtrium.position.set(0.5, 2.1, -0.3);
        
        // 5. Right Atrial Appendage (หูหัวใจขวา)
        const appendageGeo = new THREE.SphereGeometry(0.35, 16, 16);
        appendageGeo.scale(1.4, 0.8, 0.6);
        const rightAppendage = new THREE.Mesh(appendageGeo, heartMaterial);
        rightAppendage.position.set(1.0, 1.9, 0.3);
        
        // Apex (ปลายหัวใจ)
        const apexGeo = new THREE.ConeGeometry(0.4, 0.8, 32);
        const apex = new THREE.Mesh(apexGeo, heartMaterial);
        apex.position.set(-0.2, -2.2, 0);
        apex.rotation.x = Math.PI;
        
        heartGroup.add(leftVentricle, rightVentricle, leftAtrium, rightAtrium, rightAppendage, apex);
        
        // Blood Vessels
        const arteryMaterial = new THREE.MeshStandardMaterial({ color: 0xcc2e3e, roughness: 0.6 });
        const veinMaterial = new THREE.MeshStandardMaterial({ color: 0x4a7cdd, roughness: 0.6 });
        
        // 6. Aorta with Arch
        const aortaCurve = new THREE.CatmullRomCurve3([
            new THREE.Vector3(0, 2.6, 0),
            new THREE.Vector3(0, 3.4, 0),
            new THREE.Vector3(0.4, 4.0, -0.4),
            new THREE.Vector3(1.0, 4.3, -1.0)
        ]);
        const aorta = new THREE.Mesh(
            new THREE.TubeGeometry(aortaCurve, 32, 0.32, 16, false),
            arteryMaterial
        );
        
        // 7. Pulmonary Artery
        const pulmonaryCurve = new THREE.CatmullRomCurve3([
            new THREE.Vector3(0.2, 2.4, -0.1),
            new THREE.Vector3(0.7, 3.0, -0.7),
            new THREE.Vector3(1.3, 3.2, -1.3)
        ]);
        const pulmonaryArtery = new THREE.Mesh(
            new THREE.TubeGeometry(pulmonaryCurve, 32, 0.28, 16, false),
            arteryMaterial
        );
        
        // 8. Superior Vena Cava
        const svcGeometry = new THREE.CylinderGeometry(0.2, 0.24, 2.2, 32);
        const svc = new THREE.Mesh(svcGeometry, veinMaterial);
        svc.position.set(-0.6, 2.8, 0.3);
        svc.rotation.z = -0.2;
        
        // 9. Inferior Vena Cava
        const ivcGeometry = new THREE.CylinderGeometry(0.24, 0.27, 2.0, 32);
        const ivc = new THREE.Mesh(ivcGeometry, veinMaterial);
        ivc.position.set(0, -1.9, 0);
        
        // 10. Pulmonary Veins (4 branches)
        const pulmonaryVeinMaterial = new THREE.MeshStandardMaterial({ color: 0x6688cc, roughness: 0.6 });
        const pvPositions = [
            { x: -0.8, z: -0.8 },
            { x: -0.7, z: -1.0 },
            { x: -1.0, z: -0.6 },
            { x: -1.1, z: -0.4 }
        ];
        
        pvPositions.forEach((pos, i) => {
            const pvCurve = new THREE.CatmullRomCurve3([
                new THREE.Vector3(0, 2.2, 0),
                new THREE.Vector3(pos.x * 0.5, 2.3, pos.z * 0.5),
                new THREE.Vector3(pos.x, 2.4, pos.z)
            ]);
            const pv = new THREE.Mesh(
                new THREE.TubeGeometry(pvCurve, 16, 0.12, 8, false),
                pulmonaryVeinMaterial
            );
            heartGroup.add(pv);
        });
        
        // 11. Coronary Arteries
        const coronaryMaterial = new THREE.MeshStandardMaterial({ color: 0xff2222, roughness: 0.8 });
        
        // Left Main Coronary
        const lmcCurve = new THREE.CatmullRomCurve3([
            new THREE.Vector3(0, 2.0, 0.4),
            new THREE.Vector3(-0.2, 1.8, 0.6),
            new THREE.Vector3(-0.4, 1.6, 0.8)
        ]);
        const leftMainCoronary = new THREE.Mesh(
            new THREE.TubeGeometry(lmcCurve, 16, 0.05, 8, false),
            coronaryMaterial
        );
        
        // LAD (Left Anterior Descending)
        const ladCurve = new THREE.CatmullRomCurve3([
            new THREE.Vector3(-0.4, 1.6, 0.8),
            new THREE.Vector3(-0.3, 1.0, 1.0),
            new THREE.Vector3(-0.2, 0, 1.0),
            new THREE.Vector3(-0.1, -1.0, 0.8)
        ]);
        const lad = new THREE.Mesh(
            new THREE.TubeGeometry(ladCurve, 32, 0.04, 8, false),
            coronaryMaterial
        );
        
        // RCA (Right Coronary Artery)
        const rcaCurve = new THREE.CatmullRomCurve3([
            new THREE.Vector3(0.2, 1.95, 0.4),
            new THREE.Vector3(0.8, 1.7, 0.8),
            new THREE.Vector3(1.2, 1.2, 0.6),
            new THREE.Vector3(1.0, 0, 0.4),
            new THREE.Vector3(0.8, -1.0, 0.2)
        ]);
        const rca = new THREE.Mesh(
            new THREE.TubeGeometry(rcaCurve, 32, 0.04, 8, false),
            coronaryMaterial
        );
        
        heartGroup.add(aorta, pulmonaryArtery, svc, ivc, leftMainCoronary, lad, rca);
        heartGroup.rotation.z = -0.3;
        scene.add(heartGroup);
        
        // **ตำแหน่งลูกศรคงที่บนหน้าจอ (เปอร์เซ็นต์%)**
        const fixedLabelPositions = {
            1: { x: 85, y: 15 },  // Arch of Aorta
            2: { x: 75, y: 25 },  // Pulmonary Trunk
            3: { x: 15, y: 20 },  // Superior Vena Cava
            4: { x: 50, y: 85 },  // Inferior Vena Cava
            5: { x: 60, y: 50 },  // Left Ventricle
            6: { x: 80, y: 55 },  // Right Ventricle
            7: { x: 30, y: 35 },  // Left Atrium
            8: { x: 70, y: 35 },  // Right Atrium
            9: { x: 20, y: 30 },  // Left Auricle
            10: { x: 85, y: 30 }, // Right Auricle
            11: { x: 25, y: 60 }, // LAD
            12: { x: 90, y: 45 }  // RCA
        };
        
        // Anatomical Marker Data (12 points) - ตำแหน่ง 3D ที่แม่นยำ
        const markerData = [
            { id: 1, name: "Arch of Aorta", pos: { x: 0.6, y: 4.2, z: -0.8 }, color: "#ff6b6b", type: "artery", desc: "โค้งของเอาตา แยกเป็นเส้นเลือดส่งเลือดไปแขน ลำคอ และสมอง" },
            { id: 2, name: "Pulmonary Trunk", pos: { x: 0.9, y: 2.8, z: -0.8 }, color: "#ff6b6b", type: "artery", desc: "ลำต้นหลอดเลือดแดงปอด ส่งเลือดขาดออกซิเจนไปยังปอดทั้งสองข้าง" },
            { id: 3, name: "Superior Vena Cava", pos: { x: -0.6, y: 3.5, z: 0.4 }, color: "#4ecdc4", type: "vein", desc: "หลอดเลือดดำใหญ่ส่วนบน รับเลือดจากศีรษะ ลำคอ และแขนทั้งสองกลับสู่หัวใจ" },
            { id: 4, name: "Inferior Vena Cava", pos: { x: 0, y: -1.9, z: 0 }, color: "#4ecdc4", type: "vein", desc: "หลอดเลือดดำใหญ่ส่วนล่าง รับเลือดจากลำตัวและขาทั้งสองกลับสู่หัวใจ" },
            { id: 5, name: "Left Ventricle", pos: { x: -0.5, y: 0, z: 0 }, color: "#ffe66d", type: "chamber", desc: "ห้องล่างซ้าย - ห้องสูบฉีดหลัก ผนังหนาที่สุด (10-15 มม.) ส่งเลือดออกซิเจนไปทั่วร่างกาย" },
            { id: 6, name: "Right Ventricle", pos: { x: 0.8, y: -0.2, z: 0.3 }, color: "#ffe66d", type: "chamber", desc: "ห้องล่างขวา - สูบฉีดเลือดขาดออกซิเจนไปยังปอดเพื่อรับออกซิเจน" },
            { id: 7, name: "Left Atrium", pos: { x: -0.4, y: 2.1, z: -0.4 }, color: "#ffe66d", type: "chamber", desc: "ห้องบนซ้าย - รับเลือดที่มีออกซิเจนจากปอดกลับเข้าสู่หัวใจ" },
            { id: 8, name: "Right Atrium", pos: { x: 0.6, y: 2.1, z: -0.3 }, color: "#ffe66d", type: "chamber", desc: "ห้องบนขวา - รับเลือดดำจากทั่วร่างกายก่อนส่งไปปอด" },
            { id: 9, name: "Left Auricle", pos: { x: -0.9, y: 2.3, z: 0.2 }, color: "#ffe66d", type: "chamber", desc: "หูหัวใจซ้าย - ส่วนขยายของห้องบนซ้าย ช่วยเพิ่มปริมาตร" },
            { id: 10, name: "Right Auricle", pos: { x: 1.1, y: 2.0, z: 0.3 }, color: "#ffe66d", type: "chamber", desc: "หูหัวใจขวา - ส่วนขยายของห้องบนขวา มีลักษณะหูรูด" },
            { id: 11, name: "LAD", pos: { x: -0.2, y: 0, z: 1.2 }, color: "#a8e6cf", type: "coronary", desc: "เส้นเลือดเลี้ยงหัวใจ LAD - เส้นสำคัญที่เลี้ยงกล้ามเนื้อหัวใจส่วนหน้าและกั้นกลาง" },
            { id: 12, name: "RCA", pos: { x: 1.0, y: 0, z: 0.5 }, color: "#a8e6cf", type: "coronary", desc: "เส้นเลือดเลี้ยงหัวใจ RCA - แยกเลี้ยงห้องล่างขวา ห้องบนขวา และระบบไฟฟ้าหัวใจ" }
        ];
        
        let showLabels = true;
        let activeMarker = null;
        let isARMode = false;
        let autoHideTimer = null;
        let uiVisible = true;
        
        // Create marker elements (ตัวเลขในวงกลม) ในตำแหน่งคงที่
        const markerElements = {};
        markerData.forEach(data => {
            const container = document.createElement('div');
            container.className = 'marker-container';
            
            const number = document.createElement('div');
            number.className = 'marker-number';
            number.style.background = `linear-gradient(135deg, ${data.color}, #c91e3a)`;
            number.textContent = data.id;
            
            container.appendChild(number);
            container.style.display = 'none';
            document.body.appendChild(container);
            
            // ตั้งตำแหน่งคงที่
            const fixedPos = fixedLabelPositions[data.id];
            container.style.left = `${fixedPos.x}%`;
            container.style.top = `${fixedPos.y}%`;
            container.style.transform = 'translate(-50%, -50%)';
            
            markerElements[data.id] = { container, data };
            container.addEventListener('click', () => {
                clearTimeout(autoHideTimer);
                showInfo(data);
                showUI();
                autoHideUI();
            });
        });
        
        function showInfo(data) {
            const panel = document.getElementById('info-panel');
            panel.innerHTML = `
                <h2>${data.id}. ${data.name}</h2>
                <p>${data.desc}</p>
                <p style="color: #999; font-size: 12px; margin-top: 10px;">ประเภท: ${getTypeLabel(data.type)} | คลิกตัวเลขอื่นเพื่อดูข้อมูลเพิ่มเติม</p>
            `;
            
            // รีเซ็ตการไฮไลท์
            Object.values(markerElements).forEach(el => {
                el.container.style.filter = 'brightness(1)';
            });
            
            // ไฮไลท์ตัวที่คลิก
            markerElements[data.id].container.style.filter = 'brightness(1.5) drop-shadow(0 0 10px #fff)';
            activeMarker = data.id;
        }
        
        function getTypeLabel(type) {
            const labels = {
                artery: 'เส้นเลือดแดง',
                vein: 'เส้นเลือดดำ', 
                chamber: 'ห้องหัวใจ',
                coronary: 'เส้นเลือดเลี้ยงหัวใจ'
            };
            return labels[type] || 'อื่นๆ';
        }
        
        // ฟังก์ชันวาดลูกศรจากตำแหน่งคงการถึงจุด 3D
        function updateMarkers() {
            markerCtx.clearRect(0, 0, markerCanvas.width, markerCanvas.height);
            
            if (!showLabels) {
                Object.values(markerElements).forEach(el => el.container.style.display = 'none');
                return;
            }
            
            markerData.forEach(data => {
                // คำนวณจุดปลายที่หัวใจ (3D to 2D)
                const vector = new THREE.Vector3(data.pos.x, data.pos.y, data.pos.z);
                vector.applyMatrix4(heartGroup.matrixWorld);
                vector.project(camera);
                
                // ตรวจสอบว่าอยู่หน้ากล้องไหม
                if (vector.z > 1) {
                    markerElements[data.id].container.style.display = 'none';
                    return;
                }
                
                const endX = (vector.x * 0.5 + 0.5) * window.innerWidth;
                const endY = (-vector.y * 0.5 + 0.5) * window.innerHeight;
                
                // จุดเริ่มต้นคือตำแหน่งคงที่ของตัวเลข
                const fixedPos = fixedLabelPositions[data.id];
                const startX = (fixedPos.x / 100) * window.innerWidth;
                const startY = (fixedPos.y / 100) * window.innerHeight;
                
                // คำนวณระยะห่างเพื่อปรับความชัดเจน
                const worldPos = new THREE.Vector3(data.pos.x, data.pos.y, data.pos.z);
                worldPos.applyMatrix4(heartGroup.matrixWorld);
                const distance = camera.position.distanceTo(worldPos);
                
                // วาดเส้นลูกศร
                markerCtx.strokeStyle = data.color;
                markerCtx.lineWidth = 3;
                markerCtx.globalAlpha = Math.max(0.3, 1 - distance / 15);
                markerCtx.beginPath();
                markerCtx.moveTo(startX, startY);
                markerCtx.lineTo(endX, endY);
                markerCtx.stroke();
                
                // วาดจุดปลายที่หัวใจ
                markerCtx.fillStyle = data.color;
                markerCtx.beginPath();
                markerCtx.arc(endX, endY, 5, 0, Math.PI * 2);
                markerCtx.fill();
                
                // แสดงตัวเลข
                const markerEl = markerElements[data.id].container;
                markerEl.style.display = 'block';
                markerEl.style.opacity = Math.max(0.4, 1 - distance / 12);
            });
        }
        
        // ฟังก์ชันซ่อน UI อัตโนมัติ
        function autoHideUI() {
            clearTimeout(autoHideTimer);
            autoHideTimer = setTimeout(() => {
                hideUI();
            }, 3000); // 3 วินาที
        }
        
        // ฟังก์ชันซ่อน UI
        function hideUI() {
            if (isARMode) return; // ไม่ซ่อนในโหมด AR
            
            uiVisible = false;
            const elements = ['info', 'controls', 'legend', 'info-panel'];
            elements.forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
        }
        
        // ฟังก์ชันแสดง UI
        function showUI() {
            uiVisible = true;
            const elements = ['info', 'controls', 'legend', 'info-panel'];
            elements.forEach(id => {
                document.getElementById(id).classList.remove('hidden');
            });
        }
        
        // รีเซ็ตเวลาซ่อนอัตโนมัติเมื่อมีการโต้ตอบ
        function resetAutoHide() {
            clearTimeout(autoHideTimer);
            if (!uiVisible) showUI();
            autoHideUI();
        }
        
        // เช็คการรองรับ AR
        async function checkARSupport() {
            if ('xr' in navigator) {
                try {
                    const supported = await navigator.xr.isSessionSupported('immersive-ar');
                    if (supported) {
                        document.getElementById('ar-button').style.display = 'block';
                    }
                } catch (e) {
                    console.log('AR not supported:', e);
                }
            }
        }
        checkARSupport();
        
        // เข้าโหมด AR
        async function enterAR() {
            if (!navigator.xr) return;
            
            try {
                const session = await navigator.xr.requestSession('immersive-ar', {
                    requiredFeatures: ['hit-test']
                });
                
                renderer.xr.setSession(session);
                isARMode = true;
                
                // ปิดการหมุนอัตโนมัติใน AR
                rotating = false;
                
                // ปรับขนาดโมเดลให้เหมาะกับ AR
                heartGroup.scale.set(0.15, 0.15, 0.15);
                heartGroup.position.set(0, 0, -1); // วางไว้ 1 เมตรข้างหน้า
                
                // ซ่อนป้าย UI บางส่วนใน AR
                document.getElementById('info').style.display = 'none';
                document.getElementById('legend').style.display = 'none';
                
                // เพิ่ม event listeners สำหรับ AR
                session.addEventListener('select', (event) => {
                    // คลิกใน AR ให้แสดง UI ชั่วคราว
                    showUI();
                    autoHideUI();
                });
                
                session.addEventListener('end', () => {
                    isARMode = false;
                    heartGroup.scale.set(1, 1, 1);
                    heartGroup.position.set(0, 0, 0);
                    document.getElementById('info').style.display = 'block';
                    document.getElementById('legend').style.display = 'block';
                });
                
            } catch (e) {
                alert('ไม่สามารถเข้าโหมด AR ได้: ' + e.message);
            }
        }
        
        // Controls
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.08;
        controls.minDistance = 5;
        controls.maxDistance = 30;
        controls.maxPolarAngle = Math.PI * 0.9;
        
        let time = 0;
        let rotating = true;
        
        // Event listeners สำหรับรีเซ็ตเวลาซ่อน
        ['click', 'touchstart', 'mousemove'].forEach(event => {
            document.addEventListener(event, resetAutoHide);
        });
        
        window.toggleRotation = function() {
            rotating = !rotating;
            resetAutoHide();
        };
        
        window.resetView = function() {
            camera.position.set(0, 1.5, 12);
            controls.reset();
            
            // รีเซ็ตการไฮไลท์
            Object.values(markerElements).forEach(el => {
                el.container.style.filter = 'brightness(1)';
            });
            activeMarker = null;
            
            // รีเซ็ต info panel
            document.getElementById('info-panel').innerHTML = `
                <h2>หัวใจมนุษย์</h2>
                <p>คลิกที่ตัวเลขเพื่อศึกษาส่วนต่างๆ อย่างละเอียด</p>
                <p style="color: #888; font-size: 12px;">* มีลูกศรชี้ทั้งหมด 12 จุด</p>
            `;
            
            resetAutoHide();
        };
        
        window.toggleLabels = function() {
            showLabels = !showLabels;
            resetAutoHide();
        };
        
        window.enterAR = enterAR;
        
        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            time += 0.01;
            
            // Heartbeat animation
            const beat = Math.sin(time * 3) * 0.5 + 0.5;
            const scale = isARMode ? 0.15 : (1.0 + (beat * 0.04));
            heartGroup.scale.set(scale, scale, scale);
            
            // Auto rotation
            if (rotating && !isARMode) {
                heartGroup.rotation.y += 0.004;
            }
            
            controls.update();
            renderer.render(scene, camera);
            updateMarkers();
        }
        
        // Resize handler
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            
            markerCanvas.width = window.innerWidth;
            markerCanvas.height = window.innerHeight;
        });
        
        // เริ่มต้น
        showInfo(markerData[0]);
        autoHideUI();
        animate();
    </script>
</body>
</html>
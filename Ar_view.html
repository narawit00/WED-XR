<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#080c14">
    <title>AR Anatomy Viewer</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500&family=Noto+Sans+Thai:wght@300;400;500&display=swap" rel="stylesheet">

    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>

    <style>
        /* ─── Variables ──────────────────────────────────────── */
        :root {
            --ink:         #0d1117;
            --ink-2:       #3a3f4a;
            --ink-3:       #7a808c;
            --surface:     #ffffff;
            --surface-2:   #f5f6f8;
            --border:      rgba(0,0,0,0.08);
            --border-2:    rgba(0,0,0,0.13);
            --accent:      #1847c9;
            --accent-soft: rgba(24, 71, 201, 0.10);
            --accent-ring: rgba(24, 71, 201, 0.28);
            --white-glass: rgba(255,255,255,0.11);
            --white-border: rgba(255,255,255,0.18);
            --ease-out:    cubic-bezier(0.22, 1, 0.36, 1);
            --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* ─── Reset ──────────────────────────────────────────── */
        *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        html, body { height:100%; overflow:hidden; background:#080c14; font-family:'DM Sans','Noto Sans Thai',sans-serif; color:var(--ink); -webkit-font-smoothing:antialiased; }
        button { font-family:inherit; cursor:pointer; border:none; background:none; }

        /* ─── Loading ─────────────────────────────────────────── */
        #loading {
            position:fixed; inset:0; background:var(--ink); z-index:9999;
            display:flex; flex-direction:column; align-items:center; justify-content:center; gap:28px;
            transition:opacity 0.7s var(--ease-out), visibility 0.7s;
        }
        #loading.out { opacity:0; visibility:hidden; pointer-events:none; }
        .load-wordmark {
            font-family:'Cormorant Garamond',serif; font-size:2.2rem; font-weight:300;
            color:#fff; letter-spacing:0.12em; text-transform:uppercase;
        }
        .load-wordmark em { font-style:italic; color:#788eed; }
        .load-bar { width:140px; height:1px; background:rgba(255,255,255,0.12); position:relative; overflow:hidden; }
        .load-bar::after {
            content:''; position:absolute; inset-block:0; left:-100%;
            width:100%; background:linear-gradient(90deg,transparent,#788eed,transparent);
            animation:barScan 1.5s ease-in-out forwards;
        }
        @keyframes barScan { to { left:100%; } }
        .load-hint { font-size:0.72rem; color:rgba(255,255,255,0.3); letter-spacing:0.15em; text-transform:uppercase; }

        /* ─── AR Container ───────────────────────────────────── */
        #ar-container { position:fixed; inset:0; z-index:1; }

        #camera-video {
            position:absolute; inset:0; width:100%; height:100%;
            object-fit:cover; z-index:1;
        }

        /* Explore-mode: gradient background when no camera */
        #ar-container.explore-bg {
            background: radial-gradient(ellipse 70% 60% at 50% 40%,#111827 0%,#080c14 100%);
        }

        model-viewer {
            position:absolute; inset:0; width:100%; height:100%; z-index:2;
            background:transparent; --poster-color:transparent;
        }

        /* ─── Mode Badge (top-left corner) ───────────────────── */
        #mode-badge {
            position:fixed; top:20px; left:50%; transform:translateX(-50%);
            display:flex; align-items:center; gap:0;
            background:var(--white-glass); backdrop-filter:blur(16px);
            border:1px solid var(--white-border); border-radius:40px;
            overflow:hidden; z-index:200;
            box-shadow:0 4px 20px rgba(0,0,0,0.3);
        }
        .mode-tab {
            padding:8px 22px; font-size:0.72rem; font-weight:500;
            color:rgba(255,255,255,0.5); letter-spacing:0.08em; text-transform:uppercase;
            transition:all 0.3s var(--ease-out); white-space:nowrap;
        }
        .mode-tab.active {
            color:#fff; background:rgba(255,255,255,0.15);
        }
        .mode-divider { width:1px; height:18px; background:var(--white-border); flex-shrink:0; }

        /* ─── Top Corners ─────────────────────────────────────── */
        .corner-btn {
            position:fixed; z-index:200; top:18px;
            width:42px; height:42px;
            background:var(--white-glass); backdrop-filter:blur(14px);
            border:1px solid var(--white-border); border-radius:10px;
            display:flex; align-items:center; justify-content:center;
            transition:all 0.25s var(--ease-out); color:#fff;
        }
        .corner-btn:hover { background:rgba(255,255,255,0.2); }
        .corner-btn:active { transform:scale(0.93); }
        .corner-btn svg { width:17px; height:17px; stroke:currentColor; fill:none; stroke-width:2; stroke-linecap:round; stroke-linejoin:round; }
        #btn-menu     { left:18px; }
        #btn-settings { right:18px; }

        /* ─── AR Controls Bar (only visible in AR mode) ───────── */
        #ar-controls {
            position:fixed; bottom:200px; right:16px;
            display:flex; flex-direction:column; gap:8px;
            z-index:150; opacity:0; pointer-events:none;
            transform:translateX(20px);
            transition:all 0.35s var(--ease-out);
        }
        #ar-controls.visible { opacity:1; pointer-events:auto; transform:translateX(0); }
        .ar-ctrl-btn {
            width:44px; height:44px;
            background:var(--white-glass); backdrop-filter:blur(14px);
            border:1px solid var(--white-border); border-radius:10px;
            display:flex; align-items:center; justify-content:center;
            color:#fff; font-size:1rem; transition:all 0.2s;
        }
        .ar-ctrl-btn:hover  { background:rgba(255,255,255,0.22); }
        .ar-ctrl-btn:active { transform:scale(0.9); }
        .ar-ctrl-btn svg { width:16px; height:16px; stroke:currentColor; fill:none; stroke-width:2.2; stroke-linecap:round; stroke-linejoin:round; }
        #btn-freeze.frozen { background:rgba(24,71,201,0.4); border-color:rgba(24,71,201,0.6); }

        /* ─── Annotation Dots ─────────────────────────────────── */
        #ann-layer { position:fixed; inset:0; z-index:120; pointer-events:none; }
        .ann-dot {
            position:absolute; transform:translate(-50%,-50%);
            pointer-events:auto; cursor:pointer;
        }
        .ann-dot-core {
            width:10px; height:10px;
            background:var(--accent); border:2.5px solid #fff;
            border-radius:50%; position:relative; z-index:2;
            box-shadow:0 2px 8px rgba(24,71,201,0.45);
            transition:transform 0.25s var(--ease-spring);
        }
        .ann-dot::before {
            content:''; position:absolute;
            inset:-8px; border-radius:50%;
            background:rgba(24,71,201,0.14);
            animation:annPulse 2.6s ease-in-out infinite;
        }
        @keyframes annPulse {
            0%,100% { transform:scale(1); opacity:.7; }
            50%      { transform:scale(2); opacity:0; }
        }
        .ann-dot:hover .ann-dot-core { transform:scale(1.5); }
        .ann-dot.selected .ann-dot-core { background:#fff; border-color:var(--accent); box-shadow:0 0 0 3px var(--accent-ring); }

        /* ─── Info Card ───────────────────────────────────────── */
        #info-card {
            position:fixed; bottom:0; left:0; right:0;
            background:var(--surface); z-index:150;
            border-top:1px solid var(--border-2);
            border-radius:22px 22px 0 0;
            padding:0 24px 34px;
            box-shadow:0 -10px 40px rgba(0,0,0,0.18);
            transition:transform 0.45s var(--ease-spring);
            will-change:transform;
        }
        #info-card.collapsed { transform:translateY(calc(100% - 72px)); }

        /* drag handle */
        .card-handle {
            width:36px; height:4px; border-radius:2px;
            background:var(--border-2); margin:12px auto 16px;
            cursor:pointer;
        }

        .card-top {
            display:flex; align-items:flex-start; justify-content:space-between;
            margin-bottom:10px;
        }
        .card-organ-label {
            font-size:0.68rem; font-weight:500; letter-spacing:0.1em;
            text-transform:uppercase; color:var(--accent); margin-bottom:5px;
        }
        .card-name {
            font-family:'Cormorant Garamond',serif;
            font-size:1.65rem; font-weight:400; line-height:1.1;
            color:var(--ink); letter-spacing:-0.01em;
        }
        .card-name-th {
            font-size:0.85rem; color:var(--ink-3); font-weight:300; margin-top:2px;
        }
        .card-weight-pill {
            font-size:0.72rem; font-weight:500; color:var(--accent);
            background:var(--accent-soft); padding:5px 11px; border-radius:20px;
            flex-shrink:0; margin-left:12px; margin-top:4px; letter-spacing:0.02em;
        }
        .card-divider { height:1px; background:var(--border); margin:14px 0; }
        .card-desc {
            font-size:0.875rem; color:var(--ink-2); line-height:1.7; font-weight:300;
        }

        /* Annotation detail block (shown on dot click) */
        #ann-detail {
            margin-top:14px; padding:14px 16px;
            background:var(--surface-2); border-radius:12px;
            border-left:3px solid var(--accent);
            display:none;
        }
        #ann-detail.show { display:block; }
        .ann-detail-title {
            font-family:'Cormorant Garamond',serif; font-size:1.05rem; font-weight:500;
            color:var(--ink); margin-bottom:3px;
        }
        .ann-detail-sub {
            font-size:0.72rem; color:var(--accent); font-weight:500;
            letter-spacing:0.04em; text-transform:uppercase; margin-bottom:6px;
        }
        .ann-detail-desc { font-size:0.82rem; color:var(--ink-2); line-height:1.6; font-weight:300; }

        /* ─── Sidebar ─────────────────────────────────────────── */
        #sidebar {
            position:fixed; top:0; left:0; height:100%; width:275px;
            background:var(--surface); z-index:500;
            transform:translateX(-100%);
            transition:transform 0.35s var(--ease-out);
            box-shadow:8px 0 32px rgba(0,0,0,0.18);
            display:flex; flex-direction:column; overflow:hidden;
        }
        #sidebar.open { transform:translateX(0); }

        /* ─── Settings Panel ──────────────────────────────────── */
        #settings-panel {
            position:fixed; top:0; right:0; height:100%; width:290px;
            background:var(--surface); z-index:500;
            transform:translateX(100%);
            transition:transform 0.35s var(--ease-out);
            box-shadow:-8px 0 32px rgba(0,0,0,0.18);
            display:flex; flex-direction:column; overflow:hidden;
        }
        #settings-panel.open { transform:translateX(0); }

        /* shared panel parts */
        .panel-head {
            padding:22px 20px 18px; border-bottom:1px solid var(--border);
            display:flex; align-items:center; justify-content:space-between; flex-shrink:0;
        }
        .panel-title {
            font-family:'Cormorant Garamond',serif; font-size:1.25rem;
            font-weight:400; color:var(--ink); letter-spacing:-0.01em;
        }
        .panel-close {
            width:30px; height:30px; border:1px solid var(--border-2);
            border-radius:8px; background:var(--surface-2);
            display:flex; align-items:center; justify-content:center;
            color:var(--ink-3); transition:all 0.2s;
        }
        .panel-close:hover { color:var(--ink); background:var(--border); }
        .panel-close svg { width:13px; height:13px; stroke:currentColor; fill:none; stroke-width:2.5; stroke-linecap:round; }

        /* organ list */
        .organ-list { list-style:none; padding:12px 10px; flex:1; overflow-y:auto; }
        .organ-item {
            display:flex; align-items:center; gap:13px;
            padding:13px 14px; border-radius:11px; cursor:pointer;
            border:1px solid transparent; margin-bottom:3px;
            transition:all 0.2s;
        }
        .organ-item:hover { background:var(--surface-2); border-color:var(--border); }
        .organ-item.active { background:var(--accent-soft); border-color:rgba(24,71,201,0.18); }
        .organ-item.active .oi-name { color:var(--accent); }
        .organ-item.active .oi-en   { color:rgba(24,71,201,0.6); }
        .organ-item.active .oi-icon { background:var(--accent-soft); border-color:rgba(24,71,201,0.2); }
        .organ-item.active .oi-icon svg { stroke:var(--accent); }
        .oi-icon {
            width:34px; height:34px; border-radius:9px; flex-shrink:0;
            background:var(--surface-2); border:1px solid var(--border);
            display:flex; align-items:center; justify-content:center; transition:all 0.2s;
        }
        .oi-icon svg { width:17px; height:17px; stroke:var(--ink-3); fill:none; stroke-width:1.6; stroke-linecap:round; stroke-linejoin:round; }
        .oi-name { font-size:0.95rem; color:var(--ink); line-height:1; }
        .oi-en   { font-size:0.73rem; color:var(--ink-3); font-weight:300; margin-top:2px; letter-spacing:0.02em; }
        .panel-foot { padding:14px 10px 24px; border-top:1px solid var(--border); flex-shrink:0; }
        .panel-home {
            width:100%; padding:12px; border:1px solid var(--border-2);
            border-radius:10px; background:var(--surface-2);
            font-size:0.875rem; color:var(--ink-2); font-weight:400;
            transition:all 0.2s; letter-spacing:0.01em;
        }
        .panel-home:hover { background:var(--surface); color:var(--ink); border-color:var(--accent); }

        /* settings content */
        .settings-body { flex:1; overflow-y:auto; }
        .s-section { padding:20px; border-bottom:1px solid var(--border); }
        .s-label { font-size:0.68rem; font-weight:500; letter-spacing:0.1em; text-transform:uppercase; color:var(--ink-3); margin-bottom:15px; }
        .s-row { display:flex; align-items:center; justify-content:space-between; margin-bottom:14px; }
        .s-row:last-child { margin-bottom:0; }
        .s-row-label { font-size:0.875rem; color:var(--ink); }

        /* toggle */
        .tog { position:relative; width:42px; height:23px; flex-shrink:0; }
        .tog input { opacity:0; width:0; height:0; position:absolute; }
        .tog-track { position:absolute; inset:0; background:#d1d5db; border-radius:12px; transition:background 0.3s; }
        .tog input:checked + .tog-track { background:var(--accent); }
        .tog-thumb { position:absolute; top:2.5px; left:2.5px; width:18px; height:18px; background:#fff; border-radius:50%; transition:transform 0.3s var(--ease-spring); box-shadow:0 1px 4px rgba(0,0,0,0.2); }
        .tog input:checked ~ .tog-thumb { transform:translateX(19px); }

        /* range */
        .s-slider-wrap { display:flex; flex-direction:column; gap:8px; }
        .s-slider-head { display:flex; justify-content:space-between; }
        .s-slider-val { font-size:0.8rem; color:var(--accent); font-weight:500; font-variant-numeric:tabular-nums; }
        .s-range {
            -webkit-appearance:none; appearance:none;
            width:100%; height:3px; background:var(--border-2); border-radius:2px; outline:none;
        }
        .s-range::-webkit-slider-thumb {
            -webkit-appearance:none; width:15px; height:15px;
            background:var(--accent); border:2px solid #fff; border-radius:50%;
            cursor:pointer; box-shadow:0 1px 5px rgba(24,71,201,0.35);
        }

        /* music opts */
        .music-opts { display:flex; gap:7px; margin-top:3px; }
        .m-opt {
            flex:1; padding:8px 5px; border:1px solid var(--border-2);
            border-radius:8px; background:var(--surface-2);
            font-size:0.73rem; font-weight:500; color:var(--ink-3);
            text-align:center; transition:all 0.2s; letter-spacing:0.02em;
        }
        .m-opt:hover  { border-color:var(--accent); color:var(--accent); }
        .m-opt.active { background:var(--accent-soft); border-color:var(--accent); color:var(--accent); }

        .reset-btn {
            width:100%; padding:10px; border:1px solid var(--border-2);
            border-radius:10px; background:var(--surface-2);
            font-size:0.875rem; color:var(--ink-2); transition:all 0.2s;
        }
        .reset-btn:hover { border-color:var(--accent); color:var(--accent); background:var(--accent-soft); }

        /* ─── Backdrop ────────────────────────────────────────── */
        #backdrop {
            position:fixed; inset:0; background:rgba(0,0,0,0.42); z-index:400;
            opacity:0; visibility:hidden; transition:all 0.3s;
        }
        #backdrop.on { opacity:1; visibility:visible; }

        /* ─── Scroll lock ─────────────────────────────────────── */
        .no-scroll { overflow:hidden; }
    </style>
</head>
<body>

<!-- ── Loading ─────────────────────────────────────────────── -->
<div id="loading">
    <div class="load-wordmark">AR <em>Anatomy</em></div>
    <div class="load-bar"></div>
    <div class="load-hint">Initializing</div>
</div>

<!-- ── AR / Camera Layer ────────────────────────────────────── -->
<div id="ar-container">
    <video id="camera-video" autoplay playsinline muted></video>
    <model-viewer
        id="viewer"
        camera-controls
        touch-action="pan-y"
        ar
        ar-modes="webxr scene-viewer quick-look"
        ar-scale="fixed"
        shadow-intensity="1"
        exposure="1.1"
        camera-orbit="0deg 78deg 105%"
        min-camera-orbit="auto auto 5%"
        max-camera-orbit="auto auto 500%"
        interpolation-decay="200"
        environment-image="neutral">
    </model-viewer>
</div>

<!-- ── Annotation layer ──────────────────────────────────────── -->
<div id="ann-layer"></div>

<!-- ── Mode toggle ──────────────────────────────────────────── -->
<div id="mode-badge">
    <button class="mode-tab active" data-mode="explore">Explore</button>
    <div class="mode-divider"></div>
    <button class="mode-tab" data-mode="ar">AR Live</button>
</div>

<!-- ── Top corner buttons ───────────────────────────────────── -->
<button class="corner-btn" id="btn-menu" aria-label="Menu">
    <svg viewBox="0 0 24 24"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
</button>
<button class="corner-btn" id="btn-settings" aria-label="Settings">
    <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
</button>

<!-- ── AR Controls (only in AR mode) ────────────────────────── -->
<div id="ar-controls">
    <!-- Zoom in -->
    <button class="ar-ctrl-btn" id="btn-zoom-in" title="Zoom In">
        <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></svg>
    </button>
    <!-- Zoom out -->
    <button class="ar-ctrl-btn" id="btn-zoom-out" title="Zoom Out">
        <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/></svg>
    </button>
    <!-- Freeze / unfreeze rotation -->
    <button class="ar-ctrl-btn" id="btn-freeze" title="Freeze Rotation">
        <svg viewBox="0 0 24 24"><line x1="12" y1="2" x2="12" y2="22"/><path d="M17 7l-5-5-5 5"/><path d="M17 17l-5 5-5-5"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M7 7l-5 5 5 5"/><path d="M17 7l5 5-5 5"/></svg>
    </button>
    <!-- Reset camera -->
    <button class="ar-ctrl-btn" id="btn-reset-ar" title="Reset View">
        <svg viewBox="0 0 24 24"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
    </button>
</div>

<!-- ── Info Card ─────────────────────────────────────────────── -->
<div id="info-card" class="collapsed">
    <div class="card-handle" id="card-handle"></div>
    <div class="card-top">
        <div>
            <div class="card-organ-label" id="card-label">Anatomy</div>
            <div class="card-name"    id="card-name-en">—</div>
            <div class="card-name-th" id="card-name-th">—</div>
        </div>
        <div class="card-weight-pill" id="card-weight">—</div>
    </div>
    <div class="card-divider"></div>
    <p class="card-desc" id="card-desc">—</p>
    <div id="ann-detail">
        <div class="ann-detail-title" id="ann-d-title"></div>
        <div class="ann-detail-sub"   id="ann-d-sub"></div>
        <div class="ann-detail-desc"  id="ann-d-desc"></div>
    </div>
</div>

<!-- ── Sidebar ───────────────────────────────────────────────── -->
<nav id="sidebar">
    <div class="panel-head">
        <span class="panel-title">อวัยวะ</span>
        <button class="panel-close" id="close-sidebar">
            <svg viewBox="0 0 13 13"><line x1="1" y1="1" x2="12" y2="12"/><line x1="12" y1="1" x2="1" y2="12"/></svg>
        </button>
    </div>
    <ul class="organ-list">
        <li class="organ-item" data-organ="brain">
            <div class="oi-icon"><svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 2.74 1.49 5.14 3.7 6.44C9.39 17.73 10 19.8 10 22h4c0-2.2.61-4.27 1.3-6.56C17.51 14.14 19 11.74 19 9c0-3.87-3.13-7-7-7z"/><line x1="10" y1="15" x2="14" y2="15"/></svg></div>
            <div><div class="oi-name">สมอง</div><div class="oi-en">Brain</div></div>
        </li>
        <li class="organ-item" data-organ="heart">
            <div class="oi-icon"><svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg></div>
            <div><div class="oi-name">หัวใจ</div><div class="oi-en">Heart</div></div>
        </li>
        <li class="organ-item" data-organ="lungs">
            <div class="oi-icon"><svg viewBox="0 0 24 24"><path d="M12 3v10M9 8c-1.5 1.5-4 3-4 7a4 4 0 0 0 8 0M15 8c1.5 1.5 4 3 4 7a4 4 0 0 1-8 0"/></svg></div>
            <div><div class="oi-name">ปอด</div><div class="oi-en">Lungs</div></div>
        </li>
        <li class="organ-item" data-organ="liver">
            <div class="oi-icon"><svg viewBox="0 0 24 24"><path d="M4 12c0-4.4 3.6-8 8-8s8 3.6 8 8c0 2.5-1.1 4.7-2.9 6.2C15.4 19.3 13.8 20 12 20H8c-2.2 0-4-1.8-4-4v-4z"/></svg></div>
            <div><div class="oi-name">ตับ</div><div class="oi-en">Liver</div></div>
        </li>
    </ul>
    <div class="panel-foot">
        <button class="panel-home" id="btn-home">กลับหน้าหลัก</button>
    </div>
</nav>

<!-- ── Settings Panel ────────────────────────────────────────── -->
<aside id="settings-panel">
    <div class="panel-head">
        <span class="panel-title">ตั้งค่า</span>
        <button class="panel-close" id="close-settings">
            <svg viewBox="0 0 13 13"><line x1="1" y1="1" x2="12" y2="12"/><line x1="12" y1="1" x2="1" y2="12"/></svg>
        </button>
    </div>
    <div class="settings-body">
        <div class="s-section">
            <div class="s-label">การแสดงผล</div>
            <div class="s-row">
                <span class="s-row-label">หมุนอัตโนมัติ</span>
                <label class="tog"><input type="checkbox" id="tog-rotate"><div class="tog-track"></div><div class="tog-thumb"></div></label>
            </div>
            <div class="s-row">
                <span class="s-row-label">แสดงเงา</span>
                <label class="tog"><input type="checkbox" id="tog-shadow" checked><div class="tog-track"></div><div class="tog-thumb"></div></label>
            </div>
            <div class="s-row">
                <span class="s-row-label">จุดอธิบายส่วนประกอบ</span>
                <label class="tog"><input type="checkbox" id="tog-ann" checked><div class="tog-track"></div><div class="tog-thumb"></div></label>
            </div>
        </div>
        <div class="s-section">
            <div class="s-label">เสียง</div>
            <div class="s-row">
                <span class="s-row-label">เพลงพื้นหลัง</span>
                <label class="tog"><input type="checkbox" id="tog-music"><div class="tog-track"></div><div class="tog-thumb"></div></label>
            </div>
            <div class="s-slider-wrap" style="margin-bottom:14px">
                <div class="s-slider-head">
                    <span class="s-row-label">ระดับเสียง</span>
                    <span class="s-slider-val" id="vol-label">50%</span>
                </div>
                <input type="range" class="s-range" id="vol-slider" min="0" max="100" value="50">
            </div>
            <div class="music-opts">
                <button class="m-opt active" data-track="ambient">Ambient</button>
                <button class="m-opt" data-track="focus">Focus</button>
                <button class="m-opt" data-track="nature">Nature</button>
            </div>
        </div>
        <div class="s-section">
            <div class="s-label">กล้อง</div>
            <button class="reset-btn" id="btn-reset-cam">รีเซ็ตมุมมอง</button>
        </div>
    </div>
</aside>

<!-- ── Backdrop ──────────────────────────────────────────────── -->
<div id="backdrop"></div>

<audio id="bg-audio" loop></audio>

<!-- ── Script ───────────────────────────────────────────────── -->
<script>
'use strict';

/* ═══════════════════════════════════════════════════════════
   ORGAN DATA — each organ isolated, easy to extend
═══════════════════════════════════════════════════════════ */
const ORGANS = {
    brain: {
        modelPath: 'brain/scene.gltf',
        nameEN: 'Brain', nameTH: 'สมอง', weight: '1.4 kg',
        desc: 'ศูนย์กลางระบบประสาท ควบคุมความคิด ความจำ และการรับรู้ทั้งหมดของร่างกาย',
        annotations: [
            { x:38, y:28, title:'Cerebrum',    sub:'สมองใหญ่',    desc:'ควบคุมความคิด การเรียนรู้ ความจำ และการรับรู้ความรู้สึก' },
            { x:28, y:40, title:'Frontal Lobe',sub:'กลีบหน้าผาก', desc:'การตัดสินใจ บุคลิกภาพ และการแก้ปัญหา' },
            { x:55, y:55, title:'Cerebellum',  sub:'สมองน้อย',    desc:'ควบคุมการทรงตัวและการประสานงานกล้ามเนื้อ' },
            { x:48, y:72, title:'Brain Stem',  sub:'ก้านสมอง',    desc:'ควบคุมการหายใจ อัตราการเต้นหัวใจ และการตื่นตัว' }
        ]
    },
    heart: {
        modelPath: 'human_heart/scene.gltf',
        nameEN: 'Heart', nameTH: 'หัวใจ', weight: '300 g',
        desc: 'ปั๊มเลือดไปเลี้ยงทุกเซลล์ในร่างกาย เต้นกว่า 100,000 ครั้งต่อวันโดยไม่หยุดพัก',
        annotations: [
            { x:36, y:33, title:'Left Atrium',    sub:'ห้องบนซ้าย',  desc:'รับเลือดที่มีออกซิเจนจากปอด' },
            { x:57, y:33, title:'Right Atrium',   sub:'ห้องบนขวา',  desc:'รับเลือดดำจากทั่วร่างกาย' },
            { x:34, y:62, title:'Left Ventricle', sub:'ห้องล่างซ้าย',desc:'ส่งเลือดออกไปเลี้ยงร่างกาย กล้ามเนื้อหนาที่สุด' },
            { x:58, y:62, title:'Right Ventricle',sub:'ห้องล่างขวา',desc:'ส่งเลือดไปฟอกที่ปอด' },
            { x:46, y:17, title:'Aorta',          sub:'เส้นเลือดใหญ่',desc:'หลอดเลือดแดงหลักที่ส่งเลือดออกจากหัวใจ' }
        ]
    },
    lungs: {
        modelPath: 'human_lungs/scene.gltf',
        nameEN: 'Lungs', nameTH: 'ปอด', weight: '1.0 kg',
        desc: 'แลกเปลี่ยนออกซิเจนและคาร์บอนไดออกไซด์ มีพื้นที่ผิวรวมกว่า 70 ตารางเมตร',
        annotations: [
            { x:34, y:45, title:'Left Lung',  sub:'ปอดซ้าย', desc:'มี 2 กลีบ เว้าพื้นที่ให้หัวใจ' },
            { x:60, y:45, title:'Right Lung', sub:'ปอดขวา', desc:'มี 3 กลีบ ใหญ่กว่าปอดซ้ายเล็กน้อย' },
            { x:47, y:20, title:'Trachea',    sub:'หลอดลม', desc:'ทางเดินหลักนำอากาศเข้าสู่ปอด' },
            { x:47, y:34, title:'Bronchi',    sub:'หลอดลมฝอย',desc:'แยกสองแขนงนำอากาศเข้าแต่ละปอด' },
            { x:47, y:70, title:'Diaphragm',  sub:'กะบังลม', desc:'กล้ามเนื้อหลักขับเคลื่อนการหายใจ' }
        ]
    },
    liver: {
        modelPath: 'human_liver_and_gallbladder/scene.gltf',
        nameEN: 'Liver', nameTH: 'ตับ', weight: '1.5 kg',
        desc: 'โรงงานเคมีที่ใหญ่ที่สุดของร่างกาย ทำหน้าที่กว่า 500 อย่าง รวมถึงกำจัดสารพิษ',
        annotations: [
            { x:38, y:38, title:'Right Lobe',   sub:'กลีบขวา',  desc:'กลีบใหญ่ที่สุด คิดเป็น 60% ของน้ำหนักตับ' },
            { x:58, y:40, title:'Left Lobe',    sub:'กลีบซ้าย', desc:'กลีบเล็กกว่า ขยายเข้าช่องท้องด้านซ้าย' },
            { x:42, y:67, title:'Gallbladder',  sub:'ถุงน้ำดี',  desc:'กักเก็บน้ำดีจากตับ ปล่อยออกเมื่อย่อยอาหาร' },
            { x:50, y:52, title:'Portal Vein',  sub:'เส้นเลือดพอร์ทัล',desc:'นำเลือดจากระบบย่อยอาหารมากรองที่ตับ' }
        ]
    }
};

const MUSIC = {
    ambient: 'https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3',
    focus:   'https://cdn.pixabay.com/download/audio/2022/03/10/audio_2c2d0e0c9f.mp3',
    nature:  'https://cdn.pixabay.com/download/audio/2022/03/24/audio_c8b5d3f8b3.mp3'
};

/* ═══════════════════════════════════════════════════════════
   DOM REFS
═══════════════════════════════════════════════════════════ */
const $  = id => document.getElementById(id);
const viewer      = $('viewer');
const loading     = $('loading');
const annLayer    = $('ann-layer');
const infoCard    = $('info-card');
const backdrop    = $('backdrop');
const sidebar     = $('sidebar');
const settingsPnl = $('settings-panel');
const bgAudio     = $('bg-audio');
const cameraVideo = $('camera-video');
const arContainer = $('ar-container');
const arControls  = $('ar-controls');

/* ═══════════════════════════════════════════════════════════
   STATE
═══════════════════════════════════════════════════════════ */
let currentOrganId  = localStorage.getItem('selectedOrgan') || 'brain';
let currentMode     = 'explore';   // 'explore' | 'ar'
let annVisible      = true;
let isFrozen        = false;       // freeze rotation in AR mode
let cameraStream    = null;
let currentTrack    = 'ambient';
let selectedDotIdx  = -1;

/* ═══════════════════════════════════════════════════════════
   BOOT
═══════════════════════════════════════════════════════════ */
window.addEventListener('load', async () => {
    // default: explore mode — dark gradient bg
    arContainer.classList.add('explore-bg');
    cameraVideo.style.display = 'none';

    await loadOrgan(currentOrganId, false);
    markActiveOrgan(currentOrganId);

    // hide loading after bar animation (~1.6s)
    setTimeout(() => loading.classList.add('out'), 1600);
});

/* ═══════════════════════════════════════════════════════════
   ORGAN LOADER
═══════════════════════════════════════════════════════════ */
async function loadOrgan(id, animate = true) {
    const data = ORGANS[id];
    if (!data) return;
    currentOrganId = id;
    localStorage.setItem('selectedOrgan', id);

    // Clear old annotations + detail
    clearAnnotations();
    hideAnnDetail();

    // Show loading overlay
    loading.classList.remove('out');

    viewer.addEventListener('load', () => {
        setTimeout(() => {
            loading.classList.add('out');
            updateCard(data);
            if (annVisible) renderAnnotations(data.annotations);
            if (animate) expandCard();
        }, 400);
    }, { once: true });

    viewer.src = data.modelPath;
    viewer.resetCamera = false;
}

/* ═══════════════════════════════════════════════════════════
   INFO CARD
═══════════════════════════════════════════════════════════ */
function updateCard(data) {
    $('card-label').textContent   = 'Anatomy — ' + data.nameEN;
    $('card-name-en').textContent = data.nameEN;
    $('card-name-th').textContent = data.nameTH;
    $('card-weight').textContent  = data.weight;
    $('card-desc').textContent    = data.desc;
}

function expandCard()   { infoCard.classList.remove('collapsed'); }
function collapseCard() { infoCard.classList.add('collapsed'); }

$('card-handle').addEventListener('click', () => {
    infoCard.classList.toggle('collapsed');
});

/* ═══════════════════════════════════════════════════════════
   ANNOTATION DOTS
═══════════════════════════════════════════════════════════ */
function renderAnnotations(anns) {
    clearAnnotations();
    anns.forEach((ann, idx) => {
        const dot = document.createElement('div');
        dot.className = 'ann-dot';
        dot.style.left = ann.x + 'vw';
        dot.style.top  = ann.y + 'vh';
        dot.setAttribute('data-idx', idx);

        const core = document.createElement('div');
        core.className = 'ann-dot-core';
        dot.appendChild(core);

        dot.addEventListener('click', (e) => {
            e.stopPropagation();
            selectAnnotation(idx, ann);
        });
        annLayer.appendChild(dot);
    });
}

function clearAnnotations() {
    annLayer.innerHTML = '';
    selectedDotIdx = -1;
}

function selectAnnotation(idx, ann) {
    // deselect all dots
    annLayer.querySelectorAll('.ann-dot').forEach(d => d.classList.remove('selected'));
    // select clicked
    const dot = annLayer.querySelector(`[data-idx="${idx}"]`);
    if (dot) dot.classList.add('selected');
    selectedDotIdx = idx;

    // show detail in card
    $('ann-d-title').textContent = ann.title;
    $('ann-d-sub').textContent   = ann.sub;
    $('ann-d-desc').textContent  = ann.desc;
    $('ann-detail').classList.add('show');

    expandCard();
}

function hideAnnDetail() {
    $('ann-detail').classList.remove('show');
    annLayer.querySelectorAll('.ann-dot').forEach(d => d.classList.remove('selected'));
    selectedDotIdx = -1;
}

// click on model canvas → deselect annotation
viewer.addEventListener('click', () => {
    if (selectedDotIdx !== -1) hideAnnDetail();
});

/* ═══════════════════════════════════════════════════════════
   MODE SWITCHING — EXPLORE / AR
═══════════════════════════════════════════════════════════ */
document.querySelectorAll('.mode-tab').forEach(tab => {
    tab.addEventListener('click', () => {
        const mode = tab.dataset.mode;
        if (mode === currentMode) return;
        setMode(mode);
    });
});

async function setMode(mode) {
    currentMode = mode;

    // update badge UI
    document.querySelectorAll('.mode-tab').forEach(t => {
        t.classList.toggle('active', t.dataset.mode === mode);
    });

    if (mode === 'ar') {
        /* ── AR Mode ─────────────────────────────────────
           - Real camera background
           - touch-action: pan-y (default, camera controls ON)
           - Model locked: rotation only, NO pan/translate
           - AR controls sidebar appears
        ─────────────────────────────────────────────── */
        await startCamera();
        arContainer.classList.remove('explore-bg');
        cameraVideo.style.display = 'block';

        // Lock model position — only rotation allowed
        // model-viewer: disable pan (drag), keep rotation & zoom
        viewer.setAttribute('touch-action', 'none');
        viewer.setAttribute('interaction-policy', 'allow-when-focused');
        // Orbit limits to prevent panning the model away
        viewer.setAttribute('camera-orbit', viewer.cameraOrbit || '0deg 78deg 105%');
        // Remove pan by intercepting pointer events — handled via CSS / model-viewer attributes
        viewer.setAttribute('disable-pan', '');

        arControls.classList.add('visible');
        isFrozen = false;
        $('btn-freeze').classList.remove('frozen');

    } else {
        /* ── Explore Mode ────────────────────────────────
           - Dark gradient background
           - Full camera controls (rotate, zoom, pan)
        ─────────────────────────────────────────────── */
        stopCamera();
        cameraVideo.style.display = 'none';
        arContainer.classList.add('explore-bg');

        viewer.removeAttribute('disable-pan');
        viewer.setAttribute('touch-action', 'pan-y');
        viewer.removeAttribute('interaction-policy');

        arControls.classList.remove('visible');
        isFrozen = false;
        viewer.autoRotate = false;
        $('tog-rotate').checked = false;
    }
}

/* ═══════════════════════════════════════════════════════════
   CAMERA
═══════════════════════════════════════════════════════════ */
async function startCamera() {
    if (cameraStream) return;
    try {
        cameraStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: { ideal: 'environment' }, width:{ ideal:1920 }, height:{ ideal:1080 } },
            audio: false
        });
        cameraVideo.srcObject = cameraStream;
        await cameraVideo.play();
    } catch(err) {
        console.warn('[Camera] Access denied or not available:', err);
        // fallback — stay in gradient but show AR controls
        arContainer.classList.add('explore-bg');
    }
}

function stopCamera() {
    if (!cameraStream) return;
    cameraStream.getTracks().forEach(t => t.stop());
    cameraStream = null;
    cameraVideo.srcObject = null;
}

/* ═══════════════════════════════════════════════════════════
   AR CONTROLS
═══════════════════════════════════════════════════════════ */
// Zoom in / out via camera orbit radius
function getOrbitParts() {
    // cameraOrbit returns e.g. "0deg 75deg 105%"
    const parts = (viewer.getCameraOrbit
        ? [viewer.getCameraOrbit().theta + 'rad', viewer.getCameraOrbit().phi + 'rad', viewer.getCameraOrbit().radius + 'm']
        : ['0deg','78deg','105%']
    );
    return parts;
}

$('btn-zoom-in').addEventListener('click', () => {
    const current = viewer.cameraOrbit;
    const parts = current ? current.split(' ') : ['0deg','78deg','105%'];
    const radiusPart = parts[2] || '105%';
    const numMatch = radiusPart.match(/([0-9.]+)(.*)/);
    if (numMatch) {
        const newVal = Math.max(20, parseFloat(numMatch[1]) * 0.85);
        parts[2] = newVal.toFixed(1) + numMatch[2];
        viewer.cameraOrbit = parts.join(' ');
    }
});

$('btn-zoom-out').addEventListener('click', () => {
    const current = viewer.cameraOrbit;
    const parts = current ? current.split(' ') : ['0deg','78deg','105%'];
    const radiusPart = parts[2] || '105%';
    const numMatch = radiusPart.match(/([0-9.]+)(.*)/);
    if (numMatch) {
        const newVal = Math.min(400, parseFloat(numMatch[1]) * 1.18);
        parts[2] = newVal.toFixed(1) + numMatch[2];
        viewer.cameraOrbit = parts.join(' ');
    }
});

$('btn-freeze').addEventListener('click', () => {
    isFrozen = !isFrozen;
    $('btn-freeze').classList.toggle('frozen', isFrozen);
    // disable all camera controls when frozen
    viewer.cameraControls = !isFrozen;
    if (!isFrozen) viewer.cameraControls = true;
});

$('btn-reset-ar').addEventListener('click', () => {
    viewer.cameraOrbit = '0deg 78deg 105%';
    viewer.fieldOfView = 'auto';
});

/* ═══════════════════════════════════════════════════════════
   SIDEBAR
═══════════════════════════════════════════════════════════ */
function openSidebar()  { sidebar.classList.add('open'); backdrop.classList.add('on'); }
function closeSidebar() { sidebar.classList.remove('open'); backdrop.classList.remove('on'); settingsPnl.classList.remove('open'); }

$('btn-menu').addEventListener('click', () => {
    settingsPnl.classList.remove('open');
    openSidebar();
});
$('close-sidebar').addEventListener('click', closeSidebar);
$('btn-home').addEventListener('click', () => { window.location.href = 'home.html'; });

document.querySelectorAll('.organ-item').forEach(item => {
    item.addEventListener('click', () => {
        const id = item.dataset.organ;
        if (id === currentOrganId) { closeSidebar(); return; }
        markActiveOrgan(id);
        loadOrgan(id);
        closeSidebar();
    });
});

function markActiveOrgan(id) {
    document.querySelectorAll('.organ-item').forEach(el => {
        el.classList.toggle('active', el.dataset.organ === id);
    });
}

/* ═══════════════════════════════════════════════════════════
   SETTINGS PANEL
═══════════════════════════════════════════════════════════ */
$('btn-settings').addEventListener('click', () => {
    sidebar.classList.remove('open');
    settingsPnl.classList.toggle('open');
    backdrop.classList.toggle('on', settingsPnl.classList.contains('open'));
});
$('close-settings').addEventListener('click', () => {
    settingsPnl.classList.remove('open');
    backdrop.classList.remove('on');
});
backdrop.addEventListener('click', closeSidebar);

/* ─ Auto-rotate ─ */
$('tog-rotate').addEventListener('change', function() {
    viewer.autoRotate = this.checked;
    viewer.autoRotateDelay = 600;
});

/* ─ Shadow ─ */
$('tog-shadow').addEventListener('change', function() {
    viewer.shadowIntensity = this.checked ? 1 : 0;
});

/* ─ Annotations toggle ─ */
$('tog-ann').addEventListener('change', function() {
    annVisible = this.checked;
    if (annVisible) {
        renderAnnotations(ORGANS[currentOrganId].annotations);
    } else {
        clearAnnotations();
        hideAnnDetail();
    }
});

/* ─ Music toggle ─ */
$('tog-music').addEventListener('change', function() {
    if (this.checked) {
        if (!bgAudio.src || bgAudio.src === location.href) setTrack(currentTrack);
        bgAudio.play().catch(()=>{});
    } else {
        bgAudio.pause();
    }
});

/* ─ Volume slider ─ */
$('vol-slider').addEventListener('input', function() {
    bgAudio.volume = this.value / 100;
    $('vol-label').textContent = this.value + '%';
});
bgAudio.volume = 0.5;

/* ─ Music track selector ─ */
document.querySelectorAll('.m-opt').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.m-opt').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        setTrack(btn.dataset.track);
    });
});
function setTrack(id) {
    currentTrack = id;
    const wasPlaying = !bgAudio.paused;
    bgAudio.src = MUSIC[id];
    if (wasPlaying) bgAudio.play().catch(()=>{});
}

/* ─ Reset camera ─ */
$('btn-reset-cam').addEventListener('click', () => {
    viewer.cameraOrbit = '0deg 78deg 105%';
    viewer.fieldOfView = 'auto';
});

/* ═══════════════════════════════════════════════════════════
   KEYBOARD
═══════════════════════════════════════════════════════════ */
document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
        closeSidebar();
        settingsPnl.classList.remove('open');
        backdrop.classList.remove('on');
    }
});

/* ═══════════════════════════════════════════════════════════
   RESIZE — re-render annotations
═══════════════════════════════════════════════════════════ */
let resizeTimer;
window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => {
        if (annVisible && currentOrganId) {
            renderAnnotations(ORGANS[currentOrganId].annotations);
        }
    }, 200);
});
</script>

</body>
</html>
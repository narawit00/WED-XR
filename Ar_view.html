<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="theme-color" content="#080c14">
    <title>AR Anatomy Viewer - Enhanced</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;0,600;1,300;1,400&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500&family=Noto+Sans+Thai:wght@300;400;500&display=swap" rel="stylesheet">

    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>

    <style>
        /* â”€â”€â”€ Variables â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        :root {
            --ink:         #0d1117;
            --ink-2:       #3a3f4a;
            --ink-3:       #7a808c;
            --surface:     #ffffff;
            --surface-2:   #f5f6f8;
            --border:      rgba(0,0,0,0.08);
            --border-2:    rgba(0,0,0,0.13);
            --accent:      #1847c9;
            --accent-soft: rgba(24, 71, 201, 0.10);
            --accent-ring: rgba(24, 71, 201, 0.28);
            --white-glass: rgba(255,255,255,0.11);
            --white-border: rgba(255,255,255,0.18);
            --ease-out:    cubic-bezier(0.22, 1, 0.36, 1);
            --ease-spring: cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        /* â”€â”€â”€ Reset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        *, *::before, *::after { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
        html, body { height:100%; overflow:hidden; background:#080c14; font-family:'DM Sans','Noto Sans Thai',sans-serif; color:var(--ink); -webkit-font-smoothing:antialiased; }
        button { font-family:inherit; cursor:pointer; border:none; background:none; }

        /* â”€â”€â”€ Loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #loading {
            position:fixed; inset:0; background:var(--ink); z-index:9999;
            display:flex; flex-direction:column; align-items:center; justify-content:center; gap:28px;
            transition:opacity 0.7s var(--ease-out), visibility 0.7s;
        }
        #loading.out { opacity:0; visibility:hidden; pointer-events:none; }
        .load-wordmark {
            font-family:'Cormorant Garamond',serif; font-size:2.2rem; font-weight:300;
            color:#fff; letter-spacing:0.12em; text-transform:uppercase;
        }
        .load-wordmark em { font-style:italic; color:#788eed; }
        .load-bar { width:140px; height:1px; background:rgba(255,255,255,0.12); position:relative; overflow:hidden; }
        .load-bar::after {
            content:''; position:absolute; inset-block:0; left:-100%;
            width:100%; background:linear-gradient(90deg,transparent,#788eed,transparent);
            animation:barScan 1.5s ease-in-out forwards;
        }
        @keyframes barScan { to { left:100%; } }
        .load-hint { font-size:0.72rem; color:rgba(255,255,255,0.3); letter-spacing:0.15em; text-transform:uppercase; }

        /* â”€â”€â”€ AR Container â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #ar-container { position:fixed; inset:0; z-index:1; }

        #camera-video {
            position:absolute; inset:0; width:100%; height:100%;
            object-fit:cover; z-index:1;
        }

        /* Explore-mode: gradient background when no camera */
        #ar-container.explore-bg {
            background: radial-gradient(ellipse 70% 60% at 50% 40%,#111827 0%,#080c14 100%);
        }

        model-viewer {
            position:absolute; inset:0; width:100%; height:100%; z-index:2;
            background:transparent; --poster-color:transparent;
        }

        /* â”€â”€â”€ Heartbeat Animation for model-viewer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        model-viewer.heartbeat {
            animation: heartbeatPulse 1s ease-in-out infinite;
        }

        @keyframes heartbeatPulse {
            0%, 100% { transform: scale(1); }
            10% { transform: scale(1.05); }
            20% { transform: scale(1); }
            30% { transform: scale(1.08); }
            40%, 100% { transform: scale(1); }
        }

        /* â”€â”€â”€ Mode Badge (top-center) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #mode-badge {
            position:fixed; top:20px; left:50%; transform:translateX(-50%);
            display:flex; align-items:center; gap:0;
            background:var(--white-glass); backdrop-filter:blur(16px);
            border:1px solid var(--white-border); border-radius:40px;
            overflow:hidden; z-index:200;
            box-shadow:0 4px 20px rgba(0,0,0,0.3);
        }
        .mode-tab {
            padding:8px 22px; font-size:0.72rem; font-weight:500;
            color:rgba(255,255,255,0.5); letter-spacing:0.08em; text-transform:uppercase;
            transition:all 0.3s var(--ease-out); white-space:nowrap;
        }
        .mode-tab.active {
            color:#fff; background:rgba(255,255,255,0.15);
        }
        .mode-divider { width:1px; height:18px; background:var(--white-border); flex-shrink:0; }

        /* â”€â”€â”€ Top Corners â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .corner-btn {
            position:fixed; z-index:200; top:18px;
            width:42px; height:42px;
            background:var(--white-glass); backdrop-filter:blur(14px);
            border:1px solid var(--white-border); border-radius:10px;
            display:flex; align-items:center; justify-content:center;
            transition:all 0.25s var(--ease-out); color:#fff;
        }
        .corner-btn:hover { background:rgba(255,255,255,0.2); }
        .corner-btn:active { transform:scale(0.93); }
        .corner-btn svg { width:17px; height:17px; stroke:currentColor; fill:none; stroke-width:2; stroke-linecap:round; stroke-linejoin:round; }
        #btn-menu     { left:18px; }
        #btn-settings { right:18px; }

        /* â”€â”€â”€ AR Controls Bar (only visible in AR mode) â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #ar-controls {
            position:fixed; bottom:200px; right:16px;
            display:flex; flex-direction:column; gap:8px;
            z-index:150; opacity:0; pointer-events:none;
            transform:translateX(20px);
            transition:all 0.35s var(--ease-out);
        }
        #ar-controls.visible { opacity:1; pointer-events:auto; transform:translateX(0); }
        .ar-ctrl-btn {
            width:44px; height:44px;
            background:var(--white-glass); backdrop-filter:blur(14px);
            border:1px solid var(--white-border); border-radius:10px;
            display:flex; align-items:center; justify-content:center;
            color:#fff; font-size:1rem; transition:all 0.2s;
        }
        .ar-ctrl-btn:hover  { background:rgba(255,255,255,0.22); }
        .ar-ctrl-btn:active { transform:scale(0.9); }
        .ar-ctrl-btn svg { width:16px; height:16px; stroke:currentColor; fill:none; stroke-width:2.2; stroke-linecap:round; stroke-linejoin:round; }
        #btn-freeze.frozen { background:rgba(24,71,201,0.4); border-color:rgba(24,71,201,0.6); }

        /* â”€â”€â”€ Annotation Dots (model-viewer hotspots) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .ann-hotspot {
            background: transparent;
            border: none;
            cursor: pointer;
            display: block;
            width: 20px;
            height: 20px;
            position: relative;
        }
        
        .ann-hotspot .ann-dot-core {
            width: 10px;
            height: 10px;
            background: var(--accent);
            border: 2.5px solid #fff;
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 2px 8px rgba(24, 71, 201, 0.45);
            transition: transform 0.25s var(--ease-spring);
        }
        
        .ann-hotspot::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(24, 71, 201, 0.14);
            animation: annPulse 2.6s ease-in-out infinite;
        }
        
        @keyframes annPulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); opacity: 0.7; }
            50% { transform: translate(-50%, -50%) scale(2); opacity: 0; }
        }
        
        .ann-hotspot:hover .ann-dot-core {
            transform: translate(-50%, -50%) scale(1.5);
        }
        
        .ann-hotspot.selected .ann-dot-core {
            background: #fff;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--accent-ring);
        }

        /* â”€â”€â”€ Info Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #info-card {
            position:fixed; bottom:0; left:0; right:0;
            background:var(--surface); z-index:150;
            border-top:1px solid var(--border-2);
            border-radius:22px 22px 0 0;
            padding:0 24px 34px;
            box-shadow:0 -10px 40px rgba(0,0,0,0.18);
            transition:transform 0.45s var(--ease-spring);
            will-change:transform;
            max-height: 75vh;
            overflow-y: auto;
        }
        #info-card.collapsed { transform:translateY(calc(100% - 72px)); }

        /* drag handle */
        .card-handle {
            width:36px; height:4px; border-radius:2px;
            background:var(--border-2); margin:12px auto 16px;
            cursor:pointer;
        }

        .card-top {
            display:flex; align-items:flex-start; justify-content:space-between;
            margin-bottom:10px;
        }
        .card-organ-label {
            font-size:0.68rem; font-weight:500; letter-spacing:0.1em;
            text-transform:uppercase; color:var(--accent); margin-bottom:5px;
        }
        .card-name {
            font-family:'Cormorant Garamond',serif;
            font-size:1.65rem; font-weight:400; line-height:1.1;
            color:var(--ink); letter-spacing:-0.01em;
        }
        .card-name-th {
            font-size:0.85rem; color:var(--ink-3); font-weight:300; margin-top:2px;
        }
        .card-weight-pill {
            font-size:0.72rem; font-weight:500; color:var(--accent);
            background:var(--accent-soft); padding:5px 11px; border-radius:20px;
            flex-shrink:0; margin-left:12px; margin-top:4px; letter-spacing:0.02em;
        }
        
        /* Sound control button */
        .card-sound-btn {
            position: absolute;
            top: 18px;
            right: 24px;
            width: 38px;
            height: 38px;
            background: var(--surface-2);
            border: 1px solid var(--border-2);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.25s var(--ease-out);
            cursor: pointer;
            color: var(--ink-3);
        }
        .card-sound-btn:hover {
            background: var(--accent-soft);
            border-color: var(--accent);
            color: var(--accent);
        }
        .card-sound-btn.playing {
            background: var(--accent-soft);
            border-color: var(--accent);
            color: var(--accent);
            animation: soundPulse 1.5s ease-in-out infinite;
        }
        
        @keyframes soundPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .card-sound-btn svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            fill: none;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
        }
        
        .card-divider { height:1px; background:var(--border); margin:14px 0; }
        .card-desc {
            font-size:0.875rem; color:var(--ink-2); line-height:1.7; font-weight:300;
            margin-bottom: 12px;
        }
        
        /* Fun facts section */
        .card-facts {
            background: var(--surface-2);
            border-radius: 12px;
            padding: 14px 16px;
            margin-top: 12px;
        }
        .card-facts-title {
            font-size: 0.75rem;
            font-weight: 500;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: var(--accent);
            margin-bottom: 8px;
        }
        .card-facts-list {
            list-style: none;
        }
        .card-facts-list li {
            font-size: 0.82rem;
            color: var(--ink-2);
            line-height: 1.6;
            padding-left: 18px;
            position: relative;
            margin-bottom: 6px;
        }
        .card-facts-list li:before {
            content: 'â€¢';
            position: absolute;
            left: 6px;
            color: var(--accent);
            font-weight: bold;
        }

        /* Annotation detail block (shown on dot click) */
        #ann-detail {
            margin-top:14px; padding:14px 16px;
            background:var(--surface-2); border-radius:12px;
            border-left:3px solid var(--accent);
            display:none;
        }
        #ann-detail.show { display:block; }
        .ann-detail-title {
            font-family:'Cormorant Garamond',serif; font-size:1.05rem; font-weight:500;
            color:var(--ink); margin-bottom:3px;
        }
        .ann-detail-sub {
            font-size:0.72rem; color:var(--accent); font-weight:500;
            letter-spacing:0.04em; text-transform:uppercase; margin-bottom:6px;
        }
        .ann-detail-desc { font-size:0.82rem; color:var(--ink-2); line-height:1.6; font-weight:300; }

        /* â”€â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #sidebar {
            position:fixed; top:0; left:0; height:100%; width:275px;
            background:var(--surface); z-index:500;
            transform:translateX(-100%);
            transition:transform 0.35s var(--ease-out);
            box-shadow:8px 0 32px rgba(0,0,0,0.18);
            display:flex; flex-direction:column; overflow:hidden;
        }
        #sidebar.open { transform:translateX(0); }

        /* â”€â”€â”€ Settings Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #settings-panel {
            position:fixed; top:0; right:0; height:100%; width:290px;
            background:var(--surface); z-index:500;
            transform:translateX(100%);
            transition:transform 0.35s var(--ease-out);
            box-shadow:-8px 0 32px rgba(0,0,0,0.18);
            display:flex; flex-direction:column; overflow:hidden;
        }
        #settings-panel.open { transform:translateX(0); }

        /* shared panel parts */
        .panel-head {
            padding:22px 20px 18px; border-bottom:1px solid var(--border);
            display:flex; align-items:center; justify-content:space-between; flex-shrink:0;
        }
        .panel-title {
            font-family:'Cormorant Garamond',serif; font-size:1.25rem;
            font-weight:400; color:var(--ink); letter-spacing:-0.01em;
        }
        .panel-close {
            width:30px; height:30px; border:1px solid var(--border-2);
            border-radius:8px; background:var(--surface-2);
            display:flex; align-items:center; justify-content:center;
            color:var(--ink-3); transition:all 0.2s;
        }
        .panel-close:hover { color:var(--ink); background:var(--border); }
        .panel-close svg { width:13px; height:13px; stroke:currentColor; fill:none; stroke-width:2.5; stroke-linecap:round; }

        /* organ list */
        .organ-list { list-style:none; padding:12px 10px; flex:1; overflow-y:auto; }
        .organ-item {
            display:flex; align-items:center; gap:13px;
            padding:13px 14px; border-radius:11px; cursor:pointer;
            border:1px solid transparent; margin-bottom:3px;
            transition:all 0.2s;
        }
        .organ-item:hover { background:var(--surface-2); border-color:var(--border); }
        .organ-item.active { background:var(--accent-soft); border-color:rgba(24,71,201,0.18); }
        .organ-item.active .oi-name { color:var(--accent); }
        .organ-item.active .oi-en   { color:rgba(24,71,201,0.6); }
        .organ-item.active .oi-icon { background:var(--accent-soft); border-color:rgba(24,71,201,0.2); }
        .organ-item.active .oi-icon svg { stroke:var(--accent); }
        .oi-icon {
            width:34px; height:34px; border-radius:9px; flex-shrink:0;
            background:var(--surface-2); border:1px solid var(--border);
            display:flex; align-items:center; justify-content:center; transition:all 0.2s;
        }
        .oi-icon svg { width:17px; height:17px; stroke:var(--ink-3); fill:none; stroke-width:1.6; stroke-linecap:round; stroke-linejoin:round; }
        .oi-name { font-size:0.95rem; color:var(--ink); line-height:1; }
        .oi-en   { font-size:0.73rem; color:var(--ink-3); font-weight:300; margin-top:2px; letter-spacing:0.02em; }
        .panel-foot { padding:14px 10px 24px; border-top:1px solid var(--border); flex-shrink:0; }
        .panel-home {
            width:100%; padding:12px; border:1px solid var(--border-2);
            border-radius:10px; background:var(--surface-2);
            font-size:0.875rem; color:var(--ink-2); font-weight:400;
            transition:all 0.2s; letter-spacing:0.01em;
        }
        .panel-home:hover { background:var(--surface); color:var(--ink); border-color:var(--accent); }

        /* settings content */
        .settings-body { flex:1; overflow-y:auto; }
        .s-section { padding:20px; border-bottom:1px solid var(--border); }
        .s-label { font-size:0.68rem; font-weight:500; letter-spacing:0.1em; text-transform:uppercase; color:var(--ink-3); margin-bottom:15px; }
        .s-row { display:flex; align-items:center; justify-content:space-between; margin-bottom:14px; }
        .s-row:last-child { margin-bottom:0; }
        .s-row-label { font-size:0.875rem; color:var(--ink); }

        /* toggle */
        .tog { position:relative; width:42px; height:23px; flex-shrink:0; }
        .tog input { opacity:0; width:0; height:0; position:absolute; }
        .tog-track { position:absolute; inset:0; background:#d1d5db; border-radius:12px; transition:background 0.3s; }
        .tog input:checked + .tog-track { background:var(--accent); }
        .tog-thumb { position:absolute; top:2.5px; left:2.5px; width:18px; height:18px; background:#fff; border-radius:50%; transition:transform 0.3s var(--ease-spring); box-shadow:0 1px 4px rgba(0,0,0,0.2); }
        .tog input:checked ~ .tog-thumb { transform:translateX(19px); }

        /* range */
        .s-slider-wrap { display:flex; flex-direction:column; gap:8px; }
        .s-slider-head { display:flex; justify-content:space-between; }
        .s-slider-val { font-size:0.8rem; color:var(--accent); font-weight:500; font-variant-numeric:tabular-nums; }
        .s-range {
            -webkit-appearance:none; appearance:none;
            width:100%; height:3px; background:var(--border-2); border-radius:2px; outline:none;
        }
        .s-range::-webkit-slider-thumb {
            -webkit-appearance:none; width:15px; height:15px;
            background:var(--accent); border:2px solid #fff; border-radius:50%;
            cursor:pointer; box-shadow:0 1px 5px rgba(24,71,201,0.35);
        }

        /* music opts */
        .music-opts { display:flex; gap:7px; margin-top:3px; }
        .m-opt {
            flex:1; padding:8px 5px; border:1px solid var(--border-2);
            border-radius:8px; background:var(--surface-2);
            font-size:0.73rem; font-weight:500; color:var(--ink-3);
            text-align:center; transition:all 0.2s; letter-spacing:0.02em;
        }
        .m-opt:hover  { border-color:var(--accent); color:var(--accent); }
        .m-opt.active { background:var(--accent-soft); border-color:var(--accent); color:var(--accent); }

        .reset-btn {
            width:100%; padding:10px; border:1px solid var(--border-2);
            border-radius:10px; background:var(--surface-2);
            font-size:0.875rem; color:var(--ink-2); transition:all 0.2s;
        }
        .reset-btn:hover { border-color:var(--accent); color:var(--accent); background:var(--accent-soft); }

        /* â”€â”€â”€ Backdrop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        #backdrop {
            position:fixed; inset:0; background:rgba(0,0,0,0.42); z-index:400;
            opacity:0; visibility:hidden; transition:all 0.3s;
        }
        #backdrop.on { opacity:1; visibility:visible; }
    </style>
</head>
<body>

<!-- â”€â”€ Loading â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="loading">
    <div class="load-wordmark">AR <em>Anatomy</em></div>
    <div class="load-bar"></div>
    <div class="load-hint">à¸à¸³à¸¥à¸±à¸‡à¹‚à¸«à¸¥à¸”...</div>
</div>

<!-- â”€â”€ AR / Camera Layer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="ar-container">
    <video id="camera-video" autoplay playsinline muted></video>
    <model-viewer
        id="viewer"
        camera-controls
        touch-action="pan-y"
        ar
        ar-modes="webxr scene-viewer quick-look"
        ar-scale="fixed"
        shadow-intensity="1"
        exposure="1.1"
        camera-orbit="0deg 78deg 105%"
        min-camera-orbit="auto auto 5%"
        max-camera-orbit="auto auto 500%"
        interpolation-decay="200"
        environment-image="neutral">
    </model-viewer>
</div>

<!-- â”€â”€ Mode toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="mode-badge">
    <button class="mode-tab active" data-mode="explore">à¸ªà¸³à¸£à¸§à¸ˆ</button>
    <div class="mode-divider"></div>
    <button class="mode-tab" data-mode="ar">AR à¸ªà¸”</button>
</div>

<!-- â”€â”€ Top corner buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<button class="corner-btn" id="btn-menu" aria-label="Menu">
    <svg viewBox="0 0 24 24"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
</button>
<button class="corner-btn" id="btn-settings" aria-label="Settings">
    <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
</button>

<!-- â”€â”€ AR Controls (only in AR mode) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="ar-controls">
    <button class="ar-ctrl-btn" id="btn-zoom-in" title="à¸‹à¸¹à¸¡à¹€à¸‚à¹‰à¸²">
        <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></svg>
    </button>
    <button class="ar-ctrl-btn" id="btn-zoom-out" title="à¸‹à¸¹à¸¡à¸­à¸­à¸">
        <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/></svg>
    </button>
    <button class="ar-ctrl-btn" id="btn-freeze" title="à¸«à¸¢à¸¸à¸”à¸«à¸¡à¸¸à¸™">
        <svg viewBox="0 0 24 24"><line x1="12" y1="2" x2="12" y2="22"/><path d="M17 7l-5-5-5 5"/><path d="M17 17l-5 5-5-5"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M7 7l-5 5 5 5"/><path d="M17 7l5 5-5 5"/></svg>
    </button>
    <button class="ar-ctrl-btn" id="btn-reset-ar" title="à¸£à¸µà¹€à¸‹à¹‡à¸•">
        <svg viewBox="0 0 24 24"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>
    </button>
</div>

<!-- â”€â”€ Info Card â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="info-card" class="collapsed">
    <div class="card-handle" id="card-handle"></div>
    
    <button class="card-sound-btn" id="btn-organ-sound" title="à¹€à¸¥à¹ˆà¸™à¹€à¸ªà¸µà¸¢à¸‡à¸­à¸§à¸±à¸¢à¸§à¸°">
        <svg viewBox="0 0 24 24" class="sound-icon">
            <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/>
            <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"/>
        </svg>
    </button>
    
    <div class="card-top">
        <div>
            <div class="card-organ-label" id="card-label">Anatomy</div>
            <div class="card-name"    id="card-name-en">â€”</div>
            <div class="card-name-th" id="card-name-th">â€”</div>
        </div>
        <div class="card-weight-pill" id="card-weight">â€”</div>
    </div>
    <div class="card-divider"></div>
    <p class="card-desc" id="card-desc">â€”</p>
    
    <div class="card-facts" id="card-facts">
        <div class="card-facts-title">à¸„à¸§à¸²à¸¡à¸£à¸¹à¹‰à¸™à¹ˆà¸²à¸ªà¸™à¹ƒà¸ˆ</div>
        <ul class="card-facts-list" id="facts-list"></ul>
    </div>
    
    <div id="ann-detail">
        <div class="ann-detail-title" id="ann-d-title"></div>
        <div class="ann-detail-sub"   id="ann-d-sub"></div>
        <div class="ann-detail-desc"  id="ann-d-desc"></div>
    </div>
</div>

<!-- â”€â”€ Sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<nav id="sidebar">
    <div class="panel-head">
        <span class="panel-title">à¸­à¸§à¸±à¸¢à¸§à¸°</span>
        <button class="panel-close" id="close-sidebar">
            <svg viewBox="0 0 13 13"><line x1="1" y1="1" x2="12" y2="12"/><line x1="12" y1="1" x2="1" y2="12"/></svg>
        </button>
    </div>
    <ul class="organ-list">
        <li class="organ-item" data-organ="brain">
            <div class="oi-icon"><svg viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 2.74 1.49 5.14 3.7 6.44C9.39 17.73 10 19.8 10 22h4c0-2.2.61-4.27 1.3-6.56C17.51 14.14 19 11.74 19 9c0-3.87-3.13-7-7-7z"/><line x1="10" y1="15" x2="14" y2="15"/></svg></div>
            <div><div class="oi-name">à¸ªà¸¡à¸­à¸‡</div><div class="oi-en">Brain</div></div>
        </li>
        <li class="organ-item" data-organ="heart">
            <div class="oi-icon"><svg viewBox="0 0 24 24"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/></svg></div>
            <div><div class="oi-name">à¸«à¸±à¸§à¹ƒà¸ˆ</div><div class="oi-en">Heart</div></div>
        </li>
        <li class="organ-item" data-organ="lungs">
            <div class="oi-icon"><svg viewBox="0 0 24 24"><path d="M12 3v10M9 8c-1.5 1.5-4 3-4 7a4 4 0 0 0 8 0M15 8c1.5 1.5 4 3 4 7a4 4 0 0 1-8 0"/></svg></div>
            <div><div class="oi-name">à¸›à¸­à¸”</div><div class="oi-en">Lungs</div></div>
        </li>
        <li class="organ-item" data-organ="liver">
            <div class="oi-icon"><svg viewBox="0 0 24 24"><path d="M4 12c0-4.4 3.6-8 8-8s8 3.6 8 8c0 2.5-1.1 4.7-2.9 6.2C15.4 19.3 13.8 20 12 20H8c-2.2 0-4-1.8-4-4v-4z"/></svg></div>
            <div><div class="oi-name">à¸•à¸±à¸š</div><div class="oi-en">Liver</div></div>
        </li>
    </ul>
    <div class="panel-foot">
        <button class="panel-home" id="btn-home">à¸à¸¥à¸±à¸šà¸«à¸™à¹‰à¸²à¸«à¸¥à¸±à¸</button>
    </div>
</nav>

<!-- â”€â”€ Settings Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<aside id="settings-panel">
    <div class="panel-head">
        <span class="panel-title">à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²</span>
        <button class="panel-close" id="close-settings">
            <svg viewBox="0 0 13 13"><line x1="1" y1="1" x2="12" y2="12"/><line x1="12" y1="1" x2="1" y2="12"/></svg>
        </button>
    </div>
    <div class="settings-body">
        <div class="s-section">
            <div class="s-label">à¸à¸²à¸£à¹à¸ªà¸”à¸‡à¸œà¸¥</div>
            <div class="s-row">
                <span class="s-row-label">à¸«à¸¡à¸¸à¸™à¸­à¸±à¸•à¹‚à¸™à¸¡à¸±à¸•à¸´</span>
                <label class="tog"><input type="checkbox" id="tog-rotate"><div class="tog-track"></div><div class="tog-thumb"></div></label>
            </div>
            <div class="s-row">
                <span class="s-row-label">à¹à¸ªà¸”à¸‡à¹€à¸‡à¸²</span>
                <label class="tog"><input type="checkbox" id="tog-shadow" checked><div class="tog-track"></div><div class="tog-thumb"></div></label>
            </div>
            <div class="s-row">
                <span class="s-row-label">à¸ˆà¸¸à¸”à¸­à¸˜à¸´à¸šà¸²à¸¢</span>
                <label class="tog"><input type="checkbox" id="tog-ann" checked><div class="tog-track"></div><div class="tog-thumb"></div></label>
            </div>
        </div>
        <div class="s-section">
            <div class="s-label">à¹€à¸ªà¸µà¸¢à¸‡à¸­à¸§à¸±à¸¢à¸§à¸°</div>
            <div class="s-slider-wrap" style="margin-bottom:14px">
                <div class="s-slider-head">
                    <span class="s-row-label">à¸£à¸°à¸”à¸±à¸šà¹€à¸ªà¸µà¸¢à¸‡à¸­à¸§à¸±à¸¢à¸§à¸°</span>
                    <span class="s-slider-val" id="organ-vol-label">70%</span>
                </div>
                <input type="range" class="s-range" id="organ-vol-slider" min="0" max="100" value="70">
            </div>
        </div>
        <div class="s-section">
            <div class="s-label">à¹€à¸à¸¥à¸‡à¸à¸·à¹‰à¸™à¸«à¸¥à¸±à¸‡</div>
            <div class="s-row">
                <span class="s-row-label">à¹€à¸›à¸´à¸”à¹€à¸à¸¥à¸‡</span>
                <label class="tog"><input type="checkbox" id="tog-music"><div class="tog-track"></div><div class="tog-thumb"></div></label>
            </div>
            <div class="s-slider-wrap" style="margin-bottom:14px">
                <div class="s-slider-head">
                    <span class="s-row-label">à¸£à¸°à¸”à¸±à¸šà¹€à¸ªà¸µà¸¢à¸‡</span>
                    <span class="s-slider-val" id="vol-label">30%</span>
                </div>
                <input type="range" class="s-range" id="vol-slider" min="0" max="100" value="30">
            </div>
            <div class="music-opts">
                <button class="m-opt active" data-track="ambient">Ambient</button>
                <button class="m-opt" data-track="focus">Focus</button>
                <button class="m-opt" data-track="nature">Nature</button>
            </div>
        </div>
        <div class="s-section">
            <div class="s-label">à¸à¸¥à¹‰à¸­à¸‡</div>
            <button class="reset-btn" id="btn-reset-cam">à¸£à¸µà¹€à¸‹à¹‡à¸•à¸¡à¸¸à¸¡à¸¡à¸­à¸‡</button>
        </div>
    </div>
</aside>

<!-- â”€â”€ Backdrop â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="backdrop"></div>

<!-- 
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ğŸ”Š AUDIO ELEMENTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  à¸ªà¸­à¸‡à¸•à¸±à¸§à¸™à¸µà¹‰à¹€à¸›à¹‡à¸™ Audio elements à¸ªà¸³à¸«à¸£à¸±à¸šà¹€à¸¥à¹ˆà¸™à¹€à¸ªà¸µà¸¢à¸‡:
  1. bg-audio = à¹€à¸à¸¥à¸‡à¸à¸·à¹‰à¸™à¸«à¸¥à¸±à¸‡ (Background Music)
  2. organ-audio = à¹€à¸ªà¸µà¸¢à¸‡à¸­à¸§à¸±à¸¢à¸§à¸° (Organ Sounds)
-->
<audio id="bg-audio" loop></audio>
<audio id="organ-audio" loop></audio>

<script>
'use strict';

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸµ MUSIC LIBRARY
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   âš ï¸ à¹ƒà¸ªà¹ˆ URL à¹€à¸à¸¥à¸‡à¸à¸·à¹‰à¸™à¸«à¸¥à¸±à¸‡à¸‚à¸­à¸‡à¸„à¸¸à¸“à¸•à¸£à¸‡à¸™à¸µà¹‰!
   à¸¡à¸µ 3 à¹‚à¸«à¸¡à¸”: ambient, focus, nature
   à¸•à¸­à¸™à¸™à¸µà¹‰à¹ƒà¸Šà¹‰à¹€à¸à¸¥à¸‡à¸•à¸±à¸§à¸­à¸¢à¹ˆà¸²à¸‡à¸ˆà¸²à¸ Pixabay (à¸Ÿà¸£à¸µ, à¹„à¸¡à¹ˆà¸•à¹‰à¸­à¸‡à¸‚à¸­à¸­à¸™à¸¸à¸à¸²à¸•)
*/
const MUSIC = {
    ambient: 'https://cdn.pixabay.com/download/audio/2022/05/27/audio_1808fbf07a.mp3',  // ğŸµ à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™ URL à¸•à¸£à¸‡à¸™à¸µà¹‰à¸ªà¸³à¸«à¸£à¸±à¸š Ambient
    focus:   'Sound/focus.mp3',  // ğŸµ à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™ URL à¸•à¸£à¸‡à¸™à¸µà¹‰à¸ªà¸³à¸«à¸£à¸±à¸š Focus
    nature:  'Sound/nature.mp3'   // ğŸµ à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™ URL à¸•à¸£à¸‡à¸™à¸µà¹‰à¸ªà¸³à¸«à¸£à¸±à¸š Nature
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ«€ ORGAN DATA
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   à¸„à¸³à¸­à¸˜à¸´à¸šà¸²à¸¢à¸ªà¸±à¹‰à¸™à¹† à¸à¸£à¸°à¸Šà¸±à¸š à¹„à¸”à¹‰à¹ƒà¸ˆà¸„à¸§à¸²à¸¡
*/
const ORGANS = {
    brain: {
        modelPath: 'brain/scene.gltf',
        nameEN: 'Brain', 
        nameTH: 'à¸ªà¸¡à¸­à¸‡', 
        weight: '1.4 à¸à¸.',
        desc: 'à¸¨à¸¹à¸™à¸¢à¹Œà¸šà¸±à¸à¸Šà¸²à¸à¸²à¸£à¸‚à¸­à¸‡à¸£à¹ˆà¸²à¸‡à¸à¸²à¸¢ à¸„à¸§à¸šà¸„à¸¸à¸¡à¸„à¸§à¸²à¸¡à¸„à¸´à¸” à¸„à¸§à¸²à¸¡à¸ˆà¸³ à¸­à¸²à¸£à¸¡à¸“à¹Œ à¹à¸¥à¸°à¸à¸²à¸£à¹€à¸„à¸¥à¸·à¹ˆà¸­à¸™à¹„à¸«à¸§',
        // ğŸ”Š à¹ƒà¸ªà¹ˆ URL à¹€à¸ªà¸µà¸¢à¸‡à¸ªà¸¡à¸­à¸‡à¸•à¸£à¸‡à¸™à¸µà¹‰ (à¹€à¸Šà¹ˆà¸™ à¹€à¸ªà¸µà¸¢à¸‡à¸„à¸¥à¸·à¹ˆà¸™à¸ªà¸¡à¸­à¸‡ à¸«à¸£à¸·à¸­à¹€à¸ªà¸µà¸¢à¸‡ ambient à¹à¸šà¸š sci-fi)
        soundUrl: 'Sound/Brind.mp3', // âš ï¸ à¹ƒà¸ªà¹ˆ URL à¹€à¸ªà¸µà¸¢à¸‡à¸ªà¸¡à¸­à¸‡à¸‚à¸­à¸‡à¸„à¸¸à¸“à¸•à¸£à¸‡à¸™à¸µà¹‰
        hasAnimation: false, // à¸ªà¸¡à¸­à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¹à¸­à¸™à¸´à¹€à¸¡à¸Šà¸±à¸™
        facts: [
            'à¹ƒà¸Šà¹‰à¸à¸¥à¸±à¸‡à¸‡à¸²à¸™ 20% à¸‚à¸­à¸‡à¸—à¸±à¹‰à¸‡à¸£à¹ˆà¸²à¸‡à¸à¸²à¸¢',
            'à¸¡à¸µà¹€à¸‹à¸¥à¸¥à¹Œà¸›à¸£à¸°à¸ªà¸²à¸— 86,000 à¸¥à¹‰à¸²à¸™à¹€à¸‹à¸¥à¸¥à¹Œ',
            'à¸›à¸£à¸°à¸¡à¸§à¸¥à¸œà¸¥à¹€à¸£à¹‡à¸§à¸à¸§à¹ˆà¸²à¸„à¸­à¸¡à¸à¸´à¸§à¹€à¸•à¸­à¸£à¹Œ',
            'à¹„à¸¡à¹ˆà¸£à¸¹à¹‰à¸ªà¸¶à¸à¹€à¸ˆà¹‡à¸šà¸›à¸§à¸”à¸‚à¸­à¸‡à¸•à¸±à¸§à¹€à¸­à¸‡'
        ],
        annotations: [
            { 
                pos: '0m 0.15m 0.05m', 
                normal: '0m 1m 0m', 
                title:'Cerebrum',
                sub:'à¸ªà¸¡à¸­à¸‡à¹ƒà¸«à¸à¹ˆ',
                desc:'à¸„à¸§à¸šà¸„à¸¸à¸¡à¸„à¸§à¸²à¸¡à¸„à¸´à¸” à¸„à¸§à¸²à¸¡à¸ˆà¸³ à¹à¸¥à¸°à¸à¸²à¸£à¸£à¸±à¸šà¸£à¸¹à¹‰' 
            },
            { 
                pos: '-0.08m 0.08m 0.1m', 
                normal: '-1m 0m 1m', 
                title:'Frontal Lobe',
                sub:'à¸à¸¥à¸µà¸šà¸«à¸™à¹‰à¸²à¸œà¸²à¸', 
                desc:'à¸•à¸±à¸”à¸ªà¸´à¸™à¹ƒà¸ˆ à¸§à¸²à¸‡à¹à¸œà¸™ à¹à¸¥à¸°à¹à¸à¹‰à¸›à¸±à¸à¸«à¸²' 
            },
            { 
                pos: '0.1m -0.05m -0.08m', 
                normal: '1m 0m -1m', 
                title:'Cerebellum',
                sub:'à¸ªà¸¡à¸­à¸‡à¸™à¹‰à¸­à¸¢',
                desc:'à¸—à¸£à¸‡à¸•à¸±à¸§ à¸›à¸£à¸°à¸ªà¸²à¸™à¸‡à¸²à¸™à¸à¸¥à¹‰à¸²à¸¡à¹€à¸™à¸·à¹‰à¸­' 
            },
            { 
                pos: '0m -0.12m 0m', 
                normal: '0m -1m 0m', 
                title:'Brain Stem',
                sub:'à¸à¹‰à¸²à¸™à¸ªà¸¡à¸­à¸‡',
                desc:'à¸„à¸§à¸šà¸„à¸¸à¸¡à¸à¸²à¸£à¸«à¸²à¸¢à¹ƒà¸ˆà¹à¸¥à¸°à¸«à¸±à¸§à¹ƒà¸ˆà¹€à¸•à¹‰à¸™' 
            }
        ]
    },
    heart: {
        modelPath: 'human_heart/scene.gltf',
        nameEN: 'Heart', 
        nameTH: 'à¸«à¸±à¸§à¹ƒà¸ˆ', 
        weight: '300 à¸à¸£à¸±à¸¡',
        desc: 'à¸›à¸±à¹Šà¸¡à¹€à¸¥à¸·à¸­à¸”à¹„à¸›à¹€à¸¥à¸µà¹‰à¸¢à¸‡à¸—à¸±à¹ˆà¸§à¸£à¹ˆà¸²à¸‡à¸à¸²à¸¢ à¹€à¸•à¹‰à¸™ 100,000 à¸„à¸£à¸±à¹‰à¸‡à¸•à¹ˆà¸­à¸§à¸±à¸™à¹‚à¸”à¸¢à¹„à¸¡à¹ˆà¸«à¸¢à¸¸à¸”à¸à¸±à¸',
        // ğŸ”Š à¹€à¸ªà¸µà¸¢à¸‡à¸«à¸±à¸§à¹ƒà¸ˆà¹€à¸•à¹‰à¸™ (à¹ƒà¸Šà¹‰à¹€à¸ªà¸µà¸¢à¸‡à¸ˆà¸£à¸´à¸‡à¸ˆà¸²à¸ freesound.org)
        soundUrl: 'Sound/Hard.mp3', // âœ… à¹€à¸ªà¸µà¸¢à¸‡à¸«à¸±à¸§à¹ƒà¸ˆà¹€à¸•à¹‰à¸™à¸ˆà¸£à¸´à¸‡!
        hasAnimation: true, // âœ… à¸«à¸±à¸§à¹ƒà¸ˆà¸¡à¸µà¹à¸­à¸™à¸´à¹€à¸¡à¸Šà¸±à¸™à¹€à¸•à¹‰à¸™
        facts: [
            'à¹€à¸•à¹‰à¸™ 3 à¸à¸±à¸™à¸¥à¹‰à¸²à¸™à¸„à¸£à¸±à¹‰à¸‡à¹ƒà¸™à¸Šà¸µà¸§à¸´à¸• 70 à¸›à¸µ',
            'à¸ªà¸¹à¸šà¸‰à¸µà¸”à¹€à¸¥à¸·à¸­à¸”à¹„à¸”à¹‰à¹„à¸à¸¥ 9 à¹€à¸¡à¸•à¸£',
            'à¹€à¸£à¸´à¹ˆà¸¡à¹€à¸•à¹‰à¸™à¸•à¸±à¹‰à¸‡à¹à¸•à¹ˆà¹ƒà¸™à¸„à¸£à¸£à¸ à¹Œ 4 à¸ªà¸±à¸›à¸”à¸²à¸«à¹Œ',
            'à¸à¸¥à¹‰à¸²à¸¡à¹€à¸™à¸·à¹‰à¸­à¹à¸‚à¹‡à¸‡à¹à¸£à¸‡à¸—à¸µà¹ˆà¸ªà¸¸à¸”à¹ƒà¸™à¸£à¹ˆà¸²à¸‡à¸à¸²à¸¢'
        ],
        annotations: [
            { 
                pos: '-0.06m 0.08m 0.05m', 
                normal: '-1m 1m 1m', 
                title:'Left Atrium',
                sub:'à¸«à¹‰à¸­à¸‡à¸šà¸™à¸‹à¹‰à¸²à¸¢',
                desc:'à¸£à¸±à¸šà¹€à¸¥à¸·à¸­à¸”à¸ªà¸”à¸ˆà¸²à¸à¸›à¸­à¸”' 
            },
            { 
                pos: '0.06m 0.08m 0.05m', 
                normal: '1m 1m 1m', 
                title:'Right Atrium',
                sub:'à¸«à¹‰à¸­à¸‡à¸šà¸™à¸‚à¸§à¸²',
                desc:'à¸£à¸±à¸šà¹€à¸¥à¸·à¸­à¸”à¸”à¸³à¸ˆà¸²à¸à¸£à¹ˆà¸²à¸‡à¸à¸²à¸¢' 
            },
            { 
                pos: '-0.07m -0.05m 0.03m', 
                normal: '-1m -1m 1m', 
                title:'Left Ventricle',
                sub:'à¸«à¹‰à¸­à¸‡à¸¥à¹ˆà¸²à¸‡à¸‹à¹‰à¸²à¸¢',
                desc:'à¸ªà¸¹à¸šà¸‰à¸µà¸”à¹€à¸¥à¸·à¸­à¸”à¹„à¸›à¸—à¸±à¹ˆà¸§à¸£à¹ˆà¸²à¸‡à¸à¸²à¸¢' 
            },
            { 
                pos: '0.07m -0.05m 0.03m', 
                normal: '1m -1m 1m', 
                title:'Right Ventricle',
                sub:'à¸«à¹‰à¸­à¸‡à¸¥à¹ˆà¸²à¸‡à¸‚à¸§à¸²',
                desc:'à¸ªà¹ˆà¸‡à¹€à¸¥à¸·à¸­à¸”à¹„à¸›à¸Ÿà¸­à¸à¸—à¸µà¹ˆà¸›à¸­à¸”' 
            },
            { 
                pos: '0m 0.15m 0m', 
                normal: '0m 1m 0m', 
                title:'Aorta',
                sub:'à¸«à¸¥à¸­à¸”à¹€à¸¥à¸·à¸­à¸”à¹ƒà¸«à¸à¹ˆ',
                desc:'à¸ªà¹ˆà¸‡à¹€à¸¥à¸·à¸­à¸”à¸­à¸­à¸à¸ˆà¸²à¸à¸«à¸±à¸§à¹ƒà¸ˆ' 
            }
        ]
    },
    lungs: {
        modelPath: 'human_lungs/scene.gltf',
        nameEN: 'Lungs', 
        nameTH: 'à¸›à¸­à¸”', 
        weight: '1.0 à¸à¸.',
        desc: 'à¹à¸¥à¸à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¸­à¸²à¸à¸²à¸¨ à¸¡à¸µà¸–à¸¸à¸‡à¸¥à¸¡ 300 à¸¥à¹‰à¸²à¸™à¸–à¸¸à¸‡ à¸à¸·à¹‰à¸™à¸—à¸µà¹ˆà¸£à¸§à¸¡ 70 à¸•à¸²à¸£à¸²à¸‡à¹€à¸¡à¸•à¸£',
        // ğŸ”Š à¹ƒà¸ªà¹ˆ URL à¹€à¸ªà¸µà¸¢à¸‡à¸«à¸²à¸¢à¹ƒà¸ˆà¸•à¸£à¸‡à¸™à¸µà¹‰
        soundUrl: 'Sound/human_lungs.mp3', // âš ï¸ à¹ƒà¸ªà¹ˆ URL à¹€à¸ªà¸µà¸¢à¸‡à¸«à¸²à¸¢à¹ƒà¸ˆà¸‚à¸­à¸‡à¸„à¸¸à¸“à¸•à¸£à¸‡à¸™à¸µà¹‰
        hasAnimation: false, // à¸›à¸­à¸”à¹„à¸¡à¹ˆà¸¡à¸µà¹à¸­à¸™à¸´à¹€à¸¡à¸Šà¸±à¸™ (à¸«à¸£à¸·à¸­à¸ˆà¸°à¹€à¸à¸´à¹ˆà¸¡à¸à¹‡à¹„à¸”à¹‰)
        facts: [
            'à¸«à¸²à¸¢à¹ƒà¸ˆ 20,000 à¸„à¸£à¸±à¹‰à¸‡à¸•à¹ˆà¸­à¸§à¸±à¸™',
            'à¸›à¸­à¸”à¸‚à¸§à¸²à¹ƒà¸«à¸à¹ˆà¸à¸§à¹ˆà¸²à¸›à¸­à¸”à¸‹à¹‰à¸²à¸¢',
            'à¸ªà¸²à¸¡à¸²à¸£à¸–à¸¥à¸­à¸¢à¸™à¹‰à¸³à¹„à¸”à¹‰',
            'à¹„à¸¡à¹ˆà¸¡à¸µà¸à¸¥à¹‰à¸²à¸¡à¹€à¸™à¸·à¹‰à¸­à¸‚à¸­à¸‡à¸•à¸±à¸§à¹€à¸­à¸‡'
        ],
        annotations: [
            { 
                pos: '-0.08m 0m 0m', 
                normal: '-1m 0m 0m', 
                title:'Left Lung',
                sub:'à¸›à¸­à¸”à¸‹à¹‰à¸²à¸¢', 
                desc:'à¸¡à¸µ 2 à¸à¸¥à¸µà¸š à¹€à¸¥à¹‡à¸à¸à¸§à¹ˆà¸²à¸›à¸­à¸”à¸‚à¸§à¸²' 
            },
            { 
                pos: '0.08m 0m 0m', 
                normal: '1m 0m 0m', 
                title:'Right Lung',
                sub:'à¸›à¸­à¸”à¸‚à¸§à¸²', 
                desc:'à¸¡à¸µ 3 à¸à¸¥à¸µà¸š à¹ƒà¸«à¸à¹ˆà¸à¸§à¹ˆà¸²à¸›à¸­à¸”à¸‹à¹‰à¸²à¸¢' 
            },
            { 
                pos: '0m 0.13m 0.04m', 
                normal: '0m 1m 1m', 
                title:'Trachea',
                sub:'à¸«à¸¥à¸­à¸”à¸¥à¸¡', 
                desc:'à¸—à¹ˆà¸­à¸™à¸³à¸­à¸²à¸à¸²à¸¨à¹€à¸‚à¹‰à¸²à¸›à¸­à¸”' 
            },
            { 
                pos: '0m 0.06m 0.03m', 
                normal: '0m 1m 1m', 
                title:'Bronchi',
                sub:'à¸«à¸¥à¸­à¸”à¸¥à¸¡à¸à¸­à¸¢',
                desc:'à¹à¸¢à¸à¸ªà¸­à¸‡à¹à¸‚à¸™à¸‡à¹€à¸‚à¹‰à¸²à¹à¸•à¹ˆà¸¥à¸°à¸›à¸­à¸”' 
            },
            { 
                pos: '0m -0.14m 0m', 
                normal: '0m -1m 0m', 
                title:'Diaphragm',
                sub:'à¸à¸°à¸šà¸±à¸‡à¸¥à¸¡', 
                desc:'à¸à¸¥à¹‰à¸²à¸¡à¹€à¸™à¸·à¹‰à¸­à¸‚à¸±à¸šà¹€à¸„à¸¥à¸·à¹ˆà¸­à¸™à¸à¸²à¸£à¸«à¸²à¸¢à¹ƒà¸ˆ' 
            }
        ]
    },
    liver: {
        modelPath: 'human_liver_and_gallbladder/scene.gltf',
        nameEN: 'Liver', 
        nameTH: 'à¸•à¸±à¸š', 
        weight: '1.5 à¸à¸.',
        desc: 'à¹‚à¸£à¸‡à¸‡à¸²à¸™à¹€à¸„à¸¡à¸µà¸‚à¸­à¸‡à¸£à¹ˆà¸²à¸‡à¸à¸²à¸¢ à¸—à¸³à¸«à¸™à¹‰à¸²à¸—à¸µà¹ˆ 500+ à¸­à¸¢à¹ˆà¸²à¸‡ à¸à¸³à¸ˆà¸±à¸”à¸ªà¸²à¸£à¸à¸´à¸© à¸ªà¸£à¹‰à¸²à¸‡à¹‚à¸›à¸£à¸•à¸µà¸™',
        // ğŸ”Š à¹ƒà¸ªà¹ˆ URL à¹€à¸ªà¸µà¸¢à¸‡à¸•à¸±à¸šà¸•à¸£à¸‡à¸™à¸µà¹‰ (à¸­à¸²à¸ˆà¹€à¸›à¹‡à¸™à¹€à¸ªà¸µà¸¢à¸‡à¸™à¹‰à¸³à¹„à¸«à¸¥ à¸«à¸£à¸·à¸­à¹€à¸ªà¸µà¸¢à¸‡ ambient)
        soundUrl: 'Sound/liver.mp3', // âš ï¸ à¹ƒà¸ªà¹ˆ URL à¹€à¸ªà¸µà¸¢à¸‡à¸•à¸±à¸šà¸‚à¸­à¸‡à¸„à¸¸à¸“à¸•à¸£à¸‡à¸™à¸µà¹‰
        hasAnimation: false, // à¸•à¸±à¸šà¹„à¸¡à¹ˆà¸¡à¸µà¹à¸­à¸™à¸´à¹€à¸¡à¸Šà¸±à¸™
        facts: [
            'à¸­à¸§à¸±à¸¢à¸§à¸°à¸ à¸²à¸¢à¹ƒà¸™à¸—à¸µà¹ˆà¹ƒà¸«à¸à¹ˆà¹à¸¥à¸°à¸«à¸™à¸±à¸à¸—à¸µà¹ˆà¸ªà¸¸à¸”',
            'à¸ªà¸£à¹‰à¸²à¸‡à¸•à¸±à¸§à¹ƒà¸«à¸¡à¹ˆà¹„à¸”à¹‰à¸–à¸¶à¸‡à¹à¸¡à¹‰à¹€à¸«à¸¥à¸·à¸­ 25%',
            'à¸à¸£à¸­à¸‡à¹€à¸¥à¸·à¸­à¸” 1.4 à¸¥à¸´à¸•à¸£à¸•à¹ˆà¸­à¸™à¸²à¸—à¸µ',
            'à¸œà¸¥à¸´à¸•à¸™à¹‰à¸³à¸”à¸µà¸§à¸±à¸™à¸¥à¸° 800-1000 à¸¡à¸¥.'
        ],
        annotations: [
            { 
                pos: '-0.07m 0.02m 0.03m', 
                normal: '-1m 0m 1m', 
                title:'Right Lobe',
                sub:'à¸à¸¥à¸µà¸šà¸‚à¸§à¸²',
                desc:'à¸à¸¥à¸µà¸šà¹ƒà¸«à¸à¹ˆà¸—à¸µà¹ˆà¸ªà¸¸à¸” 60% à¸‚à¸­à¸‡à¸•à¸±à¸š' 
            },
            { 
                pos: '0.08m 0.01m 0.02m', 
                normal: '1m 0m 1m', 
                title:'Left Lobe',
                sub:'à¸à¸¥à¸µà¸šà¸‹à¹‰à¸²à¸¢', 
                desc:'à¸à¸¥à¸µà¸šà¹€à¸¥à¹‡à¸à¸à¸§à¹ˆà¸² à¸‚à¸¢à¸²à¸¢à¹„à¸›à¸”à¹‰à¸²à¸™à¸‹à¹‰à¸²à¸¢' 
            },
            { 
                pos: '-0.04m -0.09m 0.05m', 
                normal: '0m -1m 1m', 
                title:'Gallbladder',
                sub:'à¸–à¸¸à¸‡à¸™à¹‰à¸³à¸”à¸µ',
                desc:'à¹€à¸à¹‡à¸šà¸™à¹‰à¸³à¸”à¸µà¸Šà¹ˆà¸§à¸¢à¸¢à¹ˆà¸­à¸¢à¹„à¸‚à¸¡à¸±à¸™' 
            },
            { 
                pos: '0m -0.02m 0m', 
                normal: '0m -1m 0m', 
                title:'Portal Vein',
                sub:'à¸«à¸¥à¸­à¸”à¹€à¸¥à¸·à¸­à¸”à¸à¸­à¸£à¹Œà¸—à¸±à¸¥',
                desc:'à¸™à¸³à¹€à¸¥à¸·à¸­à¸”à¸ˆà¸²à¸à¸¥à¸³à¹„à¸ªà¹‰à¸¡à¸²à¸à¸£à¸­à¸‡' 
            }
        ]
    }
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DOM REFS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const $  = id => document.getElementById(id);
const viewer      = $('viewer');
const loading     = $('loading');
const infoCard    = $('info-card');
const backdrop    = $('backdrop');
const sidebar     = $('sidebar');
const settingsPnl = $('settings-panel');
const bgAudio     = $('bg-audio');       // ğŸµ Background Music
const organAudio  = $('organ-audio');    // ğŸ”Š Organ Sounds
const cameraVideo = $('camera-video');
const arContainer = $('ar-container');
const arControls  = $('ar-controls');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let currentOrganId  = localStorage.getItem('selectedOrgan') || 'brain';
let currentMode     = 'explore';
let annVisible      = true;
let isFrozen        = false;
let cameraStream    = null;
let currentTrack    = 'ambient';
let selectedDotIdx  = -1;
let gyroSupported   = false;
let deviceOrientation = { alpha: 0, beta: 0, gamma: 0 };
let baseOrientation = { alpha: 0, beta: 0, gamma: 0 };
let organSoundPlaying = false;

// Annotation DOM cache
let annotationDots = [];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOOT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
window.addEventListener('load', async () => {
    // Check gyroscope support
    if (window.DeviceOrientationEvent) {
        if (typeof DeviceOrientationEvent.requestPermission === 'function') {
            gyroSupported = 'pending';
        } else {
            gyroSupported = true;
            window.addEventListener('deviceorientation', handleOrientation);
        }
    }

    arContainer.classList.add('explore-bg');
    cameraVideo.style.display = 'none';

    await loadOrgan(currentOrganId, false);
    markActiveOrgan(currentOrganId);

    // ğŸ”Š à¸•à¸±à¹‰à¸‡à¸„à¹ˆà¸²à¸£à¸°à¸”à¸±à¸šà¹€à¸ªà¸µà¸¢à¸‡à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™
    organAudio.volume = 0.7;  // à¹€à¸ªà¸µà¸¢à¸‡à¸­à¸§à¸±à¸¢à¸§à¸° 70%
    bgAudio.volume = 0.3;     // à¹€à¸à¸¥à¸‡à¸à¸·à¹‰à¸™à¸«à¸¥à¸±à¸‡ 30%

    setTimeout(() => loading.classList.add('out'), 1600);
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GYROSCOPE HANDLING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function handleOrientation(event) {
    deviceOrientation.alpha = event.alpha || 0;
    deviceOrientation.beta  = event.beta  || 0;
    deviceOrientation.gamma = event.gamma || 0;
}

async function requestGyroPermission() {
    if (typeof DeviceOrientationEvent.requestPermission === 'function') {
        try {
            const permission = await DeviceOrientationEvent.requestPermission();
            if (permission === 'granted') {
                gyroSupported = true;
                window.addEventListener('deviceorientation', handleOrientation);
            }
        } catch (err) {
            console.warn('Gyroscope permission denied:', err);
        }
    }
}

function applyGyroRotation() {
    if (!gyroSupported || isFrozen) return;
    
    const deltaAlpha = deviceOrientation.alpha - baseOrientation.alpha;
    const deltaBeta  = deviceOrientation.beta  - baseOrientation.beta;
    
    const theta = deltaAlpha;
    const phi   = 78 + deltaBeta * 0.5;
    
    viewer.cameraOrbit = `${theta}deg ${Math.max(10, Math.min(170, phi))}deg 105%`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ«€ ORGAN LOADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function loadOrgan(id, animate = true) {
    const data = ORGANS[id];
    if (!data) return;
    currentOrganId = id;
    localStorage.setItem('selectedOrgan', id);

    clearAnnotations();
    hideAnnDetail();
    loading.classList.remove('out');

    // à¸«à¸¢à¸¸à¸”à¹€à¸ªà¸µà¸¢à¸‡à¸­à¸§à¸±à¸¢à¸§à¸°à¹€à¸”à¸´à¸¡
    stopOrganSound();
    
    //  à¹€à¸­à¸²à¹à¸­à¸™à¸´à¹€à¸¡à¸Šà¸±à¸™à¹€à¸•à¹‰à¸™à¸­à¸­à¸à¸ˆà¸²à¸ viewer à¸à¹ˆà¸­à¸™
    viewer.classList.remove('heartbeat');

    viewer.addEventListener('load', () => {
        setTimeout(() => {
            loading.classList.add('out');
            updateCard(data);
            if (annVisible) renderAnnotations(data.annotations);
            if (animate) expandCard();
        }, 400);
    }, { once: true });

    viewer.src = data.modelPath;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INFO CARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function updateCard(data) {
    $('card-label').textContent   = 'Anatomy â€” ' + data.nameEN;
    $('card-name-en').textContent = data.nameEN;
    $('card-name-th').textContent = data.nameTH;
    $('card-weight').textContent  = data.weight;
    $('card-desc').textContent    = data.desc;
    
    // à¸­à¸±à¸à¹€à¸”à¸—à¸„à¸§à¸²à¸¡à¸£à¸¹à¹‰à¸™à¹ˆà¸²à¸ªà¸™à¹ƒà¸ˆ
    const factsList = $('facts-list');
    factsList.innerHTML = '';
    data.facts.forEach(fact => {
        const li = document.createElement('li');
        li.textContent = fact;
        factsList.appendChild(li);
    });
}

function expandCard()   { infoCard.classList.remove('collapsed'); }
function collapseCard() { infoCard.classList.add('collapsed'); }

$('card-handle').addEventListener('click', () => {
    infoCard.classList.toggle('collapsed');
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸ”Š ORGAN SOUND CONTROL
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   à¸›à¸¸à¹ˆà¸¡à¹€à¸›à¸´à¸”/à¸›à¸´à¸”à¹€à¸ªà¸µà¸¢à¸‡à¸­à¸§à¸±à¸¢à¸§à¸°à¸—à¸µà¹ˆà¸šà¸±à¸•à¸£à¸‚à¹‰à¸­à¸¡à¸¹à¸¥
*/
$('btn-organ-sound').addEventListener('click', () => {
    if (organSoundPlaying) {
        stopOrganSound();
    } else {
        playOrganSound();
    }
});

// âœ… à¹€à¸¥à¹ˆà¸™à¹€à¸ªà¸µà¸¢à¸‡à¸­à¸§à¸±à¸¢à¸§à¸° + à¹€à¸£à¸´à¹ˆà¸¡à¹à¸­à¸™à¸´à¹€à¸¡à¸Šà¸±à¸™ (à¸–à¹‰à¸²à¸¡à¸µ)
function playOrganSound() {
    const data = ORGANS[currentOrganId];
    if (!data || !data.soundUrl) {
        console.warn('à¹„à¸¡à¹ˆà¸¡à¸µà¹€à¸ªà¸µà¸¢à¸‡à¸ªà¸³à¸«à¸£à¸±à¸šà¸­à¸§à¸±à¸¢à¸§à¸°à¸™à¸µà¹‰');
        return;
    }
    
    organAudio.src = data.soundUrl;
    organAudio.play().then(() => {
        organSoundPlaying = true;
        $('btn-organ-sound').classList.add('playing');
        
        // âœ… à¸–à¹‰à¸²à¹€à¸›à¹‡à¸™à¸«à¸±à¸§à¹ƒà¸ˆ à¹ƒà¸«à¹‰à¹€à¸•à¹‰à¸™à¸•à¸²à¸¡à¸ˆà¸±à¸‡à¸«à¸§à¸°!
        if (data.hasAnimation && currentOrganId === 'heart') {
            viewer.classList.add('heartbeat');
        }
    }).catch(err => {
        console.warn('à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸¥à¹ˆà¸™à¹€à¸ªà¸µà¸¢à¸‡à¹„à¸”à¹‰:', err);
    });
}

// âœ… à¸«à¸¢à¸¸à¸”à¹€à¸ªà¸µà¸¢à¸‡à¸­à¸§à¸±à¸¢à¸§à¸° + à¸«à¸¢à¸¸à¸”à¹à¸­à¸™à¸´à¹€à¸¡à¸Šà¸±à¸™
function stopOrganSound() {
    organAudio.pause();
    organAudio.currentTime = 0;
    organSoundPlaying = false;
    $('btn-organ-sound').classList.remove('playing');
    
    // âœ… à¸«à¸¢à¸¸à¸”à¹à¸­à¸™à¸´à¹€à¸¡à¸Šà¸±à¸™à¹€à¸•à¹‰à¸™
    viewer.classList.remove('heartbeat');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ANNOTATION DOTS - 3D LOCKED
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderAnnotations(anns) {
    clearAnnotations();
    annotationDots = [];
    
    anns.forEach((ann, idx) => {
        const hotspot = document.createElement('button');
        hotspot.slot = `hotspot-${idx}`;
        hotspot.className = 'ann-hotspot';
        hotspot.setAttribute('data-position', ann.pos);
        hotspot.setAttribute('data-normal', ann.normal);
        hotspot.setAttribute('data-idx', idx);
        
        const dot = document.createElement('div');
        dot.className = 'ann-dot-core';
        hotspot.appendChild(dot);
        
        hotspot.addEventListener('click', (e) => {
            e.stopPropagation();
            selectAnnotation(idx, ann);
        });
        
        viewer.appendChild(hotspot);
        annotationDots.push({ element: hotspot, data: ann });
    });
}

function clearAnnotations() {
    viewer.querySelectorAll('.ann-hotspot').forEach(el => el.remove());
    annotationDots = [];
    selectedDotIdx = -1;
}

function selectAnnotation(idx, ann) {
    viewer.querySelectorAll('.ann-hotspot').forEach(h => h.classList.remove('selected'));
    
    const hotspot = viewer.querySelector(`.ann-hotspot[data-idx="${idx}"]`);
    if (hotspot) hotspot.classList.add('selected');
    selectedDotIdx = idx;

    $('ann-d-title').textContent = ann.title;
    $('ann-d-sub').textContent   = ann.sub;
    $('ann-d-desc').textContent  = ann.desc;
    $('ann-detail').classList.add('show');
    expandCard();
}

function hideAnnDetail() {
    $('ann-detail').classList.remove('show');
    viewer.querySelectorAll('.ann-hotspot').forEach(h => h.classList.remove('selected'));
    selectedDotIdx = -1;
}

viewer.addEventListener('click', () => {
    if (selectedDotIdx !== -1) hideAnnDetail();
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODE SWITCHING â€” EXPLORE / AR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.querySelectorAll('.mode-tab').forEach(tab => {
    tab.addEventListener('click', () => {
        const mode = tab.dataset.mode;
        if (mode === currentMode) return;
        setMode(mode);
    });
});

async function setMode(mode) {
    currentMode = mode;

    document.querySelectorAll('.mode-tab').forEach(t => {
        t.classList.toggle('active', t.dataset.mode === mode);
    });

    if (mode === 'ar') {
        if (gyroSupported === 'pending') {
            await requestGyroPermission();
        }
        
        baseOrientation = { ...deviceOrientation };
        
        await startCamera();
        arContainer.classList.remove('explore-bg');
        cameraVideo.style.display = 'block';
        
        viewer.setAttribute('touch-action', 'none');
        viewer.setAttribute('disable-pan', '');
        
        arControls.classList.add('visible');
        isFrozen = false;
        $('btn-freeze').classList.remove('frozen');
        
        if (gyroSupported === true) {
            startGyroLoop();
        }
    } else {
        stopCamera();
        stopGyroLoop();
        cameraVideo.style.display = 'none';
        arContainer.classList.add('explore-bg');
        
        viewer.removeAttribute('disable-pan');
        viewer.setAttribute('touch-action', 'pan-y');
        
        arControls.classList.remove('visible');
        isFrozen = false;
        viewer.autoRotate = false;
        $('tog-rotate').checked = false;
    }
}

let gyroLoopId = null;
function startGyroLoop() {
    stopGyroLoop();
    function loop() {
        applyGyroRotation();
        gyroLoopId = requestAnimationFrame(loop);
    }
    loop();
}

function stopGyroLoop() {
    if (gyroLoopId) {
        cancelAnimationFrame(gyroLoopId);
        gyroLoopId = null;
    }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CAMERA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function startCamera() {
    if (cameraStream) return;
    try {
        cameraStream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode: { ideal: 'environment' }, width:{ ideal:1920 }, height:{ ideal:1080 } },
            audio: false
        });
        cameraVideo.srcObject = cameraStream;
        await cameraVideo.play();
    } catch(err) {
        console.warn('[Camera] Access denied or not available:', err);
        arContainer.classList.add('explore-bg');
    }
}

function stopCamera() {
    if (!cameraStream) return;
    cameraStream.getTracks().forEach(t => t.stop());
    cameraStream = null;
    cameraVideo.srcObject = null;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AR CONTROLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
$('btn-zoom-in').addEventListener('click', () => {
    const current = viewer.cameraOrbit;
    const parts = current ? current.split(' ') : ['0deg','78deg','105%'];
    const radiusPart = parts[2] || '105%';
    const numMatch = radiusPart.match(/([0-9.]+)(.*)/);
    if (numMatch) {
        const newVal = Math.max(20, parseFloat(numMatch[1]) * 0.85);
        parts[2] = newVal.toFixed(1) + numMatch[2];
        viewer.cameraOrbit = parts.join(' ');
    }
});

$('btn-zoom-out').addEventListener('click', () => {
    const current = viewer.cameraOrbit;
    const parts = current ? current.split(' ') : ['0deg','78deg','105%'];
    const radiusPart = parts[2] || '105%';
    const numMatch = radiusPart.match(/([0-9.]+)(.*)/);
    if (numMatch) {
        const newVal = Math.min(400, parseFloat(numMatch[1]) * 1.18);
        parts[2] = newVal.toFixed(1) + numMatch[2];
        viewer.cameraOrbit = parts.join(' ');
    }
});

$('btn-freeze').addEventListener('click', () => {
    isFrozen = !isFrozen;
    $('btn-freeze').classList.toggle('frozen', isFrozen);
    
    if (isFrozen) {
        viewer.cameraControls = false;
        stopGyroLoop();
    } else {
        viewer.cameraControls = true;
        if (currentMode === 'ar' && gyroSupported === true) {
            baseOrientation = { ...deviceOrientation };
            startGyroLoop();
        }
    }
});

$('btn-reset-ar').addEventListener('click', () => {
    viewer.cameraOrbit = '0deg 78deg 105%';
    viewer.fieldOfView = 'auto';
    if (currentMode === 'ar' && gyroSupported === true) {
        baseOrientation = { ...deviceOrientation };
    }
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SIDEBAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openSidebar()  { sidebar.classList.add('open'); backdrop.classList.add('on'); }
function closeSidebar() { sidebar.classList.remove('open'); backdrop.classList.remove('on'); settingsPnl.classList.remove('open'); }

$('btn-menu').addEventListener('click', () => {
    settingsPnl.classList.remove('open');
    openSidebar();
});
$('close-sidebar').addEventListener('click', closeSidebar);
$('btn-home').addEventListener('click', () => { window.location.href = 'home.html'; });

document.querySelectorAll('.organ-item').forEach(item => {
    item.addEventListener('click', () => {
        const id = item.dataset.organ;
        if (id === currentOrganId) { closeSidebar(); return; }
        markActiveOrgan(id);
        loadOrgan(id);
        closeSidebar();
    });
});

function markActiveOrgan(id) {
    document.querySelectorAll('.organ-item').forEach(el => {
        el.classList.toggle('active', el.dataset.organ === id);
    });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SETTINGS PANEL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
$('btn-settings').addEventListener('click', () => {
    sidebar.classList.remove('open');
    settingsPnl.classList.toggle('open');
    backdrop.classList.toggle('on', settingsPnl.classList.contains('open'));
});
$('close-settings').addEventListener('click', () => {
    settingsPnl.classList.remove('open');
    backdrop.classList.remove('on');
});
backdrop.addEventListener('click', closeSidebar);

$('tog-rotate').addEventListener('change', function() {
    viewer.autoRotate = this.checked;
    viewer.autoRotateDelay = 600;
});

$('tog-shadow').addEventListener('change', function() {
    viewer.shadowIntensity = this.checked ? 1 : 0;
});

$('tog-ann').addEventListener('change', function() {
    annVisible = this.checked;
    if (annVisible) {
        renderAnnotations(ORGANS[currentOrganId].annotations);
    } else {
        clearAnnotations();
        hideAnnDetail();
    }
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ğŸµ BACKGROUND MUSIC CONTROLS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
*/
$('tog-music').addEventListener('change', function() {
    if (this.checked) {
        // à¸–à¹‰à¸²à¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µ src à¹ƒà¸«à¹‰à¹‚à¸«à¸¥à¸”à¹€à¸à¸¥à¸‡ ambient à¸à¹ˆà¸­à¸™
        if (!bgAudio.src || bgAudio.src === location.href) {
            setTrack(currentTrack);
        }
        bgAudio.play().catch(err => {
            console.warn('à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸¥à¹ˆà¸™à¹€à¸à¸¥à¸‡à¹„à¸”à¹‰:', err);
        });
    } else {
        bgAudio.pause();
    }
});

// à¸›à¸£à¸±à¸šà¸£à¸°à¸”à¸±à¸šà¹€à¸ªà¸µà¸¢à¸‡à¹€à¸à¸¥à¸‡à¸à¸·à¹‰à¸™à¸«à¸¥à¸±à¸‡
$('vol-slider').addEventListener('input', function() {
    bgAudio.volume = this.value / 100;
    $('vol-label').textContent = this.value + '%';
});

// à¸›à¸£à¸±à¸šà¸£à¸°à¸”à¸±à¸šà¹€à¸ªà¸µà¸¢à¸‡à¸­à¸§à¸±à¸¢à¸§à¸°
$('organ-vol-slider').addEventListener('input', function() {
    organAudio.volume = this.value / 100;
    $('organ-vol-label').textContent = this.value + '%';
});

// à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹€à¸à¸¥à¸‡à¸à¸·à¹‰à¸™à¸«à¸¥à¸±à¸‡
document.querySelectorAll('.m-opt').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.m-opt').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        setTrack(btn.dataset.track);
    });
});

// âš ï¸ à¸Ÿà¸±à¸‡à¸à¹Œà¸Šà¸±à¸™à¹‚à¸«à¸¥à¸”à¹€à¸à¸¥à¸‡à¸•à¸²à¸¡à¹‚à¸«à¸¡à¸”à¸—à¸µà¹ˆà¹€à¸¥à¸·à¸­à¸
function setTrack(id) {
    currentTrack = id;
    const wasPlaying = !bgAudio.paused;
    bgAudio.src = MUSIC[id]; // ğŸµ à¸”à¸¶à¸‡ URL à¸ˆà¸²à¸ MUSIC object
    if (wasPlaying) {
        bgAudio.play().catch(err => {
            console.warn('à¹„à¸¡à¹ˆà¸ªà¸²à¸¡à¸²à¸£à¸–à¹€à¸¥à¹ˆà¸™à¹€à¸à¸¥à¸‡à¹„à¸”à¹‰:', err);
        });
    }
}

$('btn-reset-cam').addEventListener('click', () => {
    viewer.cameraOrbit = '0deg 78deg 105%';
    viewer.fieldOfView = 'auto';
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   KEYBOARD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
document.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
        closeSidebar();
        settingsPnl.classList.remove('open');
        backdrop.classList.remove('on');
    }
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESIZE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let resizeTimer;
window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => {
        if (annVisible && currentOrganId) {
            renderAnnotations(ORGANS[currentOrganId].annotations);
        }
    }, 200);
});
</script>

</body>
</html>
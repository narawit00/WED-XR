<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>โมเดลหัวใจมนุษย์ 3D XR (Navigation)</title>
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            background: radial-gradient(circle at 50% 50%, #1a1a2e 0%, #0c0c1a 100%);
            font-family: 'Sarabun', sans-serif;
            user-select: none;
        }
        #info {
            position: absolute;
            top: 20px;
            width: 100%;
            text-align: center;
            color: #fff;
            pointer-events: none;
            z-index: 10;
            text-shadow: 2px 2px 6px rgba(0,0,0,0.9);
            transition: opacity 0.5s;
        }
        h1 { margin: 0; font-weight: 700; color: #ff6b6b; font-size: 1.8rem;}
        p { margin: 5px; font-size: 1rem; color: #ddd; }
        canvas { display: block; outline: none; }
        
        #controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 10px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            transition: opacity 0.5s;
        }
        #controls button {
            display: block;
            width: 100%;
            margin: 5px 0;
            padding: 10px;
            background: #c91e3a;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            pointer-events: auto;
        }
        #controls button:hover {
            background: #ff4757;
            transform: scale(1.05);
        }

        /* --- UI ส่วนล่าง (Marker Navigation) --- */
        #bottom-ui-container {
            position: absolute;
            bottom: 20px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
            z-index: 1000;
            transition: opacity 0.3s;
        }

        #info-panel {
            background: rgba(0, 0, 0, 0.95);
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            width: 60%;
            max-width: 500px;
            text-align: center;
            color: white;
            border: 1px solid #ff6b6b;
            pointer-events: auto;
            margin: 0 15px;
            position: relative;
        }
        
        .nav-btn {
            background: rgba(0, 0, 0, 0.6);
            color: #ff6b6b;
            border: 2px solid #ff6b6b;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            pointer-events: auto;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
        }
        .nav-btn:hover {
            background: #ff6b6b;
            color: white;
            transform: scale(1.1);
        }
        .nav-btn:active { transform: scale(0.9); }

        #info-panel h2 { margin: 0 0 10px 0; color: #ff6b6b; font-size: 24px; font-weight: 600; }
        #info-panel p { margin: 8px 0; color: #eee; font-size: 16px; line-height: 1.6; }

        /* --- CSS ปุ่มเปลี่ยนฉาก (Scene Navigation) --- */
        .scene-nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.3);
            font-size: 40px;
            padding: 15px 20px;
            cursor: pointer;
            z-index: 2000;
            border-radius: 12px;
            transition: all 0.3s ease;
            backdrop-filter: blur(4px);
        }
        .scene-nav-btn:hover {
            background: rgba(255, 107, 107, 0.8);
            color: white;
            border-color: transparent;
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 0 15px rgba(255, 107, 107, 0.6);
        }
        .prev-scene { left: 20px; }
        .next-scene { right: 20px; }

        /* Marker Styles */
        #marker-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 100; }
        .marker-container { position: absolute; cursor: pointer; pointer-events: auto; transition: all 0.3s; z-index: 101; }
        .marker-container:hover { transform: scale(1.2); }
        .marker-number {
            width: 36px; height: 36px; border-radius: 50%;
            background: linear-gradient(135deg, #ff6b6b, #c91e3a);
            color: white; font-weight: bold; font-size: 18px;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid white;
            box-shadow: 0 0 12px rgba(255,107,107,0.7);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        #legend {
            position: absolute; top: 50%; left: 20px; transform: translateY(-50%);
            background: rgba(0,0,0,0.8); padding: 15px; border-radius: 10px;
            color: white; font-size: 12px; z-index: 1000;
            backdrop-filter: blur(10px); transition: opacity 0.5s;
        }
        #legend h3 { margin: 0 0 10px 0; color: #ff6b6b; font-size: 14px; }
        #legend div { margin: 5px 0; }
        #legend span { display: inline-block; width: 20px; height: 3px; margin-right: 5px; vertical-align: middle; }
        #ar-button { background: #2ed573 !important; position: absolute; top: 20px; left: 20px; z-index: 1001; display: none; }
        .hidden { opacity: 0 !important; pointer-events: none !important; }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>

    <div id="info">
        <h1>โมเดลหัวใจมนุษย์ 3D XR</h1>
        <p>คลิกซ้าย-ขวาริมจอเพื่อเปลี่ยนโมเดล | ปุ่มล่างเพื่อดูข้อมูล</p>
    </div>

    <button class="scene-nav-btn prev-scene" onclick="window.location.href='lungs.html'" title="ไปโมเดลปอด">❮</button>
    <button class="scene-nav-btn next-scene" onclick="window.location.href='lungs.html'" title="ไปโมเดลปอด">❯</button>

    <button id="ar-button" onclick="enterAR()">เข้าโหมด AR</button>

    <div id="controls">
        <button onclick="resetView()">รีเซ็ตมุมมอง</button>
        <button onclick="toggleRotation()">หยุด/เริ่มหมุนอัตโนมัติ</button>
        <button onclick="toggleLabels()">เปิด/ปิดลูกศรชี้</button>
    </div>

    <div id="legend">
        <h3>สีของตัวชี้</h3>
        <div><span style="background: #ff6b6b;"></span>เส้นเลือดแดง</div>
        <div><span style="background: #4ecdc4;"></span>เส้นเลือดดำ</div>
        <div><span style="background: #ffe66d;"></span>ห้องหัวใจ</div>
        <div><span style="background: #a8e6cf;"></span>เส้นเลือดเลี้ยงหัวใจ</div>
    </div>

    <div id="bottom-ui-container">
        <button class="nav-btn" onclick="navigateMarker(-1)">❮</button>
        <div id="info-panel">
            <h2>หัวใจมนุษย์</h2>
            <p>คลิกที่ลูกศรซ้าย-ขวา หรือกดตัวเลขเพื่อดูข้อมูล</p>
            <p style="color: #888; font-size: 12px;">* มีจุดทั้งหมด 12 จุด</p>
        </div>
        <button class="nav-btn" onclick="navigateMarker(1)">❯</button>
    </div>

    <canvas id="marker-canvas"></canvas>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <script>
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0a0a1a);
        scene.fog = new THREE.Fog(0x0a0a1a, 8, 30);
        
        const camera = new THREE.PerspectiveCamera(35, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.set(0, 1.5, 12);
        
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.xr.enabled = true;
        document.body.appendChild(renderer.domElement);
        
        const markerCanvas = document.getElementById('marker-canvas');
        const markerCtx = markerCanvas.getContext('2d');
        markerCanvas.width = window.innerWidth;
        markerCanvas.height = window.innerHeight;
        
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(ambientLight);
        
        const mainLight = new THREE.DirectionalLight(0xffffff, 1.5);
        mainLight.position.set(6, 10, 6);
        mainLight.castShadow = true;
        scene.add(mainLight);
        
        const fillLight = new THREE.PointLight(0xffffff, 0.8, 50);
        fillLight.position.set(0, 0, 10);
        scene.add(fillLight);
        
        const heartGroup = new THREE.Group();
        const heartMaterial = new THREE.MeshStandardMaterial({ color: 0xcc2e3e, roughness: 0.8, metalness: 0.02 });
        
        const lvGeo = new THREE.SphereGeometry(1.6, 64, 64);
        const leftVentricle = new THREE.Mesh(lvGeo, heartMaterial);
        leftVentricle.scale.set(1, 1.3, 0.9); leftVentricle.position.set(-0.3, 0, 0);
        
        const rvGeo = new THREE.SphereGeometry(1.3, 64, 64);
        const rightVentricle = new THREE.Mesh(rvGeo, heartMaterial);
        rightVentricle.scale.set(0.7, 1.1, 0.7); rightVentricle.position.set(0.7, -0.1, 0.2);

        const la = new THREE.Mesh(new THREE.SphereGeometry(0.8,32,32), heartMaterial);
        la.scale.set(0.8,0.5,0.8); la.position.set(-0.4, 2.1, -0.4);
        const ra = new THREE.Mesh(new THREE.SphereGeometry(0.75,32,32), heartMaterial);
        ra.scale.set(0.8,0.5,0.8); ra.position.set(0.5, 2.1, -0.3);
        
        const arteryMat = new THREE.MeshStandardMaterial({ color: 0xcc2e3e, roughness: 0.6 });
        const veinMat = new THREE.MeshStandardMaterial({ color: 0x4a7cdd, roughness: 0.6 });
        
        const aortaCurve = new THREE.CatmullRomCurve3([new THREE.Vector3(0,2.6,0), new THREE.Vector3(0,3.4,0), new THREE.Vector3(0.4,4.0,-0.4), new THREE.Vector3(1.0,4.3,-1.0)]);
        const aorta = new THREE.Mesh(new THREE.TubeGeometry(aortaCurve, 32, 0.32, 16, false), arteryMat);
        
        const pulmoCurve = new THREE.CatmullRomCurve3([new THREE.Vector3(0.2,2.4,-0.1), new THREE.Vector3(0.7,3.0,-0.7), new THREE.Vector3(1.3,3.2,-1.3)]);
        const pulmonary = new THREE.Mesh(new THREE.TubeGeometry(pulmoCurve, 32, 0.28, 16, false), arteryMat);
        
        const svc = new THREE.Mesh(new THREE.CylinderGeometry(0.2, 0.24, 2.2, 32), veinMat);
        svc.position.set(-0.6, 2.8, 0.3); svc.rotation.z = -0.2;

        heartGroup.add(leftVentricle, rightVentricle, la, ra, aorta, pulmonary, svc);
        heartGroup.rotation.z = -0.3;
        scene.add(heartGroup);

        const fixedLabelPositions = {
            1: { x: 85, y: 15 }, 2: { x: 75, y: 25 }, 3: { x: 15, y: 20 },
            4: { x: 50, y: 85 }, 5: { x: 60, y: 50 }, 6: { x: 80, y: 55 },
            7: { x: 30, y: 35 }, 8: { x: 70, y: 35 }, 9: { x: 20, y: 30 },
            10: { x: 85, y: 30 }, 11: { x: 25, y: 60 }, 12: { x: 90, y: 45 }
        };
        
        const markerData = [
            { id: 1, name: "Arch of Aorta", pos: { x: 0.6, y: 4.2, z: -0.8 }, color: "#ff6b6b", type: "artery", desc: "โค้งของเอาตา แยกเป็นเส้นเลือดส่งเลือดไปแขน ลำคอ และสมอง" },
            { id: 2, name: "Pulmonary Trunk", pos: { x: 0.9, y: 2.8, z: -0.8 }, color: "#ff6b6b", type: "artery", desc: "ลำต้นหลอดเลือดแดงปอด ส่งเลือดขาดออกซิเจนไปยังปอดทั้งสองข้าง" },
            { id: 3, name: "Superior Vena Cava", pos: { x: -0.6, y: 3.5, z: 0.4 }, color: "#4ecdc4", type: "vein", desc: "หลอดเลือดดำใหญ่ส่วนบน รับเลือดจากศีรษะ ลำคอ และแขนทั้งสองกลับสู่หัวใจ" },
            { id: 4, name: "Inferior Vena Cava", pos: { x: 0, y: -1.9, z: 0 }, color: "#4ecdc4", type: "vein", desc: "หลอดเลือดดำใหญ่ส่วนล่าง รับเลือดจากลำตัวและขาทั้งสองกลับสู่หัวใจ" },
            { id: 5, name: "Left Ventricle", pos: { x: -0.5, y: 0, z: 0 }, color: "#ffe66d", type: "chamber", desc: "ห้องล่างซ้าย - ห้องสูบฉีดหลัก ผนังหนาที่สุด (10-15 มม.) ส่งเลือดออกซิเจนไปทั่วร่างกาย" },
            { id: 6, name: "Right Ventricle", pos: { x: 0.8, y: -0.2, z: 0.3 }, color: "#ffe66d", type: "chamber", desc: "ห้องล่างขวา - สูบฉีดเลือดขาดออกซิเจนไปยังปอดเพื่อรับออกซิเจน" },
            { id: 7, name: "Left Atrium", pos: { x: -0.4, y: 2.1, z: -0.4 }, color: "#ffe66d", type: "chamber", desc: "ห้องบนซ้าย - รับเลือดที่มีออกซิเจนจากปอดกลับเข้าสู่หัวใจ" },
            { id: 8, name: "Right Atrium", pos: { x: 0.6, y: 2.1, z: -0.3 }, color: "#ffe66d", type: "chamber", desc: "ห้องบนขวา - รับเลือดดำจากทั่วร่างกายก่อนส่งไปปอด" },
            { id: 9, name: "Left Auricle", pos: { x: -0.9, y: 2.3, z: 0.2 }, color: "#ffe66d", type: "chamber", desc: "หูหัวใจซ้าย - ส่วนขยายของห้องบนซ้าย ช่วยเพิ่มปริมาตร" },
            { id: 10, name: "Right Auricle", pos: { x: 1.1, y: 2.0, z: 0.3 }, color: "#ffe66d", type: "chamber", desc: "หูหัวใจขวา - ส่วนขยายของห้องบนขวา มีลักษณะหูรูด" },
            { id: 11, name: "LAD", pos: { x: -0.2, y: 0, z: 1.2 }, color: "#a8e6cf", type: "coronary", desc: "เส้นเลือดเลี้ยงหัวใจ LAD - เส้นสำคัญที่เลี้ยงกล้ามเนื้อหัวใจส่วนหน้าและกั้นกลาง" },
            { id: 12, name: "RCA", pos: { x: 1.0, y: 0, z: 0.5 }, color: "#a8e6cf", type: "coronary", desc: "เส้นเลือดเลี้ยงหัวใจ RCA - แยกเลี้ยงห้องล่างขวา ห้องบนขวา และระบบไฟฟ้าหัวใจ" }
        ];

        let showLabels = true;
        let activeMarker = null;
        let currentMarkerIndex = -1;
        let isARMode = false;
        let autoHideTimer = null;
        let uiVisible = true;
        const markerElements = {};
        
        markerData.forEach((data, index) => {
            const container = document.createElement('div');
            container.className = 'marker-container';
            const number = document.createElement('div');
            number.className = 'marker-number';
            number.style.background = `linear-gradient(135deg, ${data.color}, #c91e3a)`;
            number.textContent = data.id;
            container.appendChild(number);
            container.style.display = 'none';
            document.body.appendChild(container);
            
            const fixedPos = fixedLabelPositions[data.id];
            container.style.left = `${fixedPos.x}%`;
            container.style.top = `${fixedPos.y}%`;
            container.style.transform = 'translate(-50%, -50%)';
            markerElements[data.id] = { container, data, index };
            container.addEventListener('click', () => { selectMarkerByIndex(index); });
        });

        // --- Marker Navigation (เลื่อนตัวหนังสือ วนลูป) ---
        function navigateMarker(direction) {
            let newIndex = currentMarkerIndex + direction;
            if (newIndex < 0) newIndex = markerData.length - 1;
            if (newIndex >= markerData.length) newIndex = 0;
            selectMarkerByIndex(newIndex);
        }
        window.navigateMarker = navigateMarker;

        function selectMarkerByIndex(index) {
            currentMarkerIndex = index;
            const data = markerData[index];
            clearTimeout(autoHideTimer);
            showInfo(data);
            showUI();
            autoHideUI();
        }

        function showInfo(data) {
            const panel = document.getElementById('info-panel');
            panel.innerHTML = `
                <h2>${data.id}. ${data.name}</h2>
                <p>${data.desc}</p>
                <p style="color: #999; font-size: 12px; margin-top: 10px;">ประเภท: ${getTypeLabel(data.type)}</p>
                <div style="font-size:12px; margin-top:5px; color:#ff6b6b;">(${currentMarkerIndex + 1} / ${markerData.length})</div>
            `;
            Object.values(markerElements).forEach(el => {
                el.container.style.filter = 'brightness(1)';
                el.container.style.transform = 'translate(-50%, -50%) scale(1)';
            });
            const el = markerElements[data.id];
            el.container.style.filter = 'brightness(1.5) drop-shadow(0 0 10px #fff)';
            el.container.style.transform = 'translate(-50%, -50%) scale(1.3)';
            activeMarker = data.id;
        }

        function getTypeLabel(type) {
            const labels = { artery: 'เส้นเลือดแดง', vein: 'เส้นเลือดดำ', chamber: 'ห้องหัวใจ', coronary: 'เส้นเลือดเลี้ยงหัวใจ' };
            return labels[type] || 'อื่นๆ';
        }

        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowRight') navigateMarker(1);
            if (e.key === 'ArrowLeft') navigateMarker(-1);
        });

        function updateMarkers() {
            markerCtx.clearRect(0, 0, markerCanvas.width, markerCanvas.height);
            if (!showLabels) {
                Object.values(markerElements).forEach(el => el.container.style.display = 'none');
                return;
            }
            markerData.forEach(data => {
                const vector = new THREE.Vector3(data.pos.x, data.pos.y, data.pos.z);
                vector.applyMatrix4(heartGroup.matrixWorld);
                vector.project(camera);
                if (vector.z > 1) {
                    markerElements[data.id].container.style.display = 'none';
                    return;
                }
                const endX = (vector.x * 0.5 + 0.5) * window.innerWidth;
                const endY = (-vector.y * 0.5 + 0.5) * window.innerHeight;
                
                const fixedPos = fixedLabelPositions[data.id];
                const startX = (fixedPos.x / 100) * window.innerWidth;
                const startY = (fixedPos.y / 100) * window.innerHeight;

                const worldPos = new THREE.Vector3(data.pos.x, data.pos.y, data.pos.z);
                worldPos.applyMatrix4(heartGroup.matrixWorld);
                const distance = camera.position.distanceTo(worldPos);

                markerCtx.strokeStyle = data.color;
                markerCtx.lineWidth = 3;
                markerCtx.globalAlpha = Math.max(0.3, 1 - distance / 15);
                markerCtx.beginPath(); markerCtx.moveTo(startX, startY); markerCtx.lineTo(endX, endY); markerCtx.stroke();
                markerCtx.fillStyle = data.color; markerCtx.beginPath(); markerCtx.arc(endX, endY, 5, 0, Math.PI * 2); markerCtx.fill();
                
                const markerEl = markerElements[data.id].container;
                markerEl.style.display = 'block';
                markerEl.style.opacity = Math.max(0.4, 1 - distance / 12);
            });
        }

        function autoHideUI() {
            clearTimeout(autoHideTimer);
            autoHideTimer = setTimeout(() => { if (!isARMode) hideUI(); }, 5000);
        }
        function hideUI() {
            uiVisible = false;
            document.getElementById('info').classList.add('hidden');
            document.getElementById('controls').classList.add('hidden');
            document.getElementById('legend').classList.add('hidden');
            document.getElementById('bottom-ui-container').classList.add('hidden');
            document.querySelectorAll('.scene-nav-btn').forEach(b => b.classList.add('hidden')); // ซ่อนปุ่มข้างด้วย
        }
        function showUI() {
            uiVisible = true;
            document.getElementById('info').classList.remove('hidden');
            document.getElementById('controls').classList.remove('hidden');
            document.getElementById('legend').classList.remove('hidden');
            document.getElementById('bottom-ui-container').classList.remove('hidden');
            document.querySelectorAll('.scene-nav-btn').forEach(b => b.classList.remove('hidden')); // แสดงปุ่มข้าง
        }
        function resetAutoHide() {
            clearTimeout(autoHideTimer);
            if (!uiVisible) showUI();
            autoHideUI();
        }

        async function checkARSupport() { if ('xr' in navigator) { try { const s = await navigator.xr.isSessionSupported('immersive-ar'); if(s) document.getElementById('ar-button').style.display='block'; } catch(e){} } }
        checkARSupport();
        async function enterAR() {
            if (!navigator.xr) return;
            const session = await navigator.xr.requestSession('immersive-ar', { requiredFeatures: ['hit-test'] });
            renderer.xr.setSession(session); isARMode = true;
            heartGroup.scale.set(0.15,0.15,0.15); heartGroup.position.set(0,0,-1);
            document.getElementById('info').style.display='none'; document.getElementById('legend').style.display='none';
            document.querySelectorAll('.scene-nav-btn').forEach(b => b.style.display='none');
            session.addEventListener('end', () => { 
                isARMode=false; heartGroup.scale.set(1,1,1); heartGroup.position.set(0,0,0); 
                document.getElementById('info').style.display='block'; document.getElementById('legend').style.display='block'; 
                document.querySelectorAll('.scene-nav-btn').forEach(b => b.style.display='block');
            });
        }

        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        let time = 0; let rotating = true;
        ['click','touchstart','mousemove'].forEach(e => document.addEventListener(e, resetAutoHide));
        window.toggleRotation = () => { rotating = !rotating; resetAutoHide(); };
        window.resetView = () => { 
            camera.position.set(0,1.5,12); controls.reset(); currentMarkerIndex = -1;
            document.getElementById('info-panel').innerHTML = `<h2>หัวใจมนุษย์</h2><p>คลิกที่ลูกศรซ้าย-ขวา เพื่อดูข้อมูล</p>`;
            Object.values(markerElements).forEach(el => el.container.style.filter='brightness(1)');
            resetAutoHide(); 
        };
        window.toggleLabels = () => { showLabels = !showLabels; resetAutoHide(); };
        window.enterAR = enterAR;

        function animate() {
            requestAnimationFrame(animate);
            time += 0.01;
            const beat = Math.sin(time * 3) * 0.5 + 0.5;
            const scale = isARMode ? 0.15 : (1.0 + (beat * 0.04));
            heartGroup.scale.set(scale, scale, scale);
            if(rotating && !isARMode) heartGroup.rotation.y += 0.004;
            controls.update();
            renderer.render(scene, camera);
            updateMarkers();
        }
        
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            markerCanvas.width = window.innerWidth;
            markerCanvas.height = window.innerHeight;
        });

        selectMarkerByIndex(0);
        animate();
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>Brain 3D Model XR - 360¬∞ Interactive</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            overflow: hidden; 
            background: radial-gradient(circle at center, #2a2a4a 0%, #0a0a1a 100%);
            font-family: 'Sarabun', sans-serif;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            touch-action: none;
        }
        canvas { display: block; width: 100vw; height: 100vh; }
        
        /* Loading Screen - Bilingual */
        #loading {
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 5000;
            transition: opacity 0.8s ease;
        }
        .loader-brain {
            width: 100px;
            height: 100px;
            border: 5px solid rgba(255, 204, 204, 0.2);
            border-top-color: #ffcccc;
            border-radius: 50%;
            animation: brainSpin 1.5s cubic-bezier(0.5, 0.1, 0.5, 0.9) infinite;
            margin-bottom: 25px;
            position: relative;
        }
        .loader-brain::before {
            content: '';
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            bottom: 10px;
            border: 3px solid rgba(255, 204, 204, 0.1);
            border-top-color: #ff9999;
            border-radius: 50%;
            animation: brainSpin 2s linear infinite reverse;
        }
        @keyframes brainSpin {
            0% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(180deg) scale(1.05); }
            100% { transform: rotate(360deg) scale(1); }
        }
        #loading-text {
            color: #ffcccc;
            font-size: 1.3rem;
            font-weight: 600;
            text-shadow: 0 2px 10px rgba(0,0,0,0.7);
            text-align: center;
        }
        #loading-detail {
            color: #aaa;
            font-size: 0.9rem;
            margin-top: 8px;
            font-weight: 400;
        }
        
        /* Main UI - Glassmorphism */
        .main-ui {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            pointer-events: none;
            z-index: 1000;
        }
        .ui-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 18px;
            padding: 15px 20px;
            color: white;
            pointer-events: auto;
            transition: all 0.3s ease;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        .ui-card:hover { background: rgba(255, 255, 255, 0.12); }
        
        #title-section h1 {
            font-size: clamp(1rem, 3vw, 1.5rem);
            font-weight: 700;
            margin-bottom: 5px;
            color: #ffcccc;
            text-shadow: 0 2px 8px rgba(0,0,0,0.5);
        }
        #status-text {
            font-size: clamp(0.75rem, 2vw, 0.9rem);
            color: #aaa;
        }
        
        /* Controls */
        .control-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 10px 16px;
            margin: 5px 0;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: block;
            width: 100%;
            text-align: left;
            backdrop-filter: blur(5px);
        }
        .control-btn:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateX(5px);
        }
        .control-btn.active {
            background: rgba(46, 213, 115, 0.25);
            border-color: #2ed573;
            color: #2ed573;
        }
        
        /* Info Panel */
        #info-panel {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(120px);
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 204, 204, 0.3);
            border-radius: 20px;
            padding: 20px 25px;
            max-width: 450px;
            width: 85%;
            color: white;
            pointer-events: none;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }
        #info-panel.visible {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }
        #info-panel h2 {
            color: #ffcccc;
            margin-bottom: 10px;
            font-size: clamp(1.1rem, 2.5vw, 1.4rem);
            font-weight: 700;
        }
        #info-panel p {
            font-size: clamp(0.8rem, 2vw, 0.95rem);
            line-height: 1.6;
            color: #eee;
        }
        .marker-counter {
            font-size: 0.75rem;
            color: #ffcccc;
            margin-top: 8px;
            font-weight: 600;
        }
        
        /* FAB Controls */
        .fab-container {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 1000;
            pointer-events: auto;
        }
        .fab {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            color: white;
            font-size: 22px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.25);
        }
        .fab:hover { transform: scale(1.1) rotate(5deg); background: rgba(255, 255, 255, 0.15); }
        .fab.active { background: rgba(46, 213, 115, 0.25); border-color: #2ed573; color: #2ed573; }
        
        /* Instructions Overlay */
        #instructions {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s ease;
            backdrop-filter: blur(10px);
        }
        #instructions.visible {
            opacity: 1;
            pointer-events: auto;
        }
        .instruction-content {
            max-width: 500px;
            text-align: center;
            padding: 30px;
        }
        .instruction-content h2 {
            font-size: 2rem;
            margin-bottom: 20px;
            color: #ffcccc;
        }
        .instruction-content p {
            font-size: 1.1rem;
            line-height: 1.7;
            margin: 15px 0;
        }
        .instruction-content button {
            margin-top: 25px;
            padding: 12px 35px;
            background: linear-gradient(135deg, #ffcccc, #cc8888);
            border: none;
            color: #1a1a2a;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 30px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        .instruction-content button:hover { transform: scale(1.05); }
        
        /* Gyro Calibration */
        #gyro-calib-ui {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.95);
            color: white;
            padding: 30px;
            border-radius: 20px;
            text-align: center;
            z-index: 2000;
            display: none;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 204, 204, 0.3);
        }
        #gyro-calib-ui h3 { color: #ffcccc; margin-bottom: 15px; }
        #gyro-calib-ui button {
            margin-top: 15px;
            padding: 10px 30px;
            background: #2ed573;
            border: none;
            color: white;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .main-ui { padding: 15px; }
            .ui-card { padding: 12px 15px; }
            .fab-container { bottom: 15px; right: 15px; }
            .fab { width: 50px; height: 50px; font-size: 18px; }
            #info-panel { max-width: 90%; padding: 15px 20px; }
        }
        
        /* Error Display */
        #error-display {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 0, 0, 0.9);
            color: white;
            padding: 20px;
            border-radius: 10px;
            z-index: 3000;
            display: none;
            max-width: 80%;
            text-align: center;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400 ;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Loading Screen -->
    <div id="loading">
        <div class="loader-brain"></div>
        <div id="loading-text">Loading Brain 3D Model...</div>
        <div id="loading-detail">Initializing engine...</div>
    </div>
    
    <!-- Error Display -->
    <div id="error-display"></div>
    
    <!-- Instructions (Lock Screen) -->
    <div id="instructions" class="visible">
        <div class="instruction-content">
            <h2>üß† Brain 3D Model XR</h2>
            <p><strong>PC Controls:</strong> Right-click & drag to rotate | Scroll to zoom</p>
            <p><strong>Mobile Controls:</strong> Tap markers | Press üîÑ for Gyroscope 360¬∞</p>
            <p style="color: #ffcccc; margin-top: 20px;">Auto-adjusted quality for your device</p>
            <button onclick="startExperience()">Start Experience</button>
        </div>
    </div>
    
    <!-- Gyro Calibration -->
    <div id="gyro-calib-ui">
        <h3>üîÑ Gyroscope Mode</h3>
        <p>Place device vertically and press start</p>
        <button onclick="completeGyroCal()">Start Gyro</button>
    </div>
    
    <!-- Main UI -->
    <div class="main-ui">
        <div id="title-section" class="ui-card">
            <h1>Brain 3D Model - 360¬∞</h1>
            <p id="mode-status">Normal Control Mode</p>
        </div>
        
        <div id="controls-section" class="ui-card">
            <button class="control-btn" id="gyro-btn" onclick="toggleGyro()">Enable Gyroscope Mode</button>
            <button class="control-btn" onclick="resetCamera()">üìç Reset View</button>
            <button class="control-btn" onclick="toggleAutoRotate()">üé¨ Auto Rotate</button>
            <button class="control-btn" onclick="showHelp()">‚ùì Help</button>
        </div>
    </div>
    
    <!-- FAB Controls -->
    <div class="fab-container">
        <div class="fab" id="gyro-fab" onclick="toggleGyro()" title="Toggle Gyroscope">üîÑ</div>
        <div class="fab" onclick="nextMarker()" title="Next Marker">‚û°Ô∏è</div>
    </div>
    
    <!-- Info Panel -->
    <div id="info-panel">
        <h2 id="info-title">Loading...</h2>
        <p id="info-desc">Please wait...</p>
        <div class="marker-counter" id="marker-counter">Point 0/12</div>
    </div>
    
    <script>
        // Global error handler
        window.addEventListener('error', function(e) {
            console.error('Critical Error:', e.error);
            document.getElementById('error-display').innerHTML = 
                `<strong>‚ùå Error</strong><br>${e.error.message}<br><small>Please refresh the page</small>`;
            document.getElementById('error-display').style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        });
    </script>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { SimplexNoise } from 'three/addons/math/SimplexNoise.js';
        
        // ===== STATE MANAGEMENT =====
        let isLocked = true; // Lock system active on start
        let currentMarkerIndex = -1;
        let gyroMode = false;
        // Gyroscope values for 360¬∞ tracking
        let gyroAlpha = 0, gyroBeta = 0, gyroGamma = 0;
        let gyroCalibration = { alpha: 0, beta: 0, gamma: 0 };
        let isGyroCalibrated = false;
        let autoRotate = false;
        
        // ===== SCENE SETUP =====
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0a0a1a);
        scene.fog = new THREE.Fog(0x0a0a1a, 15, 45);
        
        const camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 2, 18);
        
        const renderer = new THREE.WebGLRenderer({ 
            antialias: true, 
            alpha: true,
            powerPreference: "high-performance"
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, isMobile() ? 1.5 : 2));
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.3;
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.outputColorSpace = THREE.SRGBColorSpace;
        document.body.appendChild(renderer.domElement);
        
        // ===== HIGH-QUALITY LIGHTING SYSTEM =====
        const lighting = {
            ambient: new THREE.AmbientLight(0xffffff, 0.3),
            main: new THREE.DirectionalLight(0xffd4d4, 2.2),
            rim: new THREE.SpotLight(0xffcccc, 4, 60, Math.PI / 4, 0.5),
            fill: new THREE.PointLight(0xb8b8ff, 1.2, 100),
            accent: new THREE.PointLight(0xff6b9c, 0.9, 100)
        };
        
        lighting.main.position.set(-8, 12, 8);
        lighting.main.castShadow = true;
        lighting.main.shadow.mapSize.set(2048, 2048);
        lighting.rim.position.set(0, 0, -25);
        lighting.fill.position.set(8, -3, 5);
        lighting.accent.position.set(-5, 3, 6);
        Object.values(lighting).forEach(light => scene.add(light));
        
        // ===== ULTRA-REALISTIC MATERIALS =====
        const materials = {
            cortex: new THREE.MeshPhysicalMaterial({
                color: 0xcc8888,
                roughness: 0.15,
                metalness: 0.03,
                clearcoat: 1.0,
                clearcoatRoughness: 0.05,
                transmission: 0.08,
                thickness: 2.0,
                ior: 1.5,
                side: THREE.DoubleSide
            }),
            cerebellum: new THREE.MeshPhysicalMaterial({
                color: 0xbd7b7b,
                roughness: 0.2,
                clearcoat: 0.8,
                side: THREE.DoubleSide
            }),
            brainstem: new THREE.MeshPhysicalMaterial({
                color: 0xcc2e3e,
                roughness: 0.25,
                clearcoat: 0.6,
                side: THREE.DoubleSide
            })
        };
        
        // ===== PROCEDURAL BRAIN GENERATION =====
        const simplex = new SimplexNoise();
        const brainGroup = createRealisticBrain();
        scene.add(brainGroup);
        
        function createRealisticBrain() {
            const group = new THREE.Group();
            
            // Cerebrum with anatomical details
            const cerebrumGeo = new THREE.IcosahedronGeometry(2.3, 96);
            const pos = cerebrumGeo.attributes.position;
            const vector = new THREE.Vector3();
            
            for (let i = 0; i < pos.count; i++) {
                vector.fromBufferAttribute(pos, i);
                const normal = vector.clone().normalize();
                
                // Major anatomical fissures
                const longitudinal = Math.abs(vector.z) < 0.25 ? 0.5 : 0;
                const central = Math.abs(vector.x) < 0.15 && vector.y > 0.2 ? 0.35 : 0;
                const lateral = vector.y < -0.15 && Math.abs(vector.z) < 0.4 ? 0.4 : 0;
                
                // Gyri patterns using fractal noise
                const scale = 3.0;
                const noise1 = simplex.noise3d(vector.x * scale, vector.y * scale, vector.z * scale);
                const noise2 = simplex.noise3d(vector.x * scale * 2.5, vector.y * scale * 2.5, vector.z * scale * 2.5);
                const ridges = Math.pow(Math.abs(noise1), 0.6) * (1 + noise2 * 0.15);
                
                const totalDisplacement = 0.28 * ridges - (longitudinal + central + lateral) * 0.45;
                vector.add(normal.multiplyScalar(totalDisplacement));
                pos.setXYZ(i, vector.x * 1.35, vector.y * 0.95, vector.z * 0.85);
            }
            
            cerebrumGeo.computeVertexNormals();
            const cerebrum = new THREE.Mesh(cerebrumGeo, materials.cortex);
            cerebrum.castShadow = cerebrum.receiveShadow = true;
            group.add(cerebrum);
            
            // Cerebellum with folia patterns
            const cerebellumGeo = new THREE.SphereGeometry(1.15, 72, 72);
            const cbPos = cerebellumGeo.attributes.position;
            for (let i = 0; i < cbPos.count; i++) {
                vector.fromBufferAttribute(cbPos, i);
                vector.x *= 0.88; vector.y *= 0.65; vector.z *= 1.25;
                const folia = Math.sin((vector.y + simplex.noise3d(vector.x*2, vector.y*2, vector.z*2)*0.1) * 28) * 0.1;
                vector.add(vector.clone().normalize().multiplyScalar(folia));
                cbPos.setXYZ(i, vector.x, vector.y, vector.z);
            }
            cerebellumGeo.computeVertexNormals();
            const cerebellum = new THREE.Mesh(cerebellumGeo, materials.cerebellum);
            cerebellum.position.set(1.9, -1.3, 0);
            cerebellum.rotation.z = 0.25;
            cerebellum.castShadow = cerebellum.receiveShadow = true;
            group.add(cerebellum);
            
            // Brainstem
            const stemGeo = new THREE.CylinderGeometry(0.35, 0.65, 2.8, 20);
            const stem = new THREE.Mesh(stemGeo, materials.brainstem);
            stem.position.set(0.2, -2.2, 0);
            stem.castShadow = stem.receiveShadow = true;
            group.add(stem);
            
            return group;
        }
        
        // ===== MARKER SYSTEM WITH THAI DESCRIPTIONS =====
        const markerData = [
            { id: 1, name: "‡∏™‡∏°‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤", pos: new THREE.Vector3(0, 1.8, 2.4), desc: "‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à ‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô ‡πÅ‡∏•‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å‡∏†‡∏≤‡∏û" },
            { id: 2, name: "‡∏™‡∏°‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏°‡∏±‡∏ö", pos: new THREE.Vector3(-2.8, -0.3, 1.6), desc: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥ ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏£‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏©‡∏≤" },
            { id: 3, name: "‡∏™‡∏°‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏≤‡∏á", pos: new THREE.Vector3(2.8, 0.7, 2.0), desc: "‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™ ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß" },
            { id: 4, name: "‡∏™‡∏°‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏á", pos: new THREE.Vector3(0, 0.7, -2.4), desc: "‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô" },
            { id: 5, name: "‡∏™‡∏°‡∏≠‡∏á‡∏ô‡πâ‡∏≠‡∏¢", pos: new THREE.Vector3(2.2, -1.4, 0), desc: "‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏£‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠" },
            { id: 6, name: "‡∏™‡∏°‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡πà‡∏≤‡∏á", pos: new THREE.Vector3(0.5, -2.4, 0), desc: "‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏´‡∏±‡∏ß‡πÉ‡∏à" },
            { id: 7, name: "‡πÅ‡∏ô‡∏ß‡πÅ‡∏¢‡∏Å‡∏¢‡∏≤‡∏ß", pos: new THREE.Vector3(0, 0.7, 0), desc: "‡∏£‡∏≠‡∏¢‡πÅ‡∏¢‡∏Å‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ã‡∏µ‡∏Å‡∏™‡∏°‡∏≠‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏Ç‡∏ß‡∏≤" },
            { id: 8, name: "‡∏•‡∏¥‡πâ‡∏ô‡∏´‡∏ô‡πâ‡∏≤", pos: new THREE.Vector3(-1.8, 1.3, 2.2), desc: "‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠" },
            { id: 9, name: "‡∏•‡∏¥‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á", pos: new THREE.Vector3(2.1, 1.0, 1.8), desc: "‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πà‡∏ß‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢" },
            { id: 10, name: "‡∏£‡πà‡∏≠‡∏á‡∏™‡∏°‡∏≠‡∏á‡∏Å‡∏•‡∏≤‡∏á", pos: new THREE.Vector3(-1.5, -0.6, 1.2), desc: "‡πÅ‡∏ô‡∏ß‡πÅ‡∏¢‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡∏≠‡∏á‡∏™‡∏°‡∏≠‡∏á" },
            { id: 11, name: "‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡∏™‡∏°‡∏≠‡∏á", pos: new THREE.Vector3(1.0, -1.8, 0.4), desc: "‡∏ó‡∏≤‡∏á‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ó‡∏™‡∏π‡πà‡πÑ‡∏Ç‡∏™‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏á" },
            { id: 12, name: "‡∏°‡∏±‡∏ò‡∏ò‡∏∏‡∏•‡∏≤‡∏õ‡∏•‡∏≤‡∏¢", pos: new THREE.Vector3(0.4, -2.8, 0.2), desc: "‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏´‡∏±‡∏ß‡πÉ‡∏à" }
        ];
        
        const markers = [];
        
        // Create 3D markers with glow
        markerData.forEach((data, index) => {
            // Main marker
            const markerGeo = new THREE.SphereGeometry(0.1, 20, 20);
            const markerMat = new THREE.MeshBasicMaterial({ 
                color: 0xffcccc,
                transparent: true,
                opacity: 0.95
            });
            const markerMesh = new THREE.Mesh(markerGeo, markerMat);
            markerMesh.position.copy(data.pos);
            markerMesh.userData = { id: data.id, index, type: 'marker' };
            
            // Glow ring
            const ringGeo = new THREE.TorusGeometry(0.15, 0.03, 8, 20);
            const ringMat = new THREE.MeshBasicMaterial({
                color: 0xffcccc,
                transparent: true,
                opacity: 0.6
            });
            const ringMesh = new THREE.Mesh(ringGeo, ringMat);
            ringMesh.position.copy(data.pos);
            ringMesh.lookAt(camera.position);
            
            brainGroup.add(markerMesh, ringMesh);
            markers.push({ mesh: markerMesh, ring: ringMesh, data });
        });
        
        // ===== CONTROLS SETUP (INITIALLY LOCKED) =====
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.08;
        controls.minDistance = 5;
        controls.maxDistance = 35;
        controls.maxPolarAngle = Math.PI * 0.85;
        controls.autoRotate = false;
        controls.autoRotateSpeed = 0.4;
        controls.enabled = false; // Locked until user starts
        
        // ===== RAYCASTING INTERACTION =====
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        
        renderer.domElement.addEventListener('click', onInteraction);
        renderer.domElement.addEventListener('touchstart', onTouchInteraction);
        
        function onInteraction(event) {
            if (isLocked || gyroMode) return;
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            checkMarkerInteraction();
        }
        
        function onTouchInteraction(event) {
            if (isLocked || gyroMode || !event.touches.length) return;
            mouse.x = (event.touches[0].clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.touches[0].clientY / window.innerHeight) * 2 + 1;
            checkMarkerInteraction();
        }
        
        function checkMarkerInteraction() {
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(brainGroup.children.filter(child => child.userData.type === 'marker'));
            
            if (intersects.length > 0) {
                const index = intersects[0].object.userData.index;
                selectMarker(index);
            }
        }
        
        // ===== MARKER NAVIGATION =====
        function selectMarker(index) {
            currentMarkerIndex = index;
            const data = markerData[index];
            
            // Update UI (Thai descriptions preserved)
            document.getElementById('info-title').textContent = `${data.id}. ${data.name}`;
            document.getElementById('info-desc').textContent = data.desc;
            document.getElementById('marker-counter').textContent = `${data.id}/12`;
            showInfoPanel();
            
            // Highlight selected marker
            markers.forEach((m, i) => {
                m.mesh.material.opacity = i === index ? 1 : 0.4;
                m.ring.material.opacity = i === index ? 0.8 : 0.2;
                m.mesh.scale.setScalar(i === index ? 1.3 : 1);
            });
            
            // Animate camera
            const targetPos = data.pos.clone().multiplyScalar(1.85);
            animateCameraTo(targetPos);
        }
        
        function showInfoPanel() {
            document.getElementById('info-panel').classList.add('visible');
            clearTimeout(window.infoPanelTimer);
            window.infoPanelTimer = setTimeout(() => {
                document.getElementById('info-panel').classList.remove('visible');
            }, 6000);
        }
        
        function animateCameraTo(targetPosition) {
            const startPos = camera.position.clone();
            const startTime = Date.now();
            const duration = 1500;
            
            function update() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easeProgress = 1 - Math.pow(1 - progress, 4);
                
                camera.position.lerpVectors(startPos, targetPosition, easeProgress);
                camera.lookAt(0, 0, 0);
                
                if (progress < 1) requestAnimationFrame(update);
            }
            update();
        }
        
        // ===== START EXPERIENCE (UNLOCK) =====
        function startExperience() {
            isLocked = false;
            controls.enabled = true;
            document.getElementById('instructions').classList.remove('visible');
            updateModeStatus('Normal Control Mode - Click markers to explore');
            selectMarker(0);
        }
        window.startExperience = startExperience;
        
        // ===== ENHANCED GYROSCOPE SYSTEM (REALISTIC 360¬∞) =====
        async function toggleGyro() {
            if (isLocked) {
                showError('Please start the experience first');
                return;
            }
            
            if (!gyroMode) {
                // iOS permission
                if (typeof DeviceOrientationEvent.requestPermission === 'function') {
                    try {
                        const permission = await DeviceOrientationEvent.requestPermission();
                        if (permission !== 'granted') {
                            showError('Gyroscope permission required');
                            return;
                        }
                    } catch { return; }
                }
                
                document.getElementById('gyro-calib-ui').style.display = 'block';
                gyroMode = true;
                controls.enabled = false;
                document.getElementById('gyro-btn').classList.add('active');
                document.getElementById('gyro-fab').classList.add('active');
                updateModeStatus('Gyroscope Mode - Awaiting calibration');
            } else {
                deactivateGyro();
            }
        }
        window.toggleGyro = toggleGyro;
        
        function completeGyroCal() {
            document.getElementById('gyro-calib-ui').style.display = 'none';
            isGyroCalibrated = false; // Will calibrate on next gyro event
            window.addEventListener('deviceorientation', handleGyro, { passive: true });
            showInfoPanel();
            document.getElementById('info-title').textContent = 'üîÑ Gyroscope Active';
            document.getElementById('info-desc').textContent = 'Rotate your device in any direction to explore 360¬∞';
        }
        window.completeGyroCal = completeGyroCal;
        
        function deactivateGyro() {
            gyroMode = false;
            isGyroCalibrated = false;
            controls.enabled = true;
            document.removeEventListener('deviceorientation', handleGyro);
            document.getElementById('gyro-btn').classList.remove('active');
            document.getElementById('gyro-fab').classList.remove('active');
            updateModeStatus('Normal Control Mode');
        }
        
        function handleGyro(event) {
            if (!gyroMode) return;
            
            // Auto-calibrate on first reading
            if (!isGyroCalibrated) {
                gyroCalibration.alpha = event.alpha || 0;
                gyroCalibration.beta = event.beta || 0;
                gyroCalibration.gamma = event.gamma || 0;
                isGyroCalibrated = true;
                return;
            }
            
            // Get RELATIVE rotation from calibration (true following)
            const alphaDelta = (event.alpha || 0) - gyroCalibration.alpha;
            const betaDelta = (event.beta || 0) - gyroCalibration.beta;
            const gammaDelta = (event.gamma || 0) - gyroCalibration.gamma;
            
            // Convert to radians
            const targetAlpha = THREE.MathUtils.degToRad(alphaDelta);
            const targetBeta = THREE.MathUtils.degToRad(betaDelta);
            const targetGamma = THREE.MathUtils.degToRad(gammaDelta);
            
            // SMOOTH but RESPONSIVE interpolation
            const lerpFactor = 0.2;
            gyroAlpha = THREE.MathUtils.lerp(gyroAlpha, targetAlpha, lerpFactor);
            gyroBeta = THREE.MathUtils.lerp(gyroBeta, targetBeta, lerpFactor);
            gyroGamma = THREE.MathUtils.lerp(gyroGamma, targetGamma, lerpFactor);
            
            // REALISTIC 360¬∞ MAPPING - Model follows phone directly
            brainGroup.rotation.order = 'YXZ'; // Prevent gimbal lock
            brainGroup.rotation.x = -gyroBeta; // Inverted for intuitive feel
            brainGroup.rotation.y = -gyroAlpha; // Inverted for intuitive feel
            brainGroup.rotation.z = gyroGamma * 0.5; // Reduced roll for stability
        }
        
        // ===== UI FUNCTIONS (ENGLISH) =====
        function resetCamera() {
            if (isLocked) {
                showError('Please start the experience first');
                return;
            }
            camera.position.set(0, 2, 18);
            camera.lookAt(0, 0, 0);
            brainGroup.rotation.set(0, 0, 0);
            currentMarkerIndex = -1;
            markers.forEach(m => {
                m.mesh.material.opacity = 0.95;
                m.ring.material.opacity = 0.6;
                m.mesh.scale.setScalar(1);
            });
            document.getElementById('info-panel').classList.remove('visible');
            updateModeStatus('View reset successfully');
        }
        window.resetCamera = resetCamera;
        
        function toggleAutoRotate() {
            if (isLocked) {
                showError('Please start the experience first');
                return;
            }
            autoRotate = !autoRotate;
            controls.autoRotate = autoRotate;
            const btn = document.querySelector('.control-btn[onclick="toggleAutoRotate()"]');
            if (autoRotate) {
                btn.classList.add('active');
                updateModeStatus('Auto Rotate ON');
            } else {
                btn.classList.remove('active');
                updateModeStatus('Auto Rotate OFF');
            }
        }
        window.toggleAutoRotate = toggleAutoRotate;
        
        function nextMarker() {
            if (isLocked) {
                showError('Please start the experience first');
                return;
            }
            const newIndex = (currentMarkerIndex + 1) % markerData.length;
            selectMarker(newIndex);
        }
        window.nextMarker = nextMarker;
        
        function showHelp() {
            document.getElementById('instructions').classList.add('visible');
        }
        window.showHelp = showHelp;
        
        function updateModeStatus(text) {
            document.getElementById('mode-status').textContent = text;
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error-display');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 4000);
        }
        
        // ===== UTILITIES =====
        function isMobile() {
            return window.innerWidth <= 768 || 
                   /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }
        
        // ===== PERFORMANCE OPTIMIZATION =====
        function optimizePerformance() {
            if (isMobile()) {
                renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.5));
                brainGroup.scale.setScalar(0.85);
            }
        }
        
        // ===== ANIMATION LOOP (60FPS LOCKED) =====
        let lastTime = 0;
        function animate(time) {
            requestAnimationFrame(animate);
            
            // 60FPS throttle
            if (time - lastTime < 16.67) return;
            lastTime = time;
            
            // Animate markers
            markers.forEach((m, i) => {
                const pulse = Math.sin(time * 0.0018 + i * 0.5) * 0.15 + 0.85;
                m.ring.scale.setScalar(pulse * (m.mesh.scale.x > 1 ? 1.3 : 1));
                m.ring.rotation.z = time * 0.001;
            });
            
            if (!gyroMode) controls.update();
            renderer.render(scene, camera);
        }
        
        // ===== EVENT LISTENERS =====
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            optimizePerformance();
        });
        
        renderer.domElement.addEventListener('contextmenu', e => e.preventDefault());
        
        // ===== INITIALIZATION =====
        try {
            optimizePerformance();
            
            // Hide loading screen
            setTimeout(() => {
                document.getElementById('loading').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loading').style.display = 'none';
                }, 800);
            }, 2000);
            
            // Start animation
            animate();
            
        } catch (error) {
            showError(`Initialization Error: ${error.message}`);
            console.error('Full Error:', error);
        }
        
    </script>
</body>
</html>
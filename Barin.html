<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏™‡∏°‡∏≠‡∏á‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå 3D XR (Professional)</title>
    <style>
        body { 
            margin: 0; 
            overflow: hidden; 
            background: radial-gradient(circle at 50% 50%, #1a1a2e 0%, #0c0c1a 100%);
            font-family: 'Sarabun', sans-serif;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
        }
        canvas { display: block; outline: none; touch-action: none; }
        
        #loading {
            position: absolute; top: 50%; left: 50%; 
            transform: translate(-50%, -50%);
            color: #ffcccc; font-family: sans-serif; font-weight: bold;
            font-size: 1.2rem; text-shadow: 2px 2px 6px rgba(0,0,0,0.9);
            z-index: 5000;
            padding: 20px;
            text-align: center;
        }
        
        #info {
            position: absolute;
            top: 15px;
            width: 100%;
            text-align: center;
            color: #fff;
            pointer-events: none;
            z-index: 10;
            text-shadow: 2px 2px 6px rgba(0,0,0,0.9);
            transition: opacity 0.5s;
        }
        h1 { margin: 0; font-weight: 700; color: #ffcccc; font-size: 1.4rem;}
        p { margin: 5px; font-size: 0.9rem; color: #ddd; }
        
        #controls {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 10px;
            z-index: 1000;
            backdrop-filter: blur(10px);
            transition: opacity 0.5s;
            max-width: 180px;
        }
        #controls button {
            display: block;
            width: 100%;
            margin: 3px 0;
            padding: 8px;
            background: #c44c4c;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s;
            pointer-events: auto;
            white-space: nowrap;
        }
        #controls button:hover {
            background: #ff6b9c;
            transform: scale(1.05);
        }
        #controls button.active {
            background: #2ed573;
        }

        #bottom-ui-container {
            position: absolute;
            bottom: 10px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
            z-index: 1000;
            transition: opacity 0.3s;
        }

        #info-panel {
            background: rgba(0, 0, 0, 0.95);
            padding: 12px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            width: 70%;
            max-width: 450px;
            text-align: center;
            color: white;
            border: 1px solid #ffcccc;
            pointer-events: auto;
            margin: 0 10px;
            position: relative;
        }
        
        .nav-btn {
            background: rgba(0, 0, 0, 0.6);
            color: #ffcccc;
            border: 2px solid #ffcccc;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            pointer-events: auto;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
        }
        .nav-btn:hover {
            background: #ffcccc;
            color: #1a1a2e;
            transform: scale(1.1);
        }
        .nav-btn:active { transform: scale(0.9); }

        #legend {
            position: absolute; top: 50%; left: 10px; transform: translateY(-50%);
            background: rgba(0,0,0,0.8); padding: 12px; border-radius: 10px;
            color: white; font-size: 11px; z-index: 1000;
            backdrop-filter: blur(10px); transition: opacity 0.5s;
        }
        #legend h3 { margin: 0 0 8px 0; color: #ffcccc; font-size: 13px; }
        #legend div { margin: 4px 0; }
        #legend span { display: inline-block; width: 18px; height: 3px; margin-right: 5px; vertical-align: middle; }
        
        #ar-button { 
            background: #2ed573 !important; 
            position: absolute; 
            top: 20px; 
            left: 20px; 
            z-index: 1001; 
            display: none;
            border-color: #2ed573 !important;
            padding: 12px !important;
            font-size: 14px !important;
        }
        
        #gyro-indicator {
            position: absolute;
            top: 80px;
            left: 20px;
            background: rgba(46, 213, 115, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1002;
            display: none;
            backdrop-filter: blur(5px);
        }
        
        .mode-indicator {
            position: absolute;
            top: 10px;
            right: 50%;
            transform: translateX(50%);
            background: rgba(0,0,0,0.8);
            color: #ffcccc;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 12px;
            z-index: 1002;
            backdrop-filter: blur(5px);
        }
        
        .hidden { opacity: 0 !important; pointer-events: none !important; }

        #marker-canvas { 
            position: absolute; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            pointer-events: none; 
            z-index: 100; 
        }
        
        .marker-container { 
            position: absolute; 
            cursor: pointer; 
            pointer-events: auto; 
            transition: all 0.3s; 
            z-index: 101; 
        }
        .marker-container:hover { transform: scale(1.2); }
        .marker-number {
            width: 32px; height: 32px; border-radius: 50%;
            background: linear-gradient(135deg, #ffcccc, #c44c4c);
            color: #1a1a2e; font-weight: bold; font-size: 16px;
            display: flex; align-items: center; justify-content: center;
            border: 2px solid white;
            box-shadow: 0 0 12px rgba(255,204,204,0.7);
            text-shadow: none;
        }

        /* --- SCENE NAVIGATION BUTTONS --- */
        .scene-nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.3);
            font-size: 35px;
            padding: 12px 18px;
            cursor: pointer;
            z-index: 2000;
            border-radius: 12px;
            transition: all 0.3s ease;
            backdrop-filter: blur(4px);
            pointer-events: auto;
        }
        .scene-nav-btn:hover {
            background: rgba(255, 204, 204, 0.8);
            color: #1a1a2e;
            border-color: transparent;
            transform: translateY(-50%) scale(1.1);
            box-shadow: 0 0 15px rgba(255, 204, 204, 0.6);
        }
        .scene-nav-btn:active { transform: translateY(-50%) scale(0.9); }
        .prev-scene { left: 15px; }
        .next-scene { right: 15px; }

        @media screen and (max-width: 768px) {
            #info-panel {
                width: 85% !important;
                max-width: 90% !important;
                padding: 10px 15px !important;
                border-radius: 10px !important;
            }
            #info-panel h2 {
                font-size: 16px !important;
                margin-bottom: 8px !important;
            }
            #info-panel p {
                font-size: 12px !important;
                line-height: 1.4 !important;
                margin: 4px 0 !important;
            }
            .nav-btn {
                width: 50px !important;
                height: 50px !important;
                font-size: 24px !important;
                margin: 0 5px !important;
            }
            #controls {
                padding: 8px !important;
                top: 10px !important;
                right: 10px !important;
                max-width: 150px;
            }
            #controls button {
                font-size: 11px !important;
                padding: 6px !important;
            }
            #legend {
                font-size: 9px !important;
                padding: 8px !important;
                top: auto !important;
                bottom: 10px !important;
                left: 10px !important;
                transform: none !important;
                max-width: 120px !important;
            }
            #info h1 {
                font-size: 1.2rem !important;
            }
            .marker-number {
                width: 28px !important;
                height: 28px !important;
                font-size: 14px !important;
            }
            .scene-nav-btn {
                font-size: 28px !important;
                padding: 8px 12px !important;
                top: auto !important;
                bottom: 20px !important;
                transform: none !important;
            }
            .prev-scene { left: 15px !important; }
            .next-scene { right: 15px !important; }
            #ar-button {
                top: 10px !important;
                left: 10px !important;
                font-size: 12px !important;
                padding: 10px !important;
            }
            #gyro-indicator {
                top: 60px !important;
                left: 10px !important;
                font-size: 10px !important;
                padding: 6px 10px !important;
            }
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600;700&display=swap" rel="stylesheet">
</head>
<body>

    <div id="loading">
        <div>GENERATING NEUROANATOMY...</div>
        <div style="font-size: 12px; margin-top: 10px;">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏™‡∏°‡∏≠‡∏á...</div>
    </div>

    <div id="info">
        <h1>‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏™‡∏°‡∏≠‡∏á‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå 3D XR</h1>
        <p id="interaction-hint">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤‡∏£‡∏¥‡∏°‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç | ‡∏´‡∏°‡∏∏‡∏ô-‡∏ã‡∏π‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏≥‡∏£‡∏ß‡∏à</p>
    </div>
    
    <div id="mode-indicator" class="mode-indicator" style="display: none;">‡πÇ‡∏´‡∏°‡∏î AR</div>
    <div id="gyro-indicator" style="display: none;">üîÑ ‡πÇ‡∏´‡∏°‡∏î‡πÑ‡∏à‡πÇ‡∏£‡∏™‡πÇ‡∏Ñ‡∏õ</div>
    
    <button class="scene-nav-btn prev-scene" onclick="window.location.href='lungs.html'" title="‡πÑ‡∏õ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏õ‡∏≠‡∏î">‚ùÆ</button>
    <button class="scene-nav-btn next-scene" onclick="window.location.href='Hard.html'" title="‡πÑ‡∏õ‡πÇ‡∏°‡πÄ‡∏î‡∏•‡∏´‡∏±‡∏ß‡πÉ‡∏à">‚ùØ</button>
  
    <button id="ar-button" onclick="enterAR()">‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏´‡∏°‡∏î AR</button>

    <div id="controls">
        <button onclick="resetView()">‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á</button>
        <button onclick="toggleRotation()">‡∏´‡∏¢‡∏∏‡∏î/‡∏´‡∏°‡∏∏‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</button>
        <button onclick="toggleLabels()">‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏•‡∏π‡∏Å‡∏®‡∏£</button>
        <button id="gyro-btn" onclick="toggleGyroscope()">‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÑ‡∏à‡πÇ‡∏£</button>
    </div>

    <div id="legend">
        <h3>‡∏™‡πà‡∏ß‡∏ô‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö</h3>
        <div><span style="background: #ffcccc;"></span>‡πÄ‡∏¢‡∏∑‡πà‡∏≠‡∏´‡∏∏‡πâ‡∏°‡∏™‡∏°‡∏≠‡∏á (Cortex)</div>
        <div><span style="background: #bd7b7b;"></span>‡∏™‡∏°‡∏≠‡∏á‡∏ô‡πâ‡∏≠‡∏¢ (Cerebellum)</div>
        <div><span style="background: #cc2e3e;"></span>‡∏™‡∏°‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡πà‡∏≤‡∏á (Brainstem)</div>
    </div>

    <div id="bottom-ui-container">
        <button class="nav-btn" onclick="navigateMarker(-1)">‚ùÆ</button>
        <div id="info-panel">
            <h2>‡∏™‡∏°‡∏≠‡∏á‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå</h2>
            <p>‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏®‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏Ç‡∏≠‡∏á‡∏™‡∏°‡∏≠‡∏á</p>
            <p style="color: #888; font-size: 12px;">* ‡∏°‡∏µ‡∏à‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î 12 ‡∏à‡∏∏‡∏î</p>
        </div>
        <button class="nav-btn" onclick="navigateMarker(1)">‚ùØ</button>
    </div>

    <canvas id="marker-canvas"></canvas>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    
    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { SimplexNoise } from 'three/addons/math/SimplexNoise.js';

        // Scene Setup
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x110b0b);
        scene.fog = new THREE.Fog(0x110b0b, 8, 30);
        
        const camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 0.1, 100);
        camera.position.set(-8, 2, 0);
        
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.0;
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        renderer.xr.enabled = true;
        document.body.appendChild(renderer.domElement);

        // Lighting
        const mainLight = new THREE.DirectionalLight(0xffeebb, 2);
        mainLight.position.set(-5, 10, 5);
        mainLight.castShadow = true;
        mainLight.shadow.mapSize.set(2048, 2048);
        scene.add(mainLight);

        const fillLight = new THREE.PointLight(0xc44c4c, 1.5);
        fillLight.position.set(5, 0, 0);
        scene.add(fillLight);

        const rimLight = new THREE.SpotLight(0xffffff, 5);
        rimLight.position.set(0, 5, -10);
        scene.add(rimLight);

        const ambientLight = new THREE.AmbientLight(0xffffff, 0.3);
        scene.add(ambientLight);

        // Materials
        const brainMat = new THREE.MeshPhysicalMaterial({
            color: 0xcc8888,
            roughness: 0.25,
            metalness: 0.1,
            clearcoat: 0.8,
            clearcoatRoughness: 0.3,
            transmission: 0.1,
            thickness: 2.0,
            ior: 1.45,
            side: THREE.DoubleSide
        });

        const cereMat = new THREE.MeshPhysicalMaterial({
            color: 0xbd7b7b,
            roughness: 0.3,
            metalness: 0.0,
            clearcoat: 0.6,
            side: THREE.DoubleSide
        });

        const simplex = new SimplexNoise();

        // Brain Generation
        function createCerebrum() {
            const geometry = new THREE.IcosahedronGeometry(2.0, 80);
            const pos = geometry.attributes.position;
            const vector = new THREE.Vector3();
            
            for (let i = 0; i < pos.count; i++) {
                vector.fromBufferAttribute(pos, i);
                let [x, y, z] = [vector.x * 1.3, vector.y, vector.z * 0.85];

                if (y < -0.5 && x > 0) y += 0.5 * (x * 0.5);

                const scale = 1.2;
                const n1 = simplex.noise3d(x * scale, y * scale, z * scale);
                const n2 = simplex.noise3d(x * scale * 2.5, y * scale * 2.5, z * scale * 2.5);
                const ridge = Math.pow(Math.abs(n1), 0.8);
                const detail = n2 * 0.1;
                const displacement = 0.3 * (ridge + detail);
                const normal = vector.clone().normalize();
                
                let fissure = 1.0;
                if (Math.abs(z) < 0.15) {
                    fissure = Math.pow(Math.abs(z) / 0.15, 0.5);
                }

                vector.set(x, y, z).add(normal.multiplyScalar(displacement * fissure));
                pos.setXYZ(i, vector.x, vector.y, vector.z);
            }

            geometry.computeVertexNormals();
            const mesh = new THREE.Mesh(geometry, brainMat);
            mesh.castShadow = mesh.receiveShadow = true;
            return mesh;
        }

        function createCerebellum() {
            const geometry = new THREE.SphereGeometry(1.0, 128, 128);
            const pos = geometry.attributes.position;
            const vector = new THREE.Vector3();

            for (let i = 0; i < pos.count; i++) {
                vector.fromBufferAttribute(pos, i);
                vector.x *= 0.9; vector.y *= 0.6; vector.z *= 1.2;

                const stripeFreq = 15.0;
                const stripeNoise = simplex.noise3d(vector.x * 2, vector.y * 2, vector.z * 2) * 0.1;
                const stripes = Math.sin((vector.y + stripeNoise) * stripeFreq);
                const displacement = (stripes + 1) * 0.08;
                
                vector.add(vector.clone().normalize().multiplyScalar(displacement));
                pos.setXYZ(i, vector.x, vector.y, vector.z);
            }

            geometry.computeVertexNormals();
            const mesh = new THREE.Mesh(geometry, cereMat);
            mesh.position.set(1.8, -1.2, 0);
            mesh.rotation.z = 0.2;
            mesh.castShadow = mesh.receiveShadow = true;
            return mesh;
        }

        function createBrainstem() {
            class CustomSinCurve extends THREE.Curve {
                getPoint(t) {
                    const [tx, ty, tz] = [t * 3 - 1.5, Math.cos(t * Math.PI * 0.5) * -1.5, 0];
                    return new THREE.Vector3(tx, ty, tz).multiplyScalar(0.8);
                }
            }
            const geometry = new THREE.TubeGeometry(new CustomSinCurve(), 20, 0.5, 16, false);
            const pos = geometry.attributes.position;
            const vector = new THREE.Vector3();
            
            for (let i = 0; i < pos.count; i++) {
                vector.fromBufferAttribute(pos, i);
                vector.add(new THREE.Vector3(0, Math.sin(vector.x * 20) * 0.05, 0));
                pos.setXYZ(i, vector.x, vector.y, vector.z);
            }

            geometry.computeVertexNormals();
            const mesh = new THREE.Mesh(geometry, cereMat);
            mesh.position.set(0.2, -1.5, 0);
            mesh.rotation.z = -Math.PI / 4;
            mesh.castShadow = mesh.receiveShadow = true;
            return mesh;
        }

        // Scene Assembly
        const brainGroup = new THREE.Group();
        brainGroup.add(createCerebrum(), createCerebellum(), createBrainstem());
        scene.add(brainGroup);

        // UI State
        document.getElementById('loading').style.display = 'none';
        const markerCanvas = document.getElementById('marker-canvas');
        const markerCtx = markerCanvas.getContext('2d');
        markerCanvas.width = window.innerWidth;
        markerCanvas.height = window.innerHeight;

        const fixedLabelPositions = {
            1: { x: 50, y: 15 }, 2: { x: 20, y: 30 }, 3: { x: 80, y: 30 },
            4: { x: 50, y: 85 }, 5: { x: 30, y: 70 }, 6: { x: 70, y: 70 },
            7: { x: 50, y: 50 }, 8: { x: 25, y: 45 }, 9: { x: 75, y: 45 },
            10: { x: 50, y: 35 }, 11: { x: 35, y: 60 }, 12: { x: 65, y: 60 }
        };

        const markerData = [
            { id: 1, name: "‡∏™‡∏°‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏ô‡πâ‡∏≤", pos: { x: 0, y: 1.5, z: 2.2 }, color: "#ffcccc", type: "cortex", desc: "‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î‡∏™‡∏¥‡∏ô‡πÉ‡∏à ‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô ‡πÅ‡∏•‡∏∞‡∏ö‡∏∏‡∏Ñ‡∏•‡∏¥‡∏Å‡∏†‡∏≤‡∏û 30% ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏°‡∏≠‡∏á" },
            { id: 2, name: "‡∏™‡∏°‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏°‡∏±‡∏ö", pos: { x: -2.5, y: -0.5, z: 1.5 }, color: "#ffcccc", type: "cortex", desc: "‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏≥ ‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏£‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡πÅ‡∏•‡∏∞‡∏†‡∏≤‡∏©‡∏≤" },
            { id: 3, name: "‡∏™‡∏°‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏≤‡∏á", pos: { x: 2.5, y: 0.5, z: 1.8 }, color: "#ffcccc", type: "cortex", desc: "‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™ ‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß" },
            { id: 4, name: "‡∏™‡∏°‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏´‡∏•‡∏±‡∏á", pos: { x: 0, y: 0.5, z: -2.0 }, color: "#ffcccc", type: "cortex", desc: "‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏°‡∏≠‡∏á‡πÄ‡∏´‡πá‡∏ô" },
            { id: 5, name: "‡∏™‡∏°‡∏≠‡∏á‡∏ô‡πâ‡∏≠‡∏¢", pos: { x: 2.0, y: -1.2, z: 0 }, color: "#bd7b7b", type: "cerebellum", desc: "‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡∏ó‡∏£‡∏á‡∏ï‡∏±‡∏ß‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠" },
            { id: 6, name: "‡∏™‡∏°‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡πà‡∏≤‡∏á", pos: { x: 0.5, y: -2.0, z: 0 }, color: "#cc2e3e", type: "brainstem", desc: "‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏´‡∏±‡∏ß‡πÉ‡∏à" },
            { id: 7, name: "‡πÅ‡∏ô‡∏ß‡πÅ‡∏¢‡∏Å‡∏¢‡∏≤‡∏ß", pos: { x: 0, y: 0.5, z: 0 }, color: "#ffcccc", type: "fissure", desc: "‡∏£‡∏≠‡∏¢‡πÅ‡∏¢‡∏Å‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ã‡∏µ‡∏Å‡∏™‡∏°‡∏≠‡∏á‡∏ã‡πâ‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏Ç‡∏ß‡∏≤" },
            { id: 8, name: "‡∏•‡∏¥‡πâ‡∏ô‡∏´‡∏ô‡πâ‡∏≤", pos: { x: -1.5, y: 1.0, z: 1.8 }, color: "#ffe0e0", type: "gyrus", desc: "‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏´‡∏ß‡∏Ç‡∏≠‡∏á‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠" },
            { id: 9, name: "‡∏•‡∏¥‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á", pos: { x: 1.8, y: 0.8, z: 1.5 }, color: "#ffe0e0", type: "gyrus", desc: "‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏£‡∏π‡πâ‡∏™‡∏∂‡∏Å‡∏à‡∏≤‡∏Å‡∏ó‡∏±‡πà‡∏ß‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢" },
            { id: 10, name: "‡∏£‡πà‡∏≠‡∏á‡∏™‡∏°‡∏≠‡∏á‡∏Å‡∏•‡∏≤‡∏á", pos: { x: -1.2, y: -0.8, z: 1.0 }, color: "#ffcccc", type: "fissure", desc: "‡πÅ‡∏ô‡∏ß‡πÅ‡∏¢‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡∏≠‡∏á‡∏™‡∏°‡∏≠‡∏á" },
            { id: 11, name: "‡∏™‡∏∞‡∏û‡∏≤‡∏ô‡∏™‡∏°‡∏≠‡∏á", pos: { x: 0.8, y: -1.5, z: 0.3 }, color: "#a55", type: "brainstem", desc: "‡∏ó‡∏≤‡∏á‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ó‡∏™‡∏π‡πà‡πÑ‡∏Ç‡∏™‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏á" },
            { id: 12, name: "‡∏°‡∏±‡∏ò‡∏ò‡∏∏‡∏•‡∏≤‡∏õ‡∏•‡∏≤‡∏¢", pos: { x: 0.3, y: -2.5, z: 0.2 }, color: "#8b0000", type: "brainstem", desc: "‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏°‡∏Å‡∏≤‡∏£‡∏´‡∏≤‡∏¢‡πÉ‡∏à‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡πâ‡∏ô‡∏Ç‡∏≠‡∏á‡∏´‡∏±‡∏ß‡πÉ‡∏à" }
        ];

        let showLabels = true, activeMarker = null, currentMarkerIndex = -1;
        let isARMode = false, autoHideTimer = null, uiVisible = true, rotating = true;
        let gyroControls = false, deviceOrientation = { alpha: 0, beta: 0, gamma: 0 };
        const markerElements = {};
        
        markerData.forEach((data, index) => {
            const container = document.createElement('div');
            container.className = 'marker-container';
            const number = document.createElement('div');
            number.className = 'marker-number';
            number.style.background = `linear-gradient(135deg, ${data.color}, #c44c4c)`;
            number.textContent = data.id;
            container.appendChild(number);
            container.style.display = 'none';
            document.body.appendChild(container);
            
            const fixedPos = fixedLabelPositions[data.id];
            container.style.left = `${fixedPos.x}%`;
            container.style.top = `${fixedPos.y}%`;
            container.style.transform = 'translate(-50%, -50%)';
            markerElements[data.id] = { container, data, index };
            container.addEventListener('click', () => selectMarkerByIndex(index));
        });

        function isMobile() {
            return window.innerWidth <= 768 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        function adjustForMobile() {
            if (isMobile()) {
                brainGroup.scale.set(0.7, 0.7, 0.7);
                camera.position.set(-8, 2, 15);
                document.getElementById('interaction-hint').textContent = '‡πÅ‡∏ï‡∏∞‡∏•‡∏π‡∏Å‡∏®‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏≥‡∏£‡∏ß‡∏à | ‡πÉ‡∏ä‡πâ‡πÇ‡∏´‡∏°‡∏î‡πÑ‡∏à‡πÇ‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏∏‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥';
            }
        }

        function navigateMarker(direction) {
            let newIndex = currentMarkerIndex + direction;
            if (newIndex < 0) newIndex = markerData.length - 1;
            if (newIndex >= markerData.length) newIndex = 0;
            selectMarkerByIndex(newIndex);
        }
        window.navigateMarker = navigateMarker;

        function selectMarkerByIndex(index) {
            currentMarkerIndex = index;
            const data = markerData[index];
            clearTimeout(autoHideTimer);
            showInfo(data);
            showUI();
            autoHideUI();
        }

        function showInfo(data) {
            const panel = document.getElementById('info-panel');
            panel.innerHTML = `
                <h2>${data.id}. ${data.name}</h2>
                <p>${data.desc}</p>
                <p style="color: #999; font-size: 12px; margin-top: 10px;">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${getTypeLabel(data.type)}</p>
                <div style="font-size:12px; margin-top:5px; color:#ffcccc;">(${currentMarkerIndex + 1} / ${markerData.length})</div>
            `;
            Object.values(markerElements).forEach(el => {
                el.container.style.filter = 'brightness(1)';
                el.container.style.transform = 'translate(-50%, -50%) scale(1)';
            });
            const el = markerElements[data.id];
            el.container.style.filter = 'brightness(1.5) drop-shadow(0 0 10px #fff)';
            el.container.style.transform = 'translate(-50%, -50%) scale(1.3)';
            activeMarker = data.id;
        }

        function getTypeLabel(type) {
            const labels = { cortex: '‡πÄ‡∏¢‡∏∑‡πà‡∏≠‡∏´‡∏∏‡πâ‡∏°‡∏™‡∏°‡∏≠‡∏á', cerebellum: '‡∏™‡∏°‡∏≠‡∏á‡∏ô‡πâ‡∏≠‡∏¢', brainstem: '‡∏™‡∏°‡∏≠‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡πà‡∏≤‡∏á', fissure: '‡∏£‡πà‡∏≠‡∏á‡∏™‡∏°‡∏≠‡∏á', gyrus: '‡∏•‡∏¥‡πâ‡∏ô‡∏™‡∏°‡∏≠‡∏á' };
            return labels[type] || '‡∏≠‡∏∑‡πà‡∏ô‡πÜ';
        }

        function updateMarkers() {
            markerCtx.clearRect(0, 0, markerCanvas.width, markerCanvas.height);
            if (!showLabels) {
                Object.values(markerElements).forEach(el => el.container.style.display = 'none');
                return;
            }
            markerData.forEach(data => {
                const vector = new THREE.Vector3(data.pos.x, data.pos.y, data.pos.z);
                vector.applyMatrix4(brainGroup.matrixWorld);
                vector.project(camera);
                if (vector.z > 1) {
                    markerElements[data.id].container.style.display = 'none';
                    return;
                }
                const [endX, endY] = [(vector.x * 0.5 + 0.5) * window.innerWidth, (-vector.y * 0.5 + 0.5) * window.innerHeight];
                const fixedPos = fixedLabelPositions[data.id];
                const [startX, startY] = [(fixedPos.x / 100) * window.innerWidth, (fixedPos.y / 100) * window.innerHeight];
                const distance = camera.position.distanceTo(vector.applyMatrix4(brainGroup.matrixWorld));

                markerCtx.strokeStyle = data.color;
                markerCtx.lineWidth = 3;
                markerCtx.globalAlpha = Math.max(0.3, 1 - distance / 15);
                markerCtx.beginPath(); markerCtx.moveTo(startX, startY); markerCtx.lineTo(endX, endY); markerCtx.stroke();
                markerCtx.fillStyle = data.color; markerCtx.beginPath(); markerCtx.arc(endX, endY, 5, 0, Math.PI * 2); markerCtx.fill();
                
                const markerEl = markerElements[data.id].container;
                markerEl.style.display = 'block';
                markerEl.style.opacity = Math.max(0.4, 1 - distance / 12);
            });
        }

        function autoHideUI() {
            clearTimeout(autoHideTimer);
            autoHideTimer = setTimeout(() => {
                if (!isARMode && !isMobile()) hideUI();
            }, 8000);
        }

        function hideUI() {
            uiVisible = false;
            document.getElementById('info').classList.add('hidden');
            document.getElementById('controls').classList.add('hidden');
            document.getElementById('legend').classList.add('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.add('hidden'));
        }

        function showUI() {
            uiVisible = true;
            document.getElementById('info').classList.remove('hidden');
            document.getElementById('controls').classList.remove('hidden');
            document.getElementById('legend').classList.remove('hidden');
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('hidden'));
        }

        function resetAutoHide() {
            clearTimeout(autoHideTimer);
            if (!uiVisible) showUI();
            autoHideUI();
        }

        // Gyroscope Controls
        function initGyroscope() {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                // iOS 13+ requires permission
                DeviceOrientationEvent.requestPermission()
                    .then(response => {
                        if (response == 'granted') {
                            window.addEventListener('deviceorientation', handleOrientation);
                        }
                    })
                    .catch(console.error);
            } else if ('DeviceOrientationEvent' in window) {
                window.addEventListener('deviceorientation', handleOrientation);
            } else {
                console.log('Device Orientation not supported');
                document.getElementById('gyro-btn').style.display = 'none';
            }
        }

        // Enhanced gyroscope with smoothing
        let gyroSmoothing = { alpha: 0, beta: 0, gamma: 0 };
        const smoothingFactor = 0.1;

        function handleOrientation(event) {
            const rawAlpha = event.alpha || 0;
            const rawBeta = event.beta || 0;
            const rawGamma = event.gamma || 0;
            
            // Apply smoothing for fluid motion
            gyroSmoothing.alpha += (rawAlpha - gyroSmoothing.alpha) * smoothingFactor;
            gyroSmoothing.beta += (rawBeta - gyroSmoothing.beta) * smoothingFactor;
            gyroSmoothing.gamma += (rawGamma - gyroSmoothing.gamma) * smoothingFactor;
            
            deviceOrientation.alpha = gyroSmoothing.alpha;
            deviceOrientation.beta = gyroSmoothing.beta;
            deviceOrientation.gamma = gyroSmoothing.gamma;
        }

        function toggleGyroscope() {
            gyroControls = !gyroControls;
            const btn = document.getElementById('gyro-btn');
            const indicator = document.getElementById('gyro-indicator');
            
            if (gyroControls) {
                btn.textContent = '‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÑ‡∏à‡πÇ‡∏£';
                btn.classList.add('active');
                if(indicator) indicator.style.display = 'block';
                controls.enabled = false;
                document.getElementById('interaction-hint').textContent = '‡∏´‡∏°‡∏∏‡∏ô‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏∏‡∏ô‡πÇ‡∏°‡πÄ‡∏î‡∏• | ‡πÅ‡∏ï‡∏∞‡∏•‡∏π‡∏Å‡∏®‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏≥‡∏£‡∏ß‡∏à';
            } else {
                btn.textContent = '‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î‡πÑ‡∏à‡πÇ‡∏£';
                btn.classList.remove('active');
                if(indicator) indicator.style.display = 'none';
                controls.enabled = true;
                document.getElementById('interaction-hint').textContent = '‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ã‡πâ‡∏≤‡∏¢-‡∏Ç‡∏ß‡∏≤‡∏£‡∏¥‡∏°‡∏à‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç | ‡∏´‡∏°‡∏∏‡∏ô-‡∏ã‡∏π‡∏°‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏≥‡∏£‡∏ß‡∏à';
            }
            resetAutoHide();
        }
        window.toggleGyroscope = toggleGyroscope;

        // WebXR AR with Hit Test
        let xrSession = null;
        let xrHitTestSource = null;
        let xrHitTestSourceRequested = false;
        let xrReferenceSpace = null;

        async function checkARSupport() { 
            if ('xr' in navigator) { 
                try { 
                    const s = await navigator.xr.isSessionSupported('immersive-ar'); 
                    if(s) {
                        document.getElementById('ar-button').style.display='block';
                    }
                } catch(e){} 
            } 
        }

        async function enterAR() {
            if (!navigator.xr) {
                alert('‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö WebXR');
                return;
            }
            
            try {
                const session = await navigator.xr.requestSession('immersive-ar', { 
                    requiredFeatures: ['hit-test', 'dom-overlay'],
                    optionalFeatures: ['light-estimation'],
                    domOverlay: { root: document.body }
                });
                await enterXRSession(session);
            } catch (e) {
                console.error('AR Session failed:', e);
                alert('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏°‡∏î AR: ' + e.message);
            }
        }

        async function enterXRSession(session) {
            xrSession = session;
            renderer.xr.setSession(session); 
            isARMode = true;
            
            // Show mode indicator
            document.getElementById('mode-indicator').style.display = 'block';
            document.getElementById('mode-indicator').textContent = '‡πÇ‡∏´‡∏°‡∏î AR';
            
            // Update button
            document.getElementById('ar-button').textContent = '‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å AR';
            document.getElementById('ar-button').onclick = exitAR;
            
            // Hide UI elements
            ['info', 'legend', 'bottom-ui-container', 'controls', 'gyro-btn', 'gyro-indicator'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.style.display = 'none';
            });
            
            // Setup AR scene
            brainGroup.scale.set(0.2, 0.2, 0.2);
            brainGroup.position.set(0, 0, -1);
            
            // Request hit test source
            session.addEventListener('select', onSelect);
            session.addEventListener('end', exitAR);
            
            // Start AR rendering
            animateAR(session);
        }

        function onSelect(event) {
            if (!xrHitTestSource) return;
            
            const frame = event.frame;
            const referenceSpace = renderer.xr.getReferenceSpace();
            const pose = frame.getHitTestResults(xrHitTestSource)[0]?.getPose(referenceSpace);
            
            if (pose) {
                // Place/attach model to hit point
                brainGroup.position.set(pose.transform.position.x, pose.transform.position.y, pose.transform.position.z);
                brainGroup.quaternion.set(pose.transform.orientation.x, pose.transform.orientation.y, pose.transform.orientation.z, pose.transform.orientation.w);
            }
        }

        async function animateAR(session) {
            function onAnimationFrame(time, frame) {
                if (!isARMode) return;
                
                const referenceSpace = renderer.xr.getReferenceSpace();
                const pose = frame.getViewerPose(referenceSpace);
                
                if (pose) {
                    // Request hit test source if not done yet
                    if (!xrHitTestSourceRequested) {
                        session.requestReferenceSpace('viewer').then(referenceSpace => {
                            session.requestHitTestSource({ space: referenceSpace }).then(source => {
                                xrHitTestSource = source;
                            });
                        });
                        xrHitTestSourceRequested = true;
                    }
                }
                
                renderer.render(scene, camera);
                session.requestAnimationFrame(onAnimationFrame);
            }
            
            session.requestAnimationFrame(onAnimationFrame);
        }

        function exitAR() {
            if (xrSession) {
                xrSession.end();
                xrSession = null;
            }
            
            isARMode = false;
            xrHitTestSource = null;
            xrHitTestSourceRequested = false;
            
            brainGroup.scale.set(1, 1, 1);
            brainGroup.position.set(0, 0, 0);
            brainGroup.quaternion.set(0, 0, 0, 1);
            
            // Hide AR indicator
            document.getElementById('mode-indicator').style.display = 'none';
            
            // Show UI elements
            ['info', 'bottom-ui-container'].forEach(id => {
                const el = document.getElementById(id);
                if(el) el.style.display = 'block';
            });
            
            // Conditional UI elements
            document.getElementById('controls').style.display = 'block';
            document.getElementById('legend').style.display = isMobile() ? 'none' : 'block';
            document.getElementById('gyro-btn').style.display = 'block';
            
            document.getElementById('ar-button').textContent = '‡πÄ‡∏Ç‡πâ‡∏≤‡πÇ‡∏´‡∏°‡∏î AR';
            document.getElementById('ar-button').onclick = enterAR;
            
            adjustForMobile();
        }

        // Controls setup
        const controls = new OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.minDistance = 3;
        controls.maxDistance = 25;
        controls.maxPolarAngle = Math.PI;
        
        const clock = new THREE.Clock();

        // Global functions
        window.resetView = () => { 
            camera.position.set(-8, 2, isMobile() ? 15 : 8);
            controls.reset(); 
            currentMarkerIndex = -1;
            document.getElementById('info-panel').innerHTML = `
                <h2>‡∏™‡∏°‡∏≠‡∏á‡∏°‡∏ô‡∏∏‡∏©‡∏¢‡πå</h2>
                <p>‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏®‡∏£‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡∏≥‡∏£‡∏ß‡∏à‡∏™‡πà‡∏ß‡∏ô‡∏ï‡πà‡∏≤‡∏á‡πÜ ‡∏Ç‡∏≠‡∏á‡∏™‡∏°‡∏≠‡∏á</p>
                <p style="color: #888; font-size: 12px;">* ‡∏°‡∏µ‡∏à‡∏∏‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î 12 ‡∏à‡∏∏‡∏î</p>
            `;
            Object.values(markerElements).forEach(el => el.container.style.filter='brightness(1)');
            adjustForMobile();
            resetAutoHide(); 
        };
        
        window.toggleRotation = () => { 
            rotating = !rotating; 
            resetAutoHide(); 
        };
        
        window.toggleLabels = () => { 
            showLabels = !showLabels; 
            resetAutoHide(); 
        };

        window.enterAR = enterAR;

        // Event listeners
        ['click', 'touchstart', 'touchmove', 'mousemove'].forEach(e => {
            document.addEventListener(e, resetAutoHide);
        });

        // Window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            markerCanvas.width = window.innerWidth;
            markerCanvas.height = window.innerHeight;
            adjustForMobile();
        });

        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            const time = clock.getElapsedTime();

            // Automated rotation
            if (rotating && !isARMode && !gyroControls) {
                brainGroup.rotation.y = Math.sin(time * 0.5) * 0.15;
                brainGroup.rotation.x = Math.sin(time * 0.3) * 0.05;
            }

            // Gyroscope-based rotation with enhanced mapping
            if (gyroControls && !isARMode) {
                const beta = THREE.MathUtils.degToRad(deviceOrientation.beta);
                const gamma = THREE.MathUtils.degToRad(deviceOrientation.gamma);
                const alpha = THREE.MathUtils.degToRad(deviceOrientation.alpha);
                
                // Enhanced mapping for better user experience
                brainGroup.rotation.x = THREE.MathUtils.clamp(beta * 0.3, -Math.PI/3, Math.PI/3);
                brainGroup.rotation.y = -alpha * 0.3;
                brainGroup.rotation.z = THREE.MathUtils.clamp(gamma * 0.3, -Math.PI/4, Math.PI/4);
            }

            controls.update();
            renderer.render(scene, camera);
            
            if (!isARMode) {
                updateMarkers();
            }
        }

        // Initialize
        initGyroscope();
        checkARSupport();
        adjustForMobile();
        selectMarkerByIndex(0);
        animate();
    </script>
</body>
</html>